<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/head.css">
    <title>开袋子模拟器</title>
    <style>
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #3498db;
            --epic-color: #9b59b6;
            --rare-color: #2ecc71;
            --common-color: #95a5a6;
            --bg-color: #ffffff;
            --card-bg: #34495e;
            --text-color: #333333;
        }
		
		.control-panel, 
		.results-panel, 
		.result-table, 
		.modal-content {
			background: #f5f5f5 !important; 
		}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .draw-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-reset {
            background: #e67e22;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .results-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .result-table th, .result-table td {
            border: 1px solid #555;
            padding: 8px;
            text-align: center;
        }

        .result-table th {
            background: #555;
        }

        /* 响应式设计 */
        @media (max-width: 780px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .draw-buttons {
                flex-direction: column;
            }
            
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
		
		/* 让弹窗里的文字居中 */
		#epic-popup .modal-content {
		  max-width: 380px;
		}
		#epic-title {
		  color: var(--epic-color);
		  margin-bottom: 10px;
		}

        .cost-display {
            margin: 15px 0;
            padding: 10px;
            background: #2c3e50;
            border-radius: 5px;
            text-align: center;
            color: white;
        }

        .cost-item {
            margin: 5px 0;
        }
		
		.code-explanation {
		    margin: 40px auto;
		    max-width: 1200px;
		    background: #2c3e50;
		    border-radius: 10px;
		    overflow: hidden;
		    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
		}
		
		.explanation-header {
		    background: #34495e;
		    padding: 15px 20px;
		    cursor: pointer;
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		}
		
		.explanation-header h3 {
		    color: #ecf0f1;
		    margin: 0;
		    font-size: 1.3rem;
		}
		
		.toggle-icon {
		    color: #ecf0f1;
		    font-size: 1.5rem;
		    transition: transform 0.3s ease;
		}
		
		.explanation-content {
		    padding: 0;
		    max-height: 0;
		    overflow: hidden;
		    transition: max-height 0.5s ease, padding 0.3s ease;
		}
		
		.explanation-content.expanded {
		    padding: 20px;
		    max-height: none;
		    overflow: visible;
		}
		
		.code-section {
		    margin-bottom: 25px;
		    background: #1e272e;
		    border-radius: 8px;
		    overflow: hidden;
		}
		
		.code-title {
		    background: #34495e;
		    padding: 10px 15px;
		    color: #ecf0f1;
		    font-weight: bold;
		    border-left: 4px solid #3498db;
		}
		
		.code-desc {
		    padding: 15px;
		    color: #bdc3c7;
		    line-height: 1.6;
		    font-size: 0.95rem;
		}
		
		.code-block {
		    background: #1a1a1a;
		    border-left: 4px solid #e74c3c;
		    padding: 15px;
		    margin: 10px 0;
		    overflow-x: auto;
		    font-family: 'Consolas', 'Courier New', monospace;
		    font-size: 0.9rem;
		    line-height: 1.4;
		    color: #f8f9fa;
		    max-height: none;
		    overflow: visible;
		    white-space: pre-wrap;
		}
		
		/* 语法高亮样式 */
		.code-keyword {
		    color: #e74c3c; /* 红色 - 关键字 */
		    font-weight: bold;
		}
		
		.code-comment {
		    color: #6c757d; /* 灰色 - 注释 */
		    font-style: italic;
		}
		
		.code-string {
		    color: #2ecc71; /* 绿色 - 字符串 */
		}
		
		.code-number {
		    color: #3498db; /* 蓝色 - 数字 */
		}
		
		.code-function {
		    color: #9b59b6; /* 紫色 - 函数名 */
		}
		
		.code-variable {
		    color: #f39c12; /* 橙色 - 变量名 */
		}
		
		.code-property {
		    color: #1abc9c; /* 青绿色 - 属性名 */
		}
		
		/* 响应式设计 */
		@media (max-width: 768px) {
		    .code-explanation {
		        margin: 20px 10px;
		    }
		    
		    .explanation-header {
		        padding: 12px 15px;
		    }
		    
		    .explanation-header h3 {
		        font-size: 1.1rem;
		    }
		    
		    .explanation-content.expanded {
		        padding: 15px;
		    }
		    
		    .code-block {
		        padding: 10px;
		        font-size: 0.85rem;
		    }
		}
    </style>
</head>
<body>
	<section class="hero-section">
		<h1 class="hero-title">开袋子模拟器</h1>
		<div class="nav-buttons">
			<button class="nav-button"><a href="index.html">返回新版主页</a></button>
			<button class="nav-button"><a href="indexjd.html">返回经典版主页</a></button>
		</div>
		 <h3 class="hero-title">请尽量使用Windows系统以获得最优的体验效果</h3>
		 <h3 class="hero-title">该页面可以脱离head.css独立运行</h3>
		 <h3 class="hero-title">为了规避一些风险，本页面为github独占</h3>
	</section>
    <div class="container">
		<div style="
		    margin: 0 auto 20px;
		    padding: 15px 20px;
		    background: #d60000;
		    border-left: 8px solid #ffd700;
		    border-radius: 6px;
		    box-shadow: 0 0 12px rgba(255,0,0,.6);
		    font-size: 1.15rem;
		    font-weight: bold;
		    color: #ffd700;
		    text-align: center;
		    letter-spacing: 1px;
		    line-height: 1.6;
		">
		    ⚠️ 免责声明 ⚠️<br>
		    本页面仅供学习交流与技术演示使用，所有概率、数据及抽奖结果均为模拟生成，
		    与任何游戏官方实际活动、爆率或结果无关，请勿据此进行任何投资或消费决策！
		</div>

        <div class="main-content">
            <div class="control-panel">
                <div class="cost-display">
                    <div class="cost-item">你已抽取：<span id="total-draws">0</span> 次</div>
                    <div class="cost-item">花费：<span id="silver-cost">0</span> 银币</div>
                    <div class="cost-item">碎了：<span id="pearl-cost">0.00</span> 颗史诗宝珠</div>
                </div>

                <div class="draw-buttons">
                    <button class="btn btn-primary" id="draw-1">抽1次</button>
                    <button class="btn btn-primary" id="draw-10">抽10次</button>
                    <button class="btn btn-primary" id="draw-50">抽50次</button>	
                </div>
				
				<p>回车键和空格键可以快捷50抽，可长按</p>

                <!-- 史诗弹窗开关 -->
                <div class="popup-toggle" style="margin-top:10px;">
                  <label>
                    <input type="checkbox" id="popup-switch" checked> 抽到当期史诗武将时弹窗
                  </label>
                </div>

                <button class="btn btn-reset" id="reset-btn">重置统计</button>
				
				<!-- 概率公示表 -->
				<div class="rate-table" style="margin-top:20px;">
				  <h3>概率公示（数据源自三国杀官方公布数据）</h3>
				  <table class="result-table">
				    <thead>
				      <tr>
				        <th>道具名</th>
				        <th>权重</th>
				        <th>单抽概率</th>
				      </tr>
				    </thead>
				    <tbody id="rate-table-body">
				      <!-- JS 动态填充 -->
				    </tbody>
				  </table>
				</div>
            </div>
			
			<!-- 史诗弹窗 -->
			<div class="modal" id="epic-popup">
			  <div class="modal-content">
			    <h2 id="epic-title">恭喜获得！</h2>
			    <p id="epic-content"></p>
			    <div class="modal-buttons">
			      <button class="btn btn-primary" id="epic-ok">确定</button>
			    </div>
			  </div>
			</div>

            <div class="results-panel">
                <h3>抽奖结果统计</h3>
                <div class="results-grid">
                    <div>
                        <h4>用户本次抽取</h4>
                        <table class="result-table" id="user-single-table">
                            <!-- 动态生成 -->
                        </table>
                    </div>
                    <div>
                        <h4>用户累计抽取</h4>
                        <table class="result-table" id="user-total-table">
                            <!-- 动态生成 -->
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
	
	<style id="mobile-bot-btn-style">
	@media (min-width: 781px) {
	  #mobile-bot-bar { display: none !important; }
	}
	#mobile-bot-bar {
	  position: fixed;
	  left: 0;
	  right: 0;
	  bottom: 0;
	  height: 56px;
	  background: rgba(30,30,30,.95);
	  display: flex;
	  z-index: 999;
	  border-top: 1px solid #444;
	}
	#mobile-bot-bar button {
	  flex: 1;
	  border: none;
	  font-size: 16px;
	  font-weight: bold;
	  color: #fff;
	  cursor: pointer;
	  transition: opacity .2s;
	}
	#mobile-bot-bar button:active { opacity: .7; }
	#btn-mob-50   { background: var(--primary-color); }
	#btn-mob-auto {
	  background: var(--secondary-color);
	}
	#btn-mob-auto.active {
	  background: #e67e22;
	}
	</style>
	
	<div id="mobile-bot-bar">
	  <button id="btn-mob-50">50 抽</button>
	  <button id="btn-mob-auto">连续 50 抽</button>
	</div>

	
	<div class="code-explanation">
	    <div class="explanation-header" id="toggle-explanation">
	        <h3>开袋子模拟器代码说明</h3>
	        <span class="toggle-icon">▼</span>
	    </div>
	    <div class="explanation-content" id="explanation-content">
	        <div class="code-section">
	            <div class="code-title">奖池数据结构 (allItems)</div>
	            <div class="code-desc">
	                定义了所有可抽取物品的配置，包含名称、权重和分类信息。
	                权重决定了物品的抽取概率，分类用于区分普通、稀有和传说物品。
	            </div>
	            <div class="code-block">
	<span class="code-keyword">const</span> <span class="code-variable">allItems</span> = [
	    <span class="code-comment">// 普通物品：权重较高，出现概率大</span>
	    { <span class="code-property">name</span>: <span class="code-string">"菜篮子*2"</span>, <span class="code-property">weight</span>: <span class="code-number">1525</span>, <span class="code-property">category</span>: <span class="code-string">"普通"</span> },
	    { <span class="code-property">name</span>: <span class="code-string">"欢乐豆*10"</span>, <span class="code-property">weight</span>: <span class="code-number">1000</span>, <span class="code-property">category</span>: <span class="code-string">"普通"</span> },
	    { <span class="code-property">name</span>: <span class="code-string">"史诗体验卡*1"</span>, <span class="code-property">weight</span>: <span class="code-number">1000</span>, <span class="code-property">category</span>: <span class="code-string">"普通"</span> },
	    { <span class="code-property">name</span>: <span class="code-string">"手气卡*1"</span>, <span class="code-property">weight</span>: <span class="code-number">3000</span>, <span class="code-property">category</span>: <span class="code-string">"普通"</span> },
	    { <span class="code-property">name</span>: <span class="code-string">"换将卡*1"</span>, <span class="code-property">weight</span>: <span class="code-number">3000</span>, <span class="code-property">category</span>: <span class="code-string">"普通"</span> },
	    { <span class="code-property">name</span>: <span class="code-string">"进阶丹*1"</span>, <span class="code-property">weight</span>: <span class="code-number">300</span>, <span class="code-property">category</span>: <span class="code-string">"普通"</span> },
	    { <span class="code-property">name</span>: <span class="code-string">"雁翎甲*1"</span>, <span class="code-property">weight</span>: <span class="code-number">100</span>, <span class="code-property">category</span>: <span class="code-string">"普通"</span> },
	    
	    <span class="code-comment">// 稀有物品：权重较低，出现概率小</span>
	    { <span class="code-property">name</span>: <span class="code-string">"雁翎*1000"</span>, <span class="code-property">weight</span>: <span class="code-number">50</span>, <span class="code-property">category</span>: <span class="code-string">"稀有"</span> },
	    { <span class="code-property">name</span>: <span class="code-string">"当期精品武将*1"</span>, <span class="code-property">weight</span>: <span class="code-number">20</span>, <span class="code-property">category</span>: <span class="code-string">"稀有"</span> },
	    
	    <span class="code-comment">// 史诗物品：权重极低，稀有度高</span>
	    { <span class="code-property">name</span>: <span class="code-string">"当期传说皮肤动态包*1"</span>, <span class="code-property">weight</span>: <span class="code-number">4</span>, <span class="code-property">category</span>: <span class="code-string">"史诗"</span> },
	    
	    <span class="code-comment">// 传说物品：权重最低，最稀有</span>
	    { <span class="code-property">name</span>: <span class="code-string">"当期史诗武将*1"</span>, <span class="code-property">weight</span>: <span class="code-number">1</span>, <span class="code-property">category</span>: <span class="code-string">"传说"</span> }
	];
	            </div>
	        </div>
	        
	        <div class="code-section">
	            <div class="code-title">单次抽奖逻辑 (singleDraw)</div>
	            <div class="code-desc">
	                这是抽奖系统的核心函数，基于权重随机算法选择奖励物品。
	            </div>
	            <div class="code-block">
	<span class="code-comment">/**
	 * 执行单次抽奖操作的核心函数
	 * 基于权重随机算法选择奖励物品
	 * @returns {string} 抽中的物品名称
	 */</span>
	<span class="code-keyword">function</span> <span class="code-function">singleDraw</span>() {
	    <span class="code-comment">// 计算所有物品的总权重</span>
	    <span class="code-keyword">const</span> totalWeight = allItems.<span class="code-function">reduce</span>((sum, item) => sum + item.weight, <span class="code-number">0</span>);
	    
	    <span class="code-comment">// 生成随机数决定抽奖结果（基于总权重的随机分布）</span>
	    <span class="code-keyword">const</span> random = Math.<span class="code-function">random</span>() * totalWeight;
	    
	    <span class="code-comment">// 遍历权重表，确定最终抽中的物品</span>
	    <span class="code-keyword">let</span> currentWeight = <span class="code-number">0</span>;
	    <span class="code-keyword">let</span> selectedItem = <span class="code-keyword">null</span>;
	    
	    <span class="code-keyword">for</span> (<span class="code-keyword">const</span> item <span class="code-keyword">of</span> allItems) {
	        currentWeight += item.weight;
	        <span class="code-comment">// 当随机数落在当前物品的权重区间内时，选中该物品</span>
	        <span class="code-keyword">if</span> (random <= currentWeight) {
	            selectedItem = item;
	            <span class="code-keyword">break</span>;
	        }
	    }
	    
	    <span class="code-comment">// 返回抽中的物品名称</span>
	    <span class="code-keyword">return</span> selectedItem.name;
	}
	            </div>
	        </div>
	        
	        <div class="code-section">
	            <div class="code-title">批量抽奖逻辑 (batchDraw)</div>
	            <div class="code-desc">
	                处理批量抽奖操作，更新统计信息和花费计算。
	            </div>
	            <div class="code-block">
	<span class="code-comment">/**
	 * 批量抽奖函数 - 处理多次抽奖操作
	 * @param {number} count - 抽奖次数
	 * @returns {Object} 抽奖结果统计对象
	 */</span>
	<span class="code-keyword">function</span> <span class="code-function">batchDraw</span>(count) {
	    <span class="code-comment">// 初始化结果对象</span>
	    <span class="code-keyword">const</span> results = {};
	    
	    <span class="code-comment">// 执行指定次数的抽奖</span>
	    <span class="code-keyword">for</span> (<span class="code-keyword">let</span> i = <span class="code-number">0</span>; i < count; i++) {
	        <span class="code-comment">// 执行单次抽奖</span>
	        <span class="code-keyword">const</span> itemName = <span class="code-function">singleDraw</span>();
	        
	        <span class="code-comment">// 更新结果统计</span>
	        results[itemName] = (results[itemName] || <span class="code-number">0</span>) + <span class="code-number">1</span>;
	        
	        <span class="code-comment">// 更新用户统计信息</span>
	        state.userSingleStats[itemName] = (state.userSingleStats[itemName] || <span class="code-number">0</span>) + <span class="code-number">1</span>;
	        state.userTotalStats[itemName] = (state.userTotalStats[itemName] || <span class="code-number">0</span>) + <span class="code-number">1</span>;
	    }
	    
	    <span class="code-comment">// 更新花费统计</span>
	    state.totalDraws += count;
	    state.silverCost += count * <span class="code-number">100</span>; <span class="code-comment">// 每次抽奖消耗100银币</span>
	    state.pearlCost += count * <span class="code-number">0.01</span>; <span class="code-comment">// 每次抽奖消耗0.01颗史诗宝珠</span>
	    
	    <span class="code-comment">// 更新UI显示</span>
	    <span class="code-function">updateCostDisplay</span>();
	    <span class="code-function">updateAllStatsTables</span>();
	    
	    <span class="code-comment">// 返回抽奖结果</span>
	    <span class="code-keyword">return</span> results;
	}
	            </div>
	        </div>
	        
	        <div class="code-section">
	            <div class="code-title">用户抽奖函数 (userDrawOnce)</div>
	            <div class="code-desc">
	                处理用户抽奖操作，包括统计重置和史诗物品检测。
	            </div>
	            <div class="code-block">
	<span class="code-comment">/**
	 * 用户抽奖函数 - 处理用户抽奖操作及相关逻辑
	 * @param {number} count - 抽奖次数
	 */</span>
	<span class="code-keyword">function</span> <span class="code-function">userDrawOnce</span>(count) {
	    <span class="code-comment">// 重置用户单次统计，准备记录本次抽奖结果</span>
	    state.userSingleStats = <span class="code-function">initializeStats</span>();
	    
	    <span class="code-comment">// 执行批量抽奖</span>
	    <span class="code-keyword">const</span> results = <span class="code-function">batchDraw</span>(count);
	    
	    <span class="code-comment">// 检查是否抽到当期史诗武将并触发弹窗</span>
	    <span class="code-keyword">if</span> (results[<span class="code-string">"当期史诗武将*1"</span>] && state.epicPopup) {
	        <span class="code-function">showEpicPopup</span>(<span class="code-string">"当期史诗武将*1"</span>);
	    }
	}
	            </div>
	        </div>
	        
	        <div class="code-section">
	            <div class="code-title">史诗弹窗函数 (showEpicPopup)</div>
	            <div class="code-desc">
	                显示抽到史诗物品的恭喜弹窗。
	            </div>
	            <div class="code-block">
	<span class="code-comment">/**
	 * 史诗弹窗函数 - 显示抽到史诗物品的恭喜弹窗
	 * @param {string} itemName - 抽中的物品名称
	 */</span>
	<span class="code-keyword">function</span> <span class="code-function">showEpicPopup</span>(itemName) {
	    <span class="code-comment">// 获取弹窗UI元素</span>
	    <span class="code-keyword">const</span> titleEl = document.<span class="code-function">getElementById</span>(<span class="code-string">'epic-title'</span>);
	    <span class="code-keyword">const</span> contEl = document.<span class="code-function">getElementById</span>(<span class="code-string">'epic-content'</span>);
	    
	    <span class="code-comment">// 设置弹窗内容</span>
	    titleEl.textContent = <span class="code-string">'恭喜获得！'</span>;
	    contEl.textContent = <span class="code-string">`你获得了：${itemName}！`</span>;
	    
	    <span class="code-comment">// 显示弹窗</span>
	    document.<span class="code-function">getElementById</span>(<span class="code-string">'epic-popup'</span>).style.display = <span class="code-string">'flex'</span>;
	}
	            </div>
	        </div>
	        
	        <div class="code-section">
	            <div class="code-title">核心设计特点</div>
	            <div class="code-desc">
	                <strong>权重系统</strong>：基于权重的随机算法，确保高权重物品出现概率更高。<br>
	                <strong>分类系统</strong>：物品分为普通、稀有和传说三个等级，提供清晰的稀有度区分。<br>
	                <strong>成本计算</strong>：每次抽奖消耗固定数量的银币和史诗宝珠。<br>
	                <strong>弹窗提示</strong>：抽到传说物品时显示恭喜弹窗，增强用户体验。<br><br>
	                
	                这套系统通过简单的权重算法和清晰的物品分类，为用户提供了直观的抽奖体验。
	            </div>
	        </div>
	    </div>
	</div>

    <footer class="site-footer">
    	<div class="author-info">
    		<p>
    			作者： <a href="https://space.bilibili.com/87412647?spm_id_from=333.1007.0.0"
    				target="_blank">bilibili月が綺麗ですね_</a><br />
    			联系方式：<a href="mailto:3099637681@qq.com" target="_blank">3099637681@qq.com（QQ同号）</a><br />
    			有什么新功能或建议欢迎骚扰（著名来意）<br />
    			<a href="https://1145141919810tonny.github.io/sgsmoniqi/" target="_blank">点击此处使用GitHub Pages在线服务</a>
    		</p>
    	</div>
    	<div class="code-update">
    		<a href="https://www.bilibili.com/read/readlist/rl929858?spm_id_from=333.1387.0.0" target="_blank"
    			class="bili-btn" rel="noopener noreferrer">
    			[bilibili]获取更新动态
    		</a>
    		<a href="https://github.com/1145141919810TONNY/sgsmoniqi/" target="_blank" class="github-btn"
    			rel="noopener noreferrer">
    			[GitHub]获取后续代码更新
    		</a>
    		<a href="https://gitcode.com/TONNY114514/sgsmnq?source_module=search_project" target="_blank"
    			class="gitcode-btn" rel="noopener noreferrer">
    			[GitCode]获取V7.8.3.62镜像文件
    		</a>
    	</div>
    	<div class="license-notice">
    		<p>
    			Copyright &copy; <span id="copyright-year">2025</span> bilibili 月が綺麗ですね_<br />
    			Released under the
    			<a href="MIT LICENSE.html" title="查看MIT许可证" class="license-link" target="_blank">
    				MIT License
    			</a>
    		</p>
    		<p class="i18n-annotation">
    			(法律条款以英文版<a href="MIT LICENSE.html" target="_blank">LICENSE</a>文件为准)
    		</p>
    	</div>
    </footer>

    <script>
        // 奖池数据
        const allItems = [
            { name: "菜篮子*2", weight: 1525, category: "普通" },
            { name: "欢乐豆*10", weight: 1000, category: "普通" },
            { name: "史诗体验卡*1", weight: 1000, category: "普通" },
            { name: "手气卡*1", weight: 3000, category: "普通" },
            { name: "换将卡*1", weight: 3000, category: "普通" },
            { name: "进阶丹*1", weight: 300, category: "普通" },
            { name: "雁翎甲*1", weight: 100, category: "普通" },
            { name: "雁翎*1000", weight: 50, category: "稀有" },
            { name: "当期精品武将*1", weight: 20, category: "稀有" },
            { name: "当期传说皮肤动态包*1", weight: 4, category: "史诗" },
            { name: "当期史诗武将*1", weight: 1, category: "传说" }
        ];

        // 状态管理
        let state = {
            // 统计信息
            userSingleStats: {},
            userTotalStats: {},
            
            // 用户累计
            totalDraws: 0,
            silverCost: 0,
            pearlCost: 0,
            
            // 弹窗设置
            epicPopup: true
        };

        // 初始化统计对象
        function initializeStats() {
            const stats = {};
            allItems.forEach(item => {
                stats[item.name] = 0;
            });
            return {...stats};
        }

        // 初始化页面
        function initializePage() {
            state.userSingleStats = initializeStats();
            state.userTotalStats = initializeStats();
            state.totalDraws = 0;
            state.silverCost = 0;
            state.pearlCost = 0;
            
            updateCostDisplay();
            updateAllStatsTables();
        }
		
		// 更新花费显示
		function updateCostDisplay() {
            document.getElementById('total-draws').textContent = state.totalDraws;
            document.getElementById('silver-cost').textContent = state.silverCost;
            document.getElementById('pearl-cost').textContent = state.pearlCost.toFixed(2);
        }

        // 更新所有统计表格
        function updateAllStatsTables() {
            updateStatsTable('user-single-table', state.userSingleStats);
            updateStatsTable('user-total-table', state.userTotalStats);
        }

        // 更新单个统计表格
        function updateStatsTable(tableId, stats) {
            const table = document.getElementById(tableId);
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>道具名称</th>
                        <th>数量</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(stats).map(([name, count]) => `
                        <tr>
                            <td>${name}</td>
                            <td>${count}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        // 单次抽奖逻辑
        function singleDraw() {
            const totalWeight = allItems.reduce((sum, item) => sum + item.weight, 0);
            const random = Math.random() * totalWeight;
            
            let currentWeight = 0;
            let selectedItem = null;
            
            for (const item of allItems) {
                currentWeight += item.weight;
                if (random <= currentWeight) {
                    selectedItem = item;
                    break;
                }
            }
            
            return selectedItem.name;
        }

        // 批量抽奖
        function batchDraw(count) {
            const results = {};
            
            for (let i = 0; i < count; i++) {
                const itemName = singleDraw();
                results[itemName] = (results[itemName] || 0) + 1;
                
                // 更新统计
                state.userSingleStats[itemName] = (state.userSingleStats[itemName] || 0) + 1;
                state.userTotalStats[itemName] = (state.userTotalStats[itemName] || 0) + 1;
            }
            
            // 更新花费
            state.totalDraws += count;
            state.silverCost += count * 100;
            state.pearlCost += count * 0.01;
            
            updateCostDisplay();
            updateAllStatsTables();
            
            return results;
        }
		
		function userDrawOnce(count) {
		  state.userSingleStats = initializeStats();
		
		  const results = batchDraw(count);
		  
		  // 检查是否抽到当期史诗武将
		  if (results["当期史诗武将*1"] && state.epicPopup) {
		    showEpicPopup("当期史诗武将*1");
		  }
		}

		function showEpicPopup(itemName) {
		  const titleEl = document.getElementById('epic-title');
		  const contEl  = document.getElementById('epic-content');
		
		  titleEl.textContent = '恭喜获得！';
		  contEl.textContent  = `你获得了：${itemName}！`;
		
		  document.getElementById('epic-popup').style.display = 'flex';
		}
		
		/* ========== 概率公示数据 ========== */
		const rateData = [
		  {name:'菜篮子*2', weight:1525, prob:'15.25%'},
		  {name:'欢乐豆*10', weight:1000, prob:'10.00%'},
		  {name:'史诗体验卡*1', weight:1000, prob:'10.00%'},
		  {name:'手气卡*1', weight:3000, prob:'30.00%'},
		  {name:'换将卡*1', weight:3000, prob:'30.00%'},
		  {name:'进阶丹*1', weight:300, prob:'3.00%'},
		  {name:'雁翎甲*1', weight:100, prob:'1.00%'},
		  {name:'雁翎*1000', weight:50, prob:'0.50%'},
		  {name:'当期精品武将*1', weight:20, prob:'0.20%'},
		  {name:'当期传说皮肤动态包*1', weight:4, prob:'0.04%'},
		  {name:'当期史诗武将*1', weight:1, prob:'0.01%'}
		];
		
		/* ========== 渲染概率表 ========== */
		function renderRateTable() {
		  const tbody = document.getElementById('rate-table-body');
		  tbody.innerHTML = '';
		  rateData.forEach(r => {
		    const tr = document.createElement('tr');
		    tr.innerHTML = `
		      <td>${r.name}</td>
		      <td>${r.weight}</td>
		      <td>${r.prob}</td>
		    `;
		    tbody.appendChild(tr);
		  });
		}
		
		document.addEventListener('DOMContentLoaded', function() {
		    const toggleBtn = document.getElementById('toggle-explanation');
		    const content = document.getElementById('explanation-content');
		    const toggleIcon = toggleBtn.querySelector('.toggle-icon');
		    
		    toggleBtn.addEventListener('click', function() {
		        content.classList.toggle('expanded');
		        toggleIcon.textContent = content.classList.contains('expanded') ? '▲' : '▼';
		    });
		});
		
		(() => {
		  const btn50   = document.getElementById('btn-mob-50');
		  const btnAuto = document.getElementById('btn-mob-auto');
		
		  let running = false;
		  let timer   = null;
		
		  btn50.addEventListener('click', () => userDrawOnce(50));
		
		  btnAuto.addEventListener('click', () => {
		    running = !running;
		    btnAuto.classList.toggle('active', running);
		    btnAuto.textContent = running ? '停止连抽' : '连续 50 抽';
		
		    if (running) {
		      timer = setInterval(() => userDrawOnce(50), 100); // 每秒10次
		    } else {
		      clearInterval(timer);
		    }
		  });
		
		  window.addEventListener('beforeunload', () => clearInterval(timer));
		})();
		
		/* ========== 初始化时调用 ========== */
		document.addEventListener('DOMContentLoaded', function() {
            renderRateTable();
            initializePage();
        });
		
		document.addEventListener('keydown', e => {
		  if (e.code === 'Enter' || e.code === 'Space') {
		    e.preventDefault();
		    userDrawOnce(50);
		  }
		});
		
		// 弹窗确定按钮
		document.getElementById('epic-ok').onclick = () => {
		  document.getElementById('epic-popup').style.display = 'none';
		};

        // 事件监听
        document.getElementById('draw-1').addEventListener('click',  () => userDrawOnce(1));
        document.getElementById('draw-10').addEventListener('click', () => userDrawOnce(10));
        document.getElementById('draw-50').addEventListener('click', () => userDrawOnce(50));
        
        document.getElementById('reset-btn').addEventListener('click', initializePage);
        
		document.getElementById('popup-switch').addEventListener('change', e => {
		  state.epicPopup = e.target.checked;
		});
    </script>
</body>
</html>
