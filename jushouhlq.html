<!DOCTYPE html>
<!-- æ–‡æ¡£ç±»å‹å£°æ˜ï¼šæŒ‡å®šä¸ºHTML5æ–‡æ¡£ -->
<html lang="en">
	<!-- HTMLæ–‡æ¡£æ ¹å…ƒç´ ï¼Œlangå±æ€§æŒ‡å®šæ–‡æ¡£è¯­è¨€ä¸ºè‹±è¯­ -->
	<head>
		<!-- æ–‡æ¡£å¤´éƒ¨ï¼šåŒ…å«å…ƒæ•°æ®ã€è„šæœ¬å’Œæ ·å¼è¡¨ -->
		<meta charset="UTF-8">
		<!-- å­—ç¬¦ç¼–ç å£°æ˜ï¼šæŒ‡å®šæ–‡æ¡£ä½¿ç”¨UTF-8ç¼–ç ï¼Œæ”¯æŒå¤šè¯­è¨€å­—ç¬¦ -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- è§†å£è®¾ç½®ï¼šç¡®ä¿é¡µé¢åœ¨ä¸åŒè®¾å¤‡ä¸Šæ­£ç¡®ç¼©æ”¾å’Œæ˜¾ç¤º -->
		<script src="js/cardhlq.js"></script>
		<!-- å¼•å…¥æœ¬åœ°JavaScriptæ–‡ä»¶ï¼šåŒ…å«å¡ç‰Œç›¸å…³é€»è¾‘ -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
		<!-- å¼•å…¥CryptoJSåº“ï¼šæä¾›åŠ å¯†åŠŸèƒ½ï¼ˆMD5/AESï¼‰ -->
		<title>æ²®çˆ¹çº¢åˆ©æœŸæ¨¡æ‹Ÿå™¨</title>
		<!-- é¡µé¢æ ‡é¢˜ï¼šæ˜¾ç¤ºåœ¨æµè§ˆå™¨æ ‡ç­¾é¡µä¸Š -->
		<link rel="stylesheet" href="css/head.css">
		<!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ï¼šå®šä¹‰é¡µé¢æ ·å¼ -->
	</head>
	<body>
		<!-- é¡µé¢ä¸»ä½“å†…å®¹ -->
		<div class="header">
			<!-- é¡¶éƒ¨æ“ä½œæ å®¹å™¨ -->
			<p>æ“ä½œå°</p>
			<!-- æ“ä½œå°æ ‡é¢˜ -->
			<button id="reloadButton" style="margin-left: 15px; background-color: #ff4444; color: white;">
				å¼ºåˆ¶åˆ·æ–°ï¼ˆQï¼‰
				<!-- å¼ºåˆ¶åˆ·æ–°æŒ‰é’®ï¼ˆå¿«æ·é”®Qï¼‰ -->
			</button>
			<button id="draw1Button">å‘1å¼ ç‰Œï¼ˆ1ï¼‰</button>
			<!-- å‘1å¼ ç‰ŒæŒ‰é’®ï¼ˆå¿«æ·é”®1ï¼‰ -->
			<button id="draw2Button">å‘2å¼ ç‰Œï¼ˆ2ï¼‰</button>
			<!-- å‘2å¼ ç‰ŒæŒ‰é’®ï¼ˆå¿«æ·é”®2ï¼‰ -->
			<button id="draw3Button">å‘3å¼ ç‰Œï¼ˆ3ï¼‰</button>
			<!-- å‘3å¼ ç‰ŒæŒ‰é’®ï¼ˆå¿«æ·é”®3ï¼‰ -->
			<button id="draw4Button">å‘4å¼ ç‰Œï¼ˆ4ï¼‰</button>
			<!-- å‘4å¼ ç‰ŒæŒ‰é’®ï¼ˆå¿«æ·é”®4ï¼‰ -->
			<button id="revealButton">æŸ¥çœ‹å‰©ä½™ç‰Œå †ï¼ˆWï¼‰</button>
			<!-- æŸ¥çœ‹ç‰Œå †æŒ‰é’®ï¼ˆå¿«æ·é”®Wï¼‰ -->
			<button id="highlightButton">é«˜äº®è¯¸è‘›è¿å¼©ï¼ˆEï¼‰</button>
			<!-- é«˜äº®æ­¦å™¨æŒ‰é’®ï¼ˆå¿«æ·é”®Eï¼‰ -->
			<button id="shuffleButton">é‡æ–°æ´—ç‰Œï¼ˆRï¼‰</button>
			<!-- æ´—ç‰ŒæŒ‰é’®ï¼ˆå¿«æ·é”®Rï¼‰ -->
			<button id="drawBtn">è¿›å…¥æ‘¸ç‰Œé˜¶æ®µï¼ˆAï¼‰</button>
			<!-- æ‘¸ç‰Œé˜¶æ®µæŒ‰é’®ï¼ˆå¿«æ·é”®Aï¼‰ -->
			<button id="playBtn" disabled>è¿›å…¥å‡ºç‰Œé˜¶æ®µï¼ˆSï¼‰</button>
			<!-- å‡ºç‰Œé˜¶æ®µæŒ‰é’®ï¼ˆåˆå§‹ç¦ç”¨ï¼Œå¿«æ·é”®Sï¼‰ -->
			<button id="endPlayBtn" disabled>ç»“æŸå‡ºç‰Œé˜¶æ®µï¼ˆDï¼‰</button>
			<!-- ç»“æŸå‡ºç‰ŒæŒ‰é’®ï¼ˆåˆå§‹ç¦ç”¨ï¼Œå¿«æ·é”®Dï¼‰ -->
			<button id="testCardBtn">æµ‹è¯•åŠŸèƒ½ï¼šæ·»åŠ æŒ‡å®šç‰Œ</button>
			<!-- æµ‹è¯•åŠŸèƒ½æŒ‰é’® -->
		</div>
		<div class="header-placeholder"></div>
		<!-- å ä½å…ƒç´ ï¼šç¡®ä¿å†…å®¹ä¸è¢«é¡¶éƒ¨æ“ä½œæ é®æŒ¡ -->
		<section class="hero-section">
			<h1 class="hero-title">æ²®çˆ¹çº¢åˆ©æœŸæ¨¡æ‹Ÿå™¨çº¢åˆ©æœŸç‰ˆ</h1>
			<!-- ä¸»æ ‡é¢˜ï¼šæ˜¾ç¤ºåº”ç”¨åç§°å’Œç‰ˆæœ¬ -->
			<div class="tooltip-container">
				<!-- å¯¼èˆªæŒ‰é’®å®¹å™¨ -->
				<div class="nav-buttons">
					<button class="nav-button"><a href="index.html">è¿”å›æ–°ç‰ˆä¸»é¡µ</a></button>
					<button class="nav-button"><a href="indexjd.html">è¿”å›ç»å…¸ç‰ˆä¸»é¡µ</a></button>
				</div>
			</div>

			<button id="backToTopBtn">å›åˆ°é¡¶éƒ¨</button>
			<h3 class="hero-title">
				<!-- ä½¿ç”¨è¯´æ˜ -->
				è¯´æ˜ï¼šæœ¬ä»£ç çš„ç‰Œå †æ˜¯çº¢åˆ©æœŸç®—æ³•<br />
				è¯·å…ˆæŸ¥çœ‹å‰©ä½™ç‰Œå †ï¼Œå†ç‚¹é«˜äº®akã€‚<br />
				å°†é€šè¿‡ä»£ç å±‚é¢å®ç°ç‰Œå †æ´—ç‰Œçš„çº¢åˆ©æœŸæ•ˆæœï¼Œä»¥ä¸éšæœºç‰ˆå¯¹æ¯”<br />
				ç”±äºçº¢åˆ©æœŸç‰ˆä¸éœ€è¦éšæœºæ´—ç‰Œæµ‹è¯•åŠŸèƒ½ï¼Œåˆ é™¤å¯¹åº”ä»£ç <br />
				åŒä¸Šï¼Œåˆ é™¤è„šæ°”å¡çš„ä½¿ç”¨ï¼Œè¯·ç›´æ¥ç‚¹å‡»é‡æ–°æ´—ç‰Œä»¥ä»£æ›¿å…¶æ•ˆæœ<br />
				åˆ·æ–°æŒ‰é’®å¯åœ¨ç½‘é¡µæœ‰ä¸å¯é€†çš„bugæ—¶å°†ç½‘é¡µæ¢å¤åˆ°åˆå§‹çŠ¶æ€
			</h3>
		</section>
		<h2>å®‰å…¨æ ¡éªŒåŒºMD5/AESç¼–ç 
			<button id="toggleMD5AES" style="font-size: 12px; padding: 2px 5px;">â–¼ æ”¶èµ·</button>
			<!-- å®‰å…¨åŒºåŸŸæ ‡é¢˜å’ŒæŠ˜å æŒ‰é’® -->
		</h2>
		<div id="md5aes-container">
			<!-- åŠ å¯†ä¿¡æ¯å®¹å™¨ -->
			<div class="md5-panel">
				<!-- MD5é¢æ¿ -->
				<div class="md5-display">
					<div id="md5Value">â€‹**â€‹*â€‹**â€‹*</div>
					<!-- MD5å€¼æ˜¾ç¤ºåŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
					<div class="md5-buttons">
						<button id="toggleMD5" class="md5-button">æ˜¾ç¤ºMD5</button>
						<!-- åˆ‡æ¢MD5æ˜¾ç¤ºçŠ¶æ€çš„æŒ‰é’® -->
						<button id="copyMD5" class="md5-button">å¤åˆ¶</button>
						<!-- å¤åˆ¶MD5çš„æŒ‰é’® -->
					</div>
				</div>
				<p class="md5-caption">è¯¥æ ‡è¯†ç¬¦åŸºäºå½“å‰ç‰Œå †ç”Ÿæˆï¼Œç”¨äºéªŒè¯ç‰Œå †å”¯ä¸€æ€§</p>
				<!-- MD5åŠŸèƒ½è¯´æ˜ -->
				<div class="verify-panel">
					<!-- éªŒè¯é¢æ¿ -->
					<input type="text" id="verifyMD5" placeholder="è¾“å…¥MD5éªŒè¯ç‰Œå †" class="verify-input">
					<!-- MD5è¾“å…¥æ¡† -->
					<button onclick="verifyDeck()" class="md5-button">éªŒè¯</button>
					<!-- è§¦å‘éªŒè¯çš„æŒ‰é’® -->
					<span id="verifyResult" class="verify-result"></span>
					<!-- éªŒè¯ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
				</div>
			</div>
			<div class="aes-panel">
				<!-- AESé¢æ¿ -->
				<div class="md5-display">
					<div id="aesValue" class="aes-value">â€‹**â€‹*â€‹**â€‹*</div>
					<!-- AESå€¼æ˜¾ç¤ºåŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
					<div class="md5-buttons">
						<button id="toggleAES" class="md5-button">æ˜¾ç¤ºAES</button>
						<!-- åˆ‡æ¢AESæ˜¾ç¤ºçŠ¶æ€çš„æŒ‰é’® -->
						<button id="copyAES" class="md5-button">å¤åˆ¶</button>
						<!-- å¤åˆ¶AESçš„æŒ‰é’® -->
					</div>
				</div>
				<p class="aes-caption">åŒ…å«å¯†é’¥çš„AESç¼–ç ï¼Œå¯åå‘è§£æç‰Œå †</p>
				<!-- AESåŠŸèƒ½è¯´æ˜ -->
				<div class="verify-panel">
					<!-- éªŒè¯é¢æ¿ -->
					<input type="text" id="verifyAES" placeholder="è¾“å…¥AESç¼–ç éªŒè¯ç‰Œå †" class="verify-input">
					<!-- AESè¾“å…¥æ¡† -->
					<button onclick="verifyAESDeck()" class="md5-button">è§£å¯†éªŒè¯</button>
					<!-- è§¦å‘éªŒè¯çš„æŒ‰é’® -->
					<span id="verifyAESResult" class="verify-result"></span>
					<!-- éªŒè¯ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
				</div>
				<div class="log-panel">
					<button id="exportLog" class="md5-button log-button">
						ğŸ“„ ç”Ÿæˆå®‰å…¨æ—¥å¿—æ–‡ä»¶
						<!-- æ—¥å¿—å¯¼å‡ºæŒ‰é’® -->
					</button>
				</div>
			</div>
		</div>
		<h2>è®°ç‰Œå™¨
			<button id="toggleCounter" style="font-size: 12px; padding: 2px 5px;">â–¼ æ”¶èµ·</button>
			<!-- è®°ç‰Œå™¨æ ‡é¢˜å’ŒæŠ˜å æŒ‰é’® -->
		</h2>
		<div id="remaining-counts"></div>
		<!-- è®°ç‰Œå™¨å†…å®¹åŒºåŸŸï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
		<!-- çŠ¶æ€ä¿¡æ¯æ ‡é¢˜ -->
		<h3>
			çŠ¶æ€ä¿¡æ¯
			<button id="toggleStatusArea" style="font-size: 12px; padding: 2px 5px;">â–¼ æ”¶èµ·</button>
		</h3>
		<div id="status-area">
			<div id="damage-counter">
				<div id="total-damage">æ€»ä¼¤å®³: 0</div>
				<div id="turn-damage">å½“å‰å›åˆä¼¤å®³: 0</div>
			</div>
			<div id="kill-counter">æ€å¯ç”¨æ¬¡æ•°ï¼š2ï¼Œæœ¬å›åˆå·²ä½¿ç”¨æ€çš„ä¸ªæ•°ï¼š0</div>
			<div id="zhuge-status">è¯¸è‘›è¿å¼©ï¼šæœªè£…å¤‡</div>
			<div id="peach-counter">æ¡ƒå¯ç”¨æ¬¡æ•°ï¼š1</div>
			<div class="wine-box">
			  <div id="wine-counter">é…’å¯ç”¨æ¬¡æ•°ï¼š1</div>
			  <div id="wine-buff">å½“å‰æ— é…’åŠ æˆ</div>
			</div>

			<div id="delay-area">
				<div class="delay-section">
					<h4>å…µç²®å¯¸æ–­</h4>
					<div id="bingliang-container" class="delay-cards"></div>
				</div>
				<div class="delay-section">
					<h4>ä¹ä¸æ€èœ€</h4>
					<div id="lebu-container" class="delay-cards"></div>
				</div>
				<div class="delay-section">
					<h4>é—ªç”µ</h4>
					<div id="shandian-container" class="delay-cards"></div>
				</div>
			</div>
		</div>

		<div id="testProgress" style="display:none;">
			<!-- æµ‹è¯•è¿›åº¦æ¡ï¼ˆé»˜è®¤éšè—ï¼‰ -->
			<progress value="0" max="100"></progress>
			<!-- HTML5è¿›åº¦æ¡å…ƒç´  -->
			<span>0%</span>
			<!-- è¿›åº¦ç™¾åˆ†æ¯”æ˜¾ç¤º -->
		</div>
		<div id="deck"></div>
		<!-- ç‰Œå †æ˜¾ç¤ºåŒºåŸŸ -->
		<div id="remaining"></div>
		<div id="previousCardInfo" style="display: inline-block; margin-left: 10px; font-size: 14px; color: #555;">
			ä¸Šä¸€å¼ ç‰Œï¼šç©º
		</div>
		<div style="text-align: center; margin: 20px 0;">
			<button id="zhangbaBtn"
				style="padding: 12px 24px; background-color: #2196F3; color: white; border: none; border-radius: 5px; font-size: 16px; display: none;">
				ä¸ˆå…«
			</button>
		</div>
		<!-- å‰©ä½™ç‰Œå †æ˜¾ç¤ºåŒºåŸŸ -->
		<div id="hand"></div>
		<!-- ç©å®¶æ‰‹ç‰Œæ˜¾ç¤ºåŒºåŸŸ -->
		<div style="margin-top: 15px; text-align: center;">
			<button id="organizeHandBtn"
				style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px;">
				æ•´ç†æ‰‹ç‰Œ
			</button>
			<p style="font-size: 12px; color: #666; margin-top: 5px;">
				æ’åºé¡ºåºï¼šè¯¸è‘›è¿å¼©â†’æ€â†’é…’â†’é”¦å›Šç‰Œâ†’è£…å¤‡ç‰Œï¼ˆé™¤è¯¸è‘›è¿å¼©å¤–ï¼‰â†’æ¡ƒâ†’é—ªâ†’æ— æ‡ˆå¯å‡»(æœ‰3ç§’å†·å´)
			</p>
		</div>
		<h3>æ“ä½œæ—¥å¿—</h3>
		<!-- æ—¥å¿—åŒºåŸŸæ ‡é¢˜ -->
		<div id="log-container">
			<!-- æ—¥å¿—å®¹å™¨ -->
			<div id="log"></div>
			<!-- æ—¥å¿—å†…å®¹åŒºåŸŸï¼ˆåŠ¨æ€å¡«å……ï¼‰ -->
		</div>
		<div id="stageInfo" class="phase"></div>
		<!-- æ¸¸æˆé˜¶æ®µä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
		<script>
			// å®šä¹‰æ¸¸æˆçŠ¶æ€å˜é‡
			let deck = []; // å­˜å‚¨å½“å‰ç‰Œå †çš„æ•°ç»„
			let drawnCards = []; // å­˜å‚¨å·²æŠ½å–å¡ç‰Œçš„æ•°ç»„
			let discardPile = []; // å­˜å‚¨å¼ƒç‰Œå †çš„æ•°ç»„
			let hand = []; // å­˜å‚¨ç©å®¶æ‰‹ç‰Œçš„æ•°ç»„
			let phase = ''; // å½“å‰æ¸¸æˆé˜¶æ®µï¼ˆå‡†å¤‡/æ‘¸ç‰Œ/å‡ºç‰Œï¼‰
			let lastUsedCard = null; // ä¸Šä¸€æ¬¡ä½¿ç”¨çš„å¡ç‰Œå¯¹è±¡
			let currentMD5 = ''; // å½“å‰ç‰Œå †çš„MD5å“ˆå¸Œå€¼
			let showMD5 = false; // æ§åˆ¶MD5å€¼æ˜¯å¦æ˜¾ç¤ºçš„æ ‡å¿—
			let currentAES = ''; // å½“å‰ç‰Œå †çš„AESåŠ å¯†å€¼
			let showAES = false; // æ§åˆ¶AESå€¼æ˜¯å¦æ˜¾ç¤ºçš„æ ‡å¿—
			let originalDeck = []; // åŸå§‹ç‰Œå †å¤‡ä»½ï¼ˆæœªä½¿ç”¨ï¼‰
			let isCounterCollapsed = false; // è®°ç‰Œå™¨æ˜¯å¦æŠ˜å çš„æ ‡å¿—
			let isMD5AESCollapsed = false; // å®‰å…¨æ ¡éªŒåŒºæ˜¯å¦æŠ˜å çš„æ ‡å¿—
			let killCount = 2; // å¯ç”¨çš„"æ€"æ¬¡æ•°
			let hasZhugeLianNu = false; // æ˜¯å¦è£…å¤‡è¯¸è‘›è¿å¼©çš„æ ‡å¿—
			let currentWeapon = null; // å½“å‰è£…å¤‡çš„æ­¦å™¨
			let peachCount = 1; // å¯ç”¨çš„"æ¡ƒ"æ¬¡æ•°
			let wineCount = 1; // å¯ç”¨çš„"é…’"æ¬¡æ•°
			let reservedInitialAK = null; // å­˜å‚¨é¢„ç•™çš„è¯¸è‘›è¿å¼©
			// çŠ¶æ€å˜é‡å®šä¹‰ï¼ˆå»¶æ—¶é”¦å›ŠåŒºåŸŸï¼‰
			let bingliangArea = []; // å…µç²®å¯¸æ–­å­˜æ”¾åŒº
			let lebuArea = []; // ä¹ä¸æ€èœ€å­˜æ”¾åŒº
			const MAX_DELAY_CARDS = 2; // æ¯ç§ç‰Œä¸Šé™2å¼ 
			let shandianArea = []; // é—ªç”µå­˜æ”¾åŒº
			const MAX_SHANDIAN = 1; // é—ªç”µä¸Šé™1å¼ 
			let totalDamage = 0; // æ€»ä¼¤å®³è®¡æ•°å™¨
			let currentTurnDamage = 0; // å½“å‰å›åˆä¼¤å®³è®¡æ•°å™¨
			let wineEffect = false; // é…’æ•ˆæœæ ‡è®°ï¼ˆä¸‹ä¸€å¼ æ€ä¼¤å®³+1ï¼‰
			let usedKillCount = 0; // æœ¬å›åˆå·²ä½¿ç”¨æ€çš„æ¬¡æ•°

			let qinglongActive = false; // é’é¾™åƒæœˆåˆ€æ˜¯å¦æ¿€æ´»
			let qinglongCards = []; // å­˜å‚¨é’é¾™åƒæœˆåˆ€ä½¿ç”¨çš„æ€
			let qinglongWineBonus = false; // è®°å½•ç¼–å·0çš„æ€æ˜¯å¦äº«å—é…’åŠ æˆ

			let previousCard = null;

			// åˆå§‹åŒ–ç‰Œå †å‡½æ•°
			function initializeDeck() {
				// æ¸…ç©ºæ“ä½œæ—¥å¿—
				document.getElementById('log').innerHTML = '';
				log("ç‰Œå †åˆå§‹åŒ–å¼€å§‹");

				// é‡ç½®é¢„ç•™çš„AK
				reservedInitialAK = null;

				// é‡ç½®æ‰€æœ‰ç‰Œå †ç›¸å…³å˜é‡
				deck = [];
				drawnCards = [];
				discardPile = [];
				hand = [];
				document.getElementById('deck').innerHTML = ''; // æ¸…ç©ºç‰Œå †æ˜¾ç¤ºåŒºåŸŸ
				phase = ''; // é‡ç½®æ¸¸æˆé˜¶æ®µ
				lastUsedCard = null; // é‡ç½®æœ€åä½¿ç”¨çš„å¡ç‰Œ
				peachCount = 1; // é‡ç½®æ¡ƒä½¿ç”¨æ¬¡æ•°
				wineCount = 1; // é‡ç½®é…’ä½¿ç”¨æ¬¡æ•°
				// é‡ç½®å»¶æ—¶é”¦å›ŠåŒº
				bingliangArea = [];
				lebuArea = [];
				shandianArea = [];
				// é‡ç½®ä¼¤å®³è®¡æ•°å™¨
				totalDamage = 0;
				currentTurnDamage = 0;
				wineEffect = false;

				// æ¸…ç©ºå‰ä¸€å¼ ç‰Œä¿¡æ¯
				previousCard = null;
				document.getElementById('previousCardInfo').textContent = 'ä¸Šä¸€å¼ ç‰Œï¼šç©º';

				// ä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„standardDeckï¼ˆåœ¨card.jsä¸­ï¼‰åˆ›å»ºç‰Œå †
				standardDeck.forEach(card => {
					// å¤„ç†æ¯å¼ å¡ç‰Œçš„èŠ±è‰²å’Œç‚¹æ•°
					card.suits.forEach(suitStr => {
						// ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æèŠ±è‰²å’Œç‚¹æ•°
						const match = suitStr.match(/^([â™ â™¥â™£â™¦]ï¸?)([JQKA]|\d+)$/);
						if (match) {
							const suitPart = match[1]; // æå–èŠ±è‰²éƒ¨åˆ†
							let point = match[2]; // æå–ç‚¹æ•°éƒ¨åˆ†

							// å°†å­—æ¯ç‚¹æ•°è½¬æ¢ä¸ºæ•°å­—
							switch (point) {
								case 'J':
									point = 11;
									break;
								case 'Q':
									point = 12;
									break;
								case 'K':
									point = 13;
									break;
								case 'A':
									point = 1;
									break;
								default:
									point = parseInt(point, 10); // æ•°å­—ç‚¹æ•°ç›´æ¥è½¬æ¢ä¸ºæ•´æ•°
							}

							// æ ¹æ®å¡ç‰Œæ•°é‡åˆ›å»ºå¤šä¸ªå‰¯æœ¬
							for (let i = 0; i < card.count; i++) {
								// åˆ›å»ºå¡ç‰Œå¯¹è±¡å¹¶æ·»åŠ åˆ°ç‰Œå †
								deck.push({
									name: card.name, // å¡ç‰Œåç§°
									suit: suitPart, // èŠ±è‰²
									point: point, // ç‚¹æ•°
									uid: CryptoJS.lib.WordArray.random(16).toString() // å”¯ä¸€ID
								});
							}
						}
					});
				});

				// é‡ç½®æ­¦å™¨å’Œæ”»å‡»çŠ¶æ€
				currentWeapon = null;
				killCount = 2;
				hasZhugeLianNu = false;

				//å»¶æ—¶é”¦å›Š
				bingliangArea = [];
				lebuArea = [];
				shandianArea = [];

				// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
				updateStatus();
				// æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆåŒ…å«ä¼¤å®³è®¡æ•°å™¨ï¼‰
				updateStatus();
				// æ´—ç‰Œ
				shuffleDeck();
				// ç”Ÿæˆç‰Œå †MD5
				generateDeckMD5();
				// æ›´æ–°MD5æ˜¾ç¤º
				updateMD5Display();
				// ç”Ÿæˆç‰Œå †AES
				generateDeckAES();
				// æ›´æ–°AESæ˜¾ç¤º
				updateAESDisplay();
				// æ›´æ–°å‰©ä½™ç‰Œæ•°æ˜¾ç¤º
				updateRemaining();
				// å¼€å§‹æ¸¸æˆ
				startGame();
				log("ç‰Œå †åˆå§‹åŒ–å®Œæˆ");
			}

			// ====== å¼ƒç½®æ‰‹ç‰Œå‡½æ•° ======
			function discardHand() {
				// å°†å½“å‰æ‰‹ç‰Œç§»åŠ¨åˆ°å¼ƒç‰Œå †
				while (hand.length > 0) {
					const card = hand.pop();
					discardPile.push(card);
					log(`å¼ƒç½®: ${card.name}${card.suit}${card.point}`);
				}

				// æ›´æ–°æ˜¾ç¤º
				updateHandDisplay();
				updateDiscardPileDisplay();
			}


			// æ´—ç‰Œå‡½æ•°
			function shuffleDeck() {
				log("å¼€å§‹ç‰¹æ®Šè§„åˆ™æ´—ç‰Œ");

				// 1. åˆ†ç±»å¡ç‰Œ
				const heil = []; // é»‘åˆ©ç‰Œ
				const hl = []; // çº¢åˆ©ç‰Œ
				const other = []; // å…¶ä»–ç‰Œ

				// å®šä¹‰é»‘åˆ©ç‰Œåˆ—è¡¨
				const heilCards = [
					"é—ª", "æ¡ƒ", "é›Œé›„åŒè‚¡å‰‘", "é’é¾™åƒæœˆåˆ€", "é’é‡­å‰‘",
					"ä¸ˆå…«è›‡çŸ›", "éº’éºŸå¼“", "è´¯çŸ³æ–§", "æ–¹å¤©ç”»æˆŸ",
					"å¯’å†°å‰‘", "å¤é”­åˆ€", "æœ±é›€ç¾½æ‰‡"
				];

				// å®šä¹‰çº¢åˆ©ç‰Œåˆ—è¡¨
				const hlCards = ["æ— ä¸­ç”Ÿæœ‰", "é¡ºæ‰‹ç‰µç¾Š", "è¿‡æ²³æ‹†æ¡¥"];

				deck.forEach(card => {
					if (heilCards.includes(card.name)) {
						heil.push(card);
					} else if (hlCards.includes(card.name)) {
						hl.push(card);
					} else {
						other.push(card);
					}
				});

				// æ—¥å¿—åˆ†ç±»ç»“æœ
				log(`åˆ†ç±»å®Œæˆ: heil=${heil.length}|hl=${hl.length}|other=${other.length}${reservedInitialAK ? '|ak_reserved' : ''}`);

				// 2. å¯¹æ¯ç±»ç‰Œè¿›è¡Œå†…éƒ¨æ´—ç‰Œ
				shuffleArray(heil);
				shuffleArray(hl);
				shuffleArray(other);

				// 3. æ„å»ºæ–°ç‰Œå †ï¼šçº¢åˆ©ç‰Œ -> å…¶ä»–ç‰Œ -> é»‘åˆ©ç‰Œ
				deck = [...hl, ...other, ...heil];

				// 4. é¢å¤–çš„æ´—ç‰Œï¼šå°†å‰10å¼ å’Œå10å¼ éšæœºäº¤æ¢
				const swaps = Math.min(10, Math.floor(deck.length / 2));
				for (let i = 0; i < swaps; i++) {
					const j = deck.length - 1 - i;
					[deck[i], deck[j]] = [deck[j], deck[i]];
				}

				// 5. å¦‚æœä¹‹å‰é¢„ç•™äº†AKï¼Œæ·»åŠ åˆ°æ—¥å¿—ä½†ä¸æ”¾å›ç‰Œå †
				if (reservedInitialAK) {
					log(`é¢„ç•™çš„è¯¸è‘›è¿å¼©ä¸åœ¨ç‰Œå †ä¸­ï¼Œå°†å‡ºç°åœ¨åˆå§‹æ‰‹ç‰Œ`);
				}

				// 6. å¦‚æœè£…å¤‡çš„æ­¦å™¨ä¸åœ¨ç‰Œå †ä¸­ï¼Œé‡ç½®æ­¦å™¨çŠ¶æ€
				if (!deck.some(c => c.name === currentWeapon)) {
					currentWeapon = null;
					hasZhugeLianNu = false;
					killCount = 2;
				}

				// é‡ç½®æ¡ƒå’Œé…’çš„ä½¿ç”¨æ¬¡æ•°
				peachCount = 1;
				document.getElementById('peach-counter').textContent = `æ¡ƒå¯ç”¨æ¬¡æ•°ï¼š1`;
				wineCount = 1;

				// æ›´æ–°çŠ¶æ€
				updateStatus();

				// ç”Ÿæˆæ–°çš„AESç¼–ç ï¼ˆç‰Œå †ä¸åŒ…å«é¢„ç•™çš„AKï¼‰
				generateDeckAES();
				updateAESDisplay();

				log("ç‰¹æ®Šè§„åˆ™æ´—ç‰Œå®Œæˆ");
			}

			// Fisher-Yatesæ´—ç‰Œç®—æ³•
			function shuffleArray(array) {
				for (let i = array.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1));
					[array[i], array[j]] = [array[j], array[i]];
				}
			}

			// ====== æ›´æ–°æ‰‹ç‰Œæ˜¾ç¤º ======
			function updateHandDisplay() {
				const handContainer = document.getElementById('hand');
				handContainer.innerHTML = '';

				hand.forEach(card => {
					const div = document.createElement('div');
					div.className = 'card';
					div.innerHTML = `${card.name}<br>${card.suit}${getPointDisplay(card.point)}`;
					handContainer.appendChild(div);
				});
			}

			// ====== åˆå§‹æŠ½ç‰Œå‡½æ•° ======
			function drawInitialHand() {
				hand = [];

				// ä»ç‰Œå †ä¸­æŸ¥æ‰¾è¯¸è‘›è¿å¼©å¹¶ä¼˜å…ˆæŠ½å‡º
				const akIndex = deck.findIndex(card => card.name === "è¯¸è‘›è¿å¼©");
				if (akIndex !== -1) {
					const akCard = deck.splice(akIndex, 1)[0];
					hand.push(akCard);
					log(`åˆå§‹æ‰‹ç‰Œä¼˜å…ˆè·å¾—è¯¸è‘›è¿å¼©(${akCard.uid})`);
				}

				// è¡¥æŠ½å‰©ä½™æ‰‹ç‰Œ
				const cardsToDraw = 4 - hand.length;
				for (let i = 0; i < cardsToDraw; i++) {
					if (deck.length > 0) {
						const card = deck.shift();
						hand.push(card);
						log(`æŠ½å–: ${card.name}${card.suit}${card.point}`);
					}
				}

				updateHandDisplay();
				updateRemaining();
				log(`åˆå§‹æ‰‹ç‰Œå®Œæˆ: ${hand.map(c => c.name).join(', ')}`);
			}



			function verifyShuffle() {
				const first4 = deck.slice(0, 4);
				const hasAKInFirst4 = first4.some(c => c.name === "è¯¸è‘›è¿å¼©");

				const hlTopCount = deck.slice(0, 48).filter(c => ["æ— ä¸­ç”Ÿæœ‰", "é¡ºæ‰‹ç‰µç¾Š", "è¿‡æ²³æ‹†æ¡¥"].includes(c.name)).length;

				const heilBottomCount = deck.slice(112).filter(c => ["æ¡ƒ", "é—ª"].includes(c.name)).length;

				log(`éªŒè¯ç»“æœ:
			     ç¬¬ä¸€å¼ AKä½ç½®æ­£ç¡®: ${hasAKInFirst4}
			     HLç‰Œåœ¨å‰48å¼ : ${hlTopCount}/${hlCards.length} (${(hlTopCount/hlCards.length*100).toFixed(1)}%)
			     Heilç‰Œåœ¨å48å¼ : ${heilBottomCount}/${heilCards.length} (${(heilBottomCount/heilCards.length*100).toFixed(1)}%)`);
			}

			// å°†å¡ç‰Œç‚¹æ•°è½¬æ¢ä¸ºæ˜¾ç¤ºæ ¼å¼çš„å‡½æ•°
			function getPointDisplay(point) {
				switch (point) {
					case 11:
						return 'J'; // 11ç‚¹æ˜¾ç¤ºä¸ºJ
					case 12:
						return 'Q'; // 12ç‚¹æ˜¾ç¤ºä¸ºQ
					case 13:
						return 'K'; // 13ç‚¹æ˜¾ç¤ºä¸ºK
					case 1:
						return 'A'; // 1ç‚¹æ˜¾ç¤ºä¸ºA
					default:
						return point; // å…¶ä»–ç‚¹æ•°ç›´æ¥æ˜¾ç¤ºæ•°å­—
				}
			}

			// ç”Ÿæˆç‰Œå †çš„MD5å“ˆå¸Œå€¼
			function generateDeckMD5() {
				// å°†ç‰Œå †æŒ‰å¡ç‰ŒUIDæ’åºï¼Œç¡®ä¿é¡ºåºä¸€è‡´
				const deckString = deck
					.sort((a, b) => a.uid.localeCompare(b.uid))
					// å°†æ¯å¼ å¡ç‰Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼ï¼šåç§°|èŠ±è‰²|ç‚¹æ•°|UID
					.map(c => `${c.name}|${c.suit}|${c.point}|${c.uid}`)
					// ç”¨"@@"è¿æ¥æ‰€æœ‰å¡ç‰Œå­—ç¬¦ä¸²
					.join('@@');

				// ç”Ÿæˆç‰Œå †å­—ç¬¦ä¸²çš„MD5å“ˆå¸Œï¼ˆç¬¬ä¸€æ¬¡å“ˆå¸Œï¼‰
				const firstHash = CryptoJS.MD5(deckString).toString();

				// è·å–å½“å‰æ—¶é—´æˆ³å¹¶è½¬æ¢ä¸º16è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆå¡«å……åˆ°16ä½ï¼‰
				const timestamp = Date.now().toString(16).padStart(16, '0');

				// å°†ç¬¬ä¸€æ¬¡å“ˆå¸Œç»“æœä¸æ—¶é—´æˆ³ç»“åˆï¼Œç”Ÿæˆæœ€ç»ˆçš„MD5å€¼
				currentMD5 = CryptoJS.MD5(firstHash + timestamp).toString();

				// æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰debugæ ‡å¿—
				const isDebug = new URLSearchParams(window.location.search).has('debug');

				// è°ƒè¯•æ¨¡å¼ä¸‹ä½¿ç”¨åŸå§‹å“ˆå¸Œï¼ˆä¸å«æ—¶é—´æˆ³ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„å“ˆå¸Œ
				currentMD5 = isDebug ? firstHash : CryptoJS.MD5(firstHash + timestamp).toString();

				// åœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºåŸå§‹å“ˆå¸Œå€¼
				if (isDebug) console.log("è°ƒè¯•æ¨¡å¼MD5ï¼ˆä¸å«æ—¶é—´æˆ³ï¼‰:", currentMD5);
			}

			// å­˜å‚¨ç‰Œå †å¿«ç…§çš„å¯¹è±¡
			const deckSnapshots = {};

			// ä¿å­˜å½“å‰ç‰Œå †å¿«ç…§
			function saveSnapshot() {
				// åˆ›å»ºç‰Œå †å¿«ç…§å¯¹è±¡
				const snapshot = {
					deck: deck.map(c => ({
						...c
					})), // åˆ›å»ºç‰Œå †çš„æ·±æ‹·è´
					md5: currentMD5, // å½“å‰MD5å€¼
					timestamp: Date.now() // å½“å‰æ—¶é—´æˆ³
				};

				// ä»¥MD5ä¸ºé”®å­˜å‚¨å¿«ç…§
				deckSnapshots[currentMD5] = snapshot;

				// å°†å¿«ç…§ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				localStorage.setItem('md5Snapshots', JSON.stringify(deckSnapshots));

				// è®°å½•æ—¥å¿—
				log(`ç‰Œå †å¿«ç…§å·²ä¿å­˜ (MD5: ${currentMD5})`);
			}

			// åŠ è½½æŒ‡å®šMD5å¯¹åº”çš„ç‰Œå †å¿«ç…§
			function loadSnapshot(targetMD5) {
				// è·å–å¯¹åº”MD5çš„å¿«ç…§
				const snapshot = deckSnapshots[targetMD5];

				// å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¿«ç…§åˆ™æç¤ºç”¨æˆ·
				if (!snapshot) return alert("æ— æ­¤ç‰Œå †è®°å½•");

				// æ¢å¤ç‰Œå †çŠ¶æ€
				deck = snapshot.deck;
				currentMD5 = snapshot.md5;

				// æ›´æ–°ç”¨æˆ·ç•Œé¢
				updateUI();

				// è®°å½•æ—¥å¿—
				log(`å·²åŠ è½½ç‰Œå †å¿«ç…§ (MD5: ${targetMD5})`);
			}

			// æ›´æ–°MD5å€¼çš„æ˜¾ç¤º
			function updateMD5Display() {
				const display = document.getElementById('md5Value');
				if (showMD5) {
					// æ ¼å¼åŒ–MD5å€¼ï¼šæ¯4ä¸ªå­—ç¬¦åŠ ä¸€ä¸ªè¿å­—ç¬¦
					const formatted = currentMD5
						.match(/.{1,4}/g) // å°†å­—ç¬¦ä¸²åˆ†å‰²ä¸ºæ¯4ä¸ªå­—ç¬¦ä¸€ç»„
						.join('-') // ç”¨è¿å­—ç¬¦è¿æ¥å„ç»„
						.toUpperCase(); // è½¬æ¢ä¸ºå¤§å†™

					// æ˜¾ç¤ºæ ¼å¼åŒ–åçš„MD5å€¼
					display.textContent = formatted;
					display.style.color = '#2196F3'; // è®¾ç½®è“è‰²æ–‡æœ¬
				} else {
					// éšè—MD5å€¼ï¼Œæ˜¾ç¤ºæ˜Ÿå·
					display.textContent = 'â€‹**â€‹*â€‹**â€‹*';
					display.style.color = '#666'; // è®¾ç½®ç°è‰²æ–‡æœ¬
				}
			}

			// ä¸º"æ˜¾ç¤º/éšè—MD5"æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
			document.getElementById('toggleMD5').addEventListener('click', () => {
				// åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
				showMD5 = !showMD5;

				// æ›´æ–°æŒ‰é’®æ–‡æœ¬
				document.getElementById('toggleMD5').textContent =
					showMD5 ? 'éšè—MD5' : 'æ˜¾ç¤ºMD5';

				// æ›´æ–°æ˜¾ç¤ºå†…å®¹
				updateMD5Display();
			});

			// ä¸º"å¤åˆ¶MD5"æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
			document.getElementById('copyMD5').addEventListener('click', () => {
				// å¦‚æœæ²¡æœ‰MD5å€¼åˆ™ç›´æ¥è¿”å›
				if (!currentMD5) return;

				// å®šä¹‰å¤åˆ¶å‡½æ•°
				const copy = async () => {
					try {
						// å°è¯•ä½¿ç”¨ç°ä»£å‰ªè´´æ¿API
						await navigator.clipboard.writeText(currentMD5);

						// æ·»åŠ å¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
						document.getElementById('copyMD5').classList.add('copied');

						// 1ç§’åç§»é™¤è§†è§‰åé¦ˆ
						setTimeout(() => {
							document.getElementById('copyMD5').classList.remove('copied');
						}, 1000);

						// è®°å½•æ—¥å¿—
						log('MD5å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
					} catch (err) {
						// ç°ä»£APIå¤±è´¥æ—¶ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
						const textarea = document.createElement('textarea');
						textarea.value = currentMD5;
						document.body.appendChild(textarea);
						textarea.select();
						document.execCommand('copy');
						document.body.removeChild(textarea);
						log('MD5å·²å¤åˆ¶ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰');
					}
				};

				// æ‰§è¡Œå¤åˆ¶å¹¶å¤„ç†å¯èƒ½çš„é”™è¯¯
				copy().catch(err => {
					console.error('å¤åˆ¶å¤±è´¥:', err);
					log('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
				});
			});

			// éªŒè¯ç”¨æˆ·è¾“å…¥çš„MD5å€¼
			function verifyDeck() {
				// è·å–ç”¨æˆ·è¾“å…¥çš„MD5å€¼å¹¶æ¸…ç†æ ¼å¼
				const inputMD5 = document.getElementById('verifyMD5').value
					.replace(/-/g, '') // ç§»é™¤è¿å­—ç¬¦
					.toLowerCase(); // è½¬æ¢ä¸ºå°å†™

				// ä¸å½“å‰MD5æ¯”è¾ƒ
				const isValid = currentMD5 === inputMD5;

				// è·å–ç»“æœæ˜¾ç¤ºå…ƒç´ 
				const resultSpan = document.getElementById('verifyResult');

				// è®¾ç½®éªŒè¯ç»“æœæ–‡æœ¬å’Œé¢œè‰²
				resultSpan.textContent = isValid ? 'âœ… éªŒè¯é€šè¿‡' : 'âŒ éªŒè¯å¤±è´¥';
				resultSpan.style.color = isValid ? '#4CAF50' : '#f44336'; // ç»¿è‰²/çº¢è‰²

				// è®°å½•æ—¥å¿—
				log(`ç‰Œå †MD5éªŒè¯${isValid ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
			}

			// ç”Ÿæˆç‰Œå †çš„AESåŠ å¯†è¡¨ç¤º
			function generateDeckAES() {
				try {
					// ç®€åŒ–ç‰Œå †æ•°æ®ç»“æ„ï¼ˆå‡å°‘JSONå¤§å°ï¼‰
					const deckData = deck.map(c => ({
						n: c.name, // å¡ç‰Œåç§°ï¼ˆç¼©å†™ï¼‰
						s: c.suit, // èŠ±è‰²
						p: c.point, // ç‚¹æ•°
						u: c.uid // å”¯ä¸€IDï¼ˆç¼©å†™ï¼‰
					}));

					// ç”Ÿæˆéšæœºå¯†é’¥ï¼ˆ128ä½ï¼‰
					const key = CryptoJS.lib.WordArray.random(128 / 8);

					// ç”Ÿæˆéšæœºåˆå§‹åŒ–å‘é‡ï¼ˆ128ä½ï¼‰
					const iv = CryptoJS.lib.WordArray.random(128 / 8);

					// ä½¿ç”¨AES-CBCæ¨¡å¼åŠ å¯†ç‰Œå †æ•°æ®
					const encrypted = CryptoJS.AES.encrypt(
						JSON.stringify(deckData), // è¦åŠ å¯†çš„å­—ç¬¦ä¸²åŒ–ç‰Œå †æ•°æ®
						key, // åŠ å¯†å¯†é’¥
						{
							iv: iv
						} // åˆå§‹åŒ–å‘é‡
					);

					// æ„å»ºAESç¼–ç ï¼šå¯†é’¥::åˆå§‹åŒ–å‘é‡::åŠ å¯†æ•°æ®
					currentAES = [
						key.toString(CryptoJS.enc.Base64), // Base64ç¼–ç çš„å¯†é’¥
						iv.toString(CryptoJS.enc.Base64), // Base64ç¼–ç çš„åˆå§‹åŒ–å‘é‡
						encrypted.toString() // åŠ å¯†åçš„å­—ç¬¦ä¸²
					].join('::');
				} catch (e) {
					// é”™è¯¯å¤„ç†ï¼šè¾“å‡ºé”™è¯¯å¹¶è®¾ç½®é”™è¯¯æ ‡è¯†
					console.error('AESç”Ÿæˆå¤±è´¥:', e);
					currentAES = 'ERROR';
				}
			}

			// æ›´æ–°AESå€¼çš„æ˜¾ç¤º
			function updateAESDisplay() {
				const display = document.getElementById('aesValue');
				if (!display) return; // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿å…ƒç´ å­˜åœ¨

				if (showAES) {
					// æ ¼å¼åŒ–æ˜¾ç¤ºï¼šæ¯24ä¸ªå­—ç¬¦æ¢è¡Œ
					const formatted = currentAES
						.match(/.{1,24}/g) // å°†å­—ç¬¦ä¸²åˆ†å‰²æˆæœ€å¤š24å­—ç¬¦çš„ç‰‡æ®µ
						.join('\n'); // ç”¨æ¢è¡Œç¬¦è¿æ¥

					// æ˜¾ç¤ºæ ¼å¼åŒ–åçš„AESå€¼
					display.textContent = formatted;
					display.style.color = '#2196F3'; // è®¾ç½®è“è‰²æ–‡æœ¬
				} else {
					// éšè—AESå€¼ï¼Œæ˜¾ç¤ºæ˜Ÿå·
					display.textContent = 'â€‹**â€‹*â€‹**â€‹*';
					display.style.color = '#666'; // è®¾ç½®ç°è‰²æ–‡æœ¬
				}
			}

			// ä¸º"æ˜¾ç¤º/éšè—AES"æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
			document.getElementById('toggleAES').addEventListener('click', () => {
				// åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
				showAES = !showAES;

				// æ›´æ–°æŒ‰é’®æ–‡æœ¬
				document.getElementById('toggleAES').textContent =
					showAES ? 'éšè—AES' : 'æ˜¾ç¤ºAES';

				// æ›´æ–°æ˜¾ç¤ºå†…å®¹
				updateAESDisplay();
			});

			// ä¸º"å¤åˆ¶AES"æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
			document.getElementById('copyAES').addEventListener('click', () => {
				// æ£€æŸ¥AESå€¼æ˜¯å¦æœ‰æ•ˆ
				if (!currentAES || currentAES === 'â€‹**â€‹*â€‹**â€‹*') return;

				// å®šä¹‰å¤åˆ¶å‡½æ•°
				const copy = async () => {
					try {
						// å°è¯•ä½¿ç”¨ç°ä»£å‰ªè´´æ¿API
						await navigator.clipboard.writeText(currentAES);

						// æ·»åŠ å¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
						document.getElementById('copyAES').classList.add('copied');

						// 1ç§’åç§»é™¤è§†è§‰åé¦ˆ
						setTimeout(() => {
							document.getElementById('copyAES').classList.remove('copied');
						}, 1000);

						// è®°å½•æ—¥å¿—
						log('AESç¼–ç å·²å¤åˆ¶');
					} catch (err) {
						// ç°ä»£APIå¤±è´¥æ—¶ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
						const textarea = document.createElement('textarea');
						textarea.value = currentAES;
						document.body.appendChild(textarea);
						textarea.select();
						document.execCommand('copy');
						document.body.removeChild(textarea);
						log('AESç¼–ç å·²å¤åˆ¶ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰');
					}
				};

				// æ‰§è¡Œå¤åˆ¶å¹¶å¤„ç†å¯èƒ½çš„é”™è¯¯
				copy().catch(err => {
					console.error('å¤åˆ¶å¤±è´¥:', err);
					log('AESå¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
				});
			});

			// éªŒè¯å¹¶è§£å¯†ç”¨æˆ·è¾“å…¥çš„AESç¼–ç 
			function verifyAESDeck() {
				// è·å–ç”¨æˆ·è¾“å…¥çš„AESç¼–ç 
				const input = document.getElementById('verifyAES').value.trim();
				const resultSpan = document.getElementById('verifyAESResult');

				// æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©º
				if (!input) {
					resultSpan.textContent = 'âŒ è¯·è¾“å…¥ç¼–ç ';
					resultSpan.style.color = '#f44336'; // çº¢è‰²é”™è¯¯æç¤º
					return;
				}

				try {
					// åˆ†å‰²è¾“å…¥ï¼šæ ¼å¼åº”ä¸º å¯†é’¥::åˆå§‹åŒ–å‘é‡::åŠ å¯†æ•°æ®
					const [keyB64, ivB64, data] = input.split('::');

					// éªŒè¯æ ¼å¼æ˜¯å¦æ­£ç¡®
					if (!keyB64 || !ivB64 || !data) throw new Error('æ ¼å¼æ— æ•ˆ');

					// ä»Base64è§£æå¯†é’¥å’Œåˆå§‹åŒ–å‘é‡
					const key = CryptoJS.enc.Base64.parse(keyB64);
					const iv = CryptoJS.enc.Base64.parse(ivB64);

					// ä½¿ç”¨AESè§£å¯†æ•°æ®
					const decrypted = CryptoJS.AES.decrypt(data, key, {
						iv: iv
					});

					// å°†è§£å¯†ç»“æœè½¬æ¢ä¸ºUTF-8å­—ç¬¦ä¸²
					const utf8String = decrypted.toString(CryptoJS.enc.Utf8);

					// æ£€æŸ¥è§£å¯†æ˜¯å¦æˆåŠŸ
					if (!utf8String) throw new Error('è§£å¯†å¤±è´¥');

					// è§£æè§£å¯†åçš„JSONæ•°æ®
					const decoded = JSON.parse(utf8String);

					// é‡å»ºç‰Œå †æ•°æ®ç»“æ„
					deck = decoded.map(c => ({
						name: c.n, // æ¢å¤å¡ç‰Œåç§°
						suit: c.s, // æ¢å¤èŠ±è‰²
						point: c.p, // æ¢å¤ç‚¹æ•°
						uid: c.u // æ¢å¤å”¯ä¸€ID
					}));

					// æ›´æ–°ç›¸å…³çŠ¶æ€å’Œæ˜¾ç¤º
					generateDeckMD5(); // é‡æ–°ç”ŸæˆMD5
					updateMD5Display(); // æ›´æ–°MD5æ˜¾ç¤º
					updateRemaining(); // æ›´æ–°å‰©ä½™ç‰Œæ•°
					revealDeck(); // æ˜¾ç¤ºç‰Œå †

					// è®°å½•æ—¥å¿—
					log('AESè§£ç æˆåŠŸï¼Œç‰Œå †å·²åŠ è½½');

					// æ˜¾ç¤ºéªŒè¯æˆåŠŸ
					resultSpan.textContent = 'âœ… éªŒè¯é€šè¿‡';
					resultSpan.style.color = '#4CAF50'; // ç»¿è‰²æˆåŠŸæç¤º
				} catch (e) {
					// é”™è¯¯å¤„ç†
					console.error('AESéªŒè¯å¤±è´¥:', e);
					resultSpan.textContent = 'âŒ æ— æ•ˆç¼–ç ';
					resultSpan.style.color = '#f44336'; // çº¢è‰²é”™è¯¯æç¤º
					log('AESè§£ç å¤±è´¥: ' + e.message);
				}
			}

			// æ›´æ–°å»¶æ—¶é”¦å›ŠåŒºåŸŸæ˜¾ç¤º
			function updateDelayArea() {
				const bingliangContainer = document.getElementById('bingliang-container');
				const lebuContainer = document.getElementById('lebu-container');
				const shandianContainer = document.getElementById('shandian-container'); // ç¡®ä¿é€‰æ‹©å™¨æ­£ç¡®

				// æ¸…ç©ºå®¹å™¨
				bingliangContainer.innerHTML = '';
				lebuContainer.innerHTML = '';
				shandianContainer.innerHTML = '';

				// å…µç²®å¯¸æ–­åŒºåŸŸæ›´æ–°
				if (bingliangArea.length === 0) {
					bingliangContainer.innerHTML = '<div class="delay-card disabled">ç©º</div>';
				} else {
					bingliangArea.forEach(card => {
						const cardDiv = document.createElement('div');
						cardDiv.className = 'delay-card';
						cardDiv.textContent = `${card.name} ${card.suit}${getPointDisplay(card.point)}`;
						bingliangContainer.appendChild(cardDiv);
					});
				}

				// ä¹ä¸æ€èœ€åŒºåŸŸæ›´æ–°
				if (lebuArea.length === 0) {
					lebuContainer.innerHTML = '<div class="delay-card disabled">ç©º</div>';
				} else {
					lebuArea.forEach(card => {
						const cardDiv = document.createElement('div');
						cardDiv.className = 'delay-card';
						cardDiv.textContent = `${card.name} ${card.suit}${getPointDisplay(card.point)}`;
						lebuContainer.appendChild(cardDiv);
					});
				}

				// é—ªç”µåŒºåŸŸæ›´æ–°
				if (shandianArea.length === 0) {
					shandianContainer.innerHTML = '<div class="delay-card disabled">ç©º</div>';
				} else {
					shandianArea.forEach(card => {
						const cardDiv = document.createElement('div');
						cardDiv.className = 'delay-card';
						cardDiv.textContent = `${card.name} ${card.suit}${getPointDisplay(card.point)}`;
						shandianContainer.appendChild(cardDiv);
					});
				}
			}

			// å¤„ç†è¿‡æ²³æ‹†æ¡¥æ•ˆæœ
			function handleGuohe(card, index) {
				// è·å–æ‰€æœ‰å¯æ‹†é™¤çš„å»¶æ—¶é”¦å›Šï¼ˆå…µç²®å¯¸æ–­å’Œä¹ä¸æ€èœ€ï¼‰
				const delayCards = [...bingliangArea, ...lebuArea];

				// æ£€æŸ¥æ˜¯å¦æœ‰å¯æ‹†é™¤çš„ç‰Œ
				if (delayCards.length > 0) {
					// æœ‰å»¶æ—¶é”¦å›Šï¼Œæ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
					showGuoheDialog(card, index, delayCards);
				} else {
					// æ²¡æœ‰å»¶æ—¶é”¦å›Šï¼Œç›´æ¥ä½¿ç”¨å¡ç‰Œå¹¶æ£€æŸ¥æ¸è¥
					useGuohe(card, index);
				}
			}

			// æ˜¾ç¤ºè¿‡æ²³æ‹†æ¡¥é€‰æ‹©å¯¹è¯æ¡†
			function showGuoheDialog(card, index, delayCards) {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'card-selector-modal';
				dialog.innerHTML = `
			        <h3>è¿‡æ²³æ‹†æ¡¥ - é€‰æ‹©è¦æ‹†é™¤çš„å»¶æ—¶é”¦å›Š</h3>
			        <p>è¯·é€‰æ‹©è¦æ‹†é™¤çš„ç‰Œï¼ˆç‚¹å‡»å¡ç‰Œé€‰æ‹©ï¼‰ï¼š</p>
			        <div id="delayCardsContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;"></div>
			        <button id="noRemove" class="dialog-button" style="background:#C8E6C9;">
			            ä¸æ‹†é™¤ï¼Œä»…ä½¿ç”¨æ•ˆæœ
			        </button>
			    `;

				// è·å–å¡ç‰Œå®¹å™¨
				const cardsContainer = dialog.querySelector('#delayCardsContainer');

				// æ·»åŠ æ¯å¼ å¯æ‹†é™¤çš„å¡ç‰Œ
				delayCards.forEach((delayCard, i) => {
					const cardDiv = document.createElement('div');
					cardDiv.className = 'delay-card-selectable';
					cardDiv.innerHTML = `
			            <div>${delayCard.name}</div>
			            <div>${delayCard.suit}${getPointDisplay(delayCard.point)}</div>
			        `;

					// æ·»åŠ ç‚¹å‡»äº‹ä»¶
					cardDiv.addEventListener('click', () => {
						removeSpecificDelayCard(delayCard);
						useGuohe(card, index);
						closeAllModals();
					});

					cardsContainer.appendChild(cardDiv);
				});

				// å…³é—­æ‰€æœ‰å¼¹çª—çš„å‡½æ•°
				const closeAllModals = () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
				};

				// "ä¸æ‹†é™¤"æŒ‰é’®
				dialog.querySelector('#noRemove').addEventListener('click', () => {
					closeAllModals();
					useGuohe(card, index);
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// ç§»é™¤æŒ‡å®šçš„å»¶æ—¶é”¦å›Š
			function removeSpecificDelayCard(delayCard) {
				// ç¡®å®šå¡ç‰Œåœ¨å“ªä¸ªåŒºåŸŸ
				let area = null;
				let index = -1;

				// æ£€æŸ¥å…µç²®å¯¸æ–­åŒº
				index = bingliangArea.findIndex(c => c.uid === delayCard.uid);
				if (index !== -1) {
					area = bingliangArea;
				}
				// æ£€æŸ¥ä¹ä¸æ€èœ€åŒº
				else {
					index = lebuArea.findIndex(c => c.uid === delayCard.uid);
					if (index !== -1) {
						area = lebuArea;
					}
				}

				// å¦‚æœæ‰¾åˆ°å¡ç‰Œï¼Œåˆ™ç§»é™¤
				if (area && index !== -1) {
					const removedCard = area.splice(index, 1)[0];
					discardPile.push(removedCard);
					log(`æ‹†é™¤${removedCard.name}: ${removedCard.suit}${getPointDisplay(removedCard.point)}`);

					// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
					updateStatus();
				}
			}

			// ä½¿ç”¨è¿‡æ²³æ‹†æ¡¥å¡ç‰Œ
			function useGuohe(card, index) {
				// ä»æ‰‹ç‰Œç§»é™¤
				const usedCard = hand.splice(index, 1)[0];

				// æ”¾å…¥å¼ƒç‰Œå †
				discardPile.push(usedCard);

				log(`ä½¿ç”¨è¿‡æ²³æ‹†æ¡¥: ${usedCard.suit}${getPointDisplay(usedCard.point)}`);

				// æ£€æŸ¥æ¸è¥æŠ€èƒ½
				if (lastUsedCard &&
					(usedCard.suit === lastUsedCard.suit ||
						usedCard.point === lastUsedCard.point)) {
					log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}

				// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
				lastUsedCard = usedCard;

				// æ›´æ–°ç•Œé¢
				updateStatus();
				updateUI();
			}

			// æ›´æ–°å»¶æ—¶é”¦å›ŠåŒºåŸŸæ˜¾ç¤º
			function updateDelayArea() {
				const bingliangContainer = document.getElementById('bingliang-container');
				const lebuContainer = document.getElementById('lebu-container');
				const shandianContainer = document.getElementById('shandian-container'); 

				// æ¸…ç©ºå®¹å™¨
				bingliangContainer.innerHTML = '';
				lebuContainer.innerHTML = '';
				shandianContainer.innerHTML = '';

				// å…µç²®å¯¸æ–­åŒºåŸŸ
				if (bingliangArea.length === 0) {
					bingliangContainer.innerHTML = '<div class="delay-card disabled">ç©º</div>';
				} else {
					bingliangArea.forEach(card => {
						const cardDiv = document.createElement('div');
						cardDiv.className = 'delay-card';
						cardDiv.textContent = `${card.name} ${card.suit}${getPointDisplay(card.point)}`;
						bingliangContainer.appendChild(cardDiv);
					});
				}

				// ä¹ä¸æ€èœ€åŒºåŸŸ
				if (lebuArea.length === 0) {
					lebuContainer.innerHTML = '<div class="delay-card disabled">ç©º</div>';
				} else {
					lebuArea.forEach(card => {
						const cardDiv = document.createElement('div');
						cardDiv.className = 'delay-card';
						cardDiv.textContent = `${card.name} ${card.suit}${getPointDisplay(card.point)}`;
						lebuContainer.appendChild(cardDiv);
					});
				}

				// é—ªç”µåŒºåŸŸ
				if (shandianArea.length === 0) {
					shandianContainer.innerHTML = '<div class="delay-card disabled">ç©º</div>';
				} else {
					shandianArea.forEach(card => {
						const cardDiv = document.createElement('div');
						cardDiv.className = 'delay-card';
						cardDiv.textContent = `${card.name} ${card.suit}${getPointDisplay(card.point)}`;
						shandianContainer.appendChild(cardDiv);
					});
				}
			}

			// å¤„ç†é¡ºæ‰‹ç‰µç¾Šæ•ˆæœ
			function handleShunshou(card, index) {
				// è·å–æ‰€æœ‰å¯è·å–çš„å»¶æ—¶é”¦å›Šï¼ˆå…µç²®å¯¸æ–­å’Œä¹ä¸æ€èœ€ï¼‰
				const delayCards = [...bingliangArea, ...lebuArea];

				// æ£€æŸ¥æ˜¯å¦æœ‰å¯è·å–çš„ç‰Œ
				if (delayCards.length > 0) {
					// æœ‰å»¶æ—¶é”¦å›Šï¼Œæ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
					showShunshouDialog(card, index, delayCards);
				} else {
					// æ²¡æœ‰å»¶æ—¶é”¦å›Šï¼Œç›´æ¥ä½¿ç”¨å¡ç‰Œå¹¶æ£€æŸ¥æ¸è¥
					useShunshou(card, index, false);
				}
			}

			// æ˜¾ç¤ºé¡ºæ‰‹ç‰µç¾Šé€‰æ‹©å¯¹è¯æ¡†
			function showShunshouDialog(card, index, delayCards) {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'card-selector-modal';
				dialog.innerHTML = `
			        <h3>é¡ºæ‰‹ç‰µç¾Š - é€‰æ‹©è¦è·å–çš„å»¶æ—¶é”¦å›Š</h3>
			        <p>è¯·é€‰æ‹©è¦è·å–çš„ç‰Œï¼ˆç‚¹å‡»å¡ç‰Œé€‰æ‹©ï¼‰ï¼š</p>
			        <div id="delayCardsContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;"></div>
			        <button id="noRemove" class="dialog-button" style="background:#C8E6C9;">
			            ä¸è·å–ï¼Œä»…ä½¿ç”¨æ•ˆæœ
			        </button>
			    `;

				// è·å–å¡ç‰Œå®¹å™¨
				const cardsContainer = dialog.querySelector('#delayCardsContainer');

				// æ·»åŠ æ¯å¼ å¯è·å–çš„å¡ç‰Œ
				delayCards.forEach((delayCard, i) => {
					const cardDiv = document.createElement('div');
					cardDiv.className = 'delay-card-selectable';
					cardDiv.innerHTML = `
			            <div>${delayCard.name}</div>
			            <div>${delayCard.suit}${getPointDisplay(delayCard.point)}</div>
			        `;

					// æ·»åŠ ç‚¹å‡»äº‹ä»¶
					cardDiv.addEventListener('click', () => {
						moveSpecificDelayCardToHand(delayCard);
						useShunshou(card, index, true); // trueè¡¨ç¤ºå·²è·å–ç‰Œ
						closeAllModals();
					});

					cardsContainer.appendChild(cardDiv);
				});

				// å…³é—­æ‰€æœ‰å¼¹çª—çš„å‡½æ•°
				const closeAllModals = () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
				};

				// "ä¸è·å–"æŒ‰é’®
				dialog.querySelector('#noRemove').addEventListener('click', () => {
					closeAllModals();
					useShunshou(card, index, false); // falseè¡¨ç¤ºæœªè·å–ç‰Œ
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// ç§»åŠ¨æŒ‡å®šçš„å»¶æ—¶é”¦å›Šåˆ°æ‰‹ç‰ŒåŒº
			function moveSpecificDelayCardToHand(delayCard) {
				// ç¡®å®šå¡ç‰Œåœ¨å“ªä¸ªåŒºåŸŸ
				let area = null;
				let index = -1;

				// æ£€æŸ¥å…µç²®å¯¸æ–­åŒº
				index = bingliangArea.findIndex(c => c.uid === delayCard.uid);
				if (index !== -1) {
					area = bingliangArea;
				}
				// æ£€æŸ¥ä¹ä¸æ€èœ€åŒº
				else {
					index = lebuArea.findIndex(c => c.uid === delayCard.uid);
					if (index !== -1) {
						area = lebuArea;
					}
				}

				// å¦‚æœæ‰¾åˆ°å¡ç‰Œï¼Œåˆ™ç§»å‡ºæ‰‹ç‰ŒåŒº
				if (area && index !== -1) {
					const removedCard = area.splice(index, 1)[0];
					hand.push(removedCard); // æ·»åŠ åˆ°ç©å®¶æ‰‹ç‰Œ
					log(`è·å–${removedCard.name}: ${removedCard.suit}${getPointDisplay(removedCard.point)}`);

					// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
					updateStatus();
				}
			}

			// ä½¿ç”¨é¡ºæ‰‹ç‰µç¾Šå¡ç‰Œ
			// movedCard: æ˜¯å¦å·²è·å–äº†ç‰Œ
			function useShunshou(card, index, movedCard) {
				// ä»æ‰‹ç‰Œç§»é™¤é¡ºæ‰‹ç‰µç¾Š
				const usedCard = hand.splice(index, 1)[0];

				// æ”¾å…¥å¼ƒç‰Œå †
				discardPile.push(usedCard);

				log(`ä½¿ç”¨é¡ºæ‰‹ç‰µç¾Š: ${usedCard.suit}${getPointDisplay(usedCard.point)}`);

				// å¦‚æœæ²¡æœ‰è·å–ç‰Œï¼Œéœ€è¦é¢å¤–æ‘¸ä¸€å¼ ç‰Œ
				if (!movedCard) {
					drawCards(1); // é¢å¤–æ‘¸ä¸€å¼ ç‰Œ
					log('æ²¡æœ‰è·å–ç‰Œï¼Œé¢å¤–æ‘¸ä¸€å¼ ç‰Œ');
				}

				// æ£€æŸ¥æ¸è¥æŠ€èƒ½
				if (lastUsedCard &&
					(usedCard.suit === lastUsedCard.suit ||
						usedCard.point === lastUsedCard.point)) {
					log('è§¦å‘æ¸è¥ï¼Œå†æ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}

				// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
				lastUsedCard = usedCard;

				// æ›´æ–°ç•Œé¢
				updateStatus();
				updateUI();
			}

			// å¤„ç†å»¶æ—¶é”¦å›Šç‰Œä½¿ç”¨
			function handleDelayCard(card, index) {
				let targetArea, areaName, maxCards;

				switch (card.name) {
					case "å…µç²®å¯¸æ–­":
						targetArea = bingliangArea;
						areaName = "å…µç²®å¯¸æ–­";
						maxCards = MAX_DELAY_CARDS;
						break;
					case "ä¹ä¸æ€èœ€":
						targetArea = lebuArea;
						areaName = "ä¹ä¸æ€èœ€";
						maxCards = MAX_DELAY_CARDS;
						break;
					case "é—ªç”µ":
						targetArea = shandianArea;
						areaName = "é—ªç”µ";
						maxCards = MAX_SHANDIAN;
						break;
					default:
						return false;
				}

				if (targetArea.length >= maxCards) {
					alert(`${areaName}å·²è¾¾ä¸Šé™ï¼ˆ${maxCards}å¼ ï¼‰ï¼Œæ— æ³•ä½¿ç”¨ï¼`);
					return true;
				}

				// ä»æ‰‹ç‰Œç§»é™¤
				const usedCard = hand.splice(index, 1)[0];

				// æ”¾å…¥çŠ¶æ€åŒº
				targetArea.push(usedCard);

				log(`ä½¿ç”¨${card.name}ï¼Œæ”¾å…¥${areaName}åŒº`);

				// æ›´æ–°çŠ¶æ€
				updateStatus();
				updateUI();

				// æ£€æŸ¥æŠ€èƒ½
				if (lastUsedCard &&
					(usedCard.suit === lastUsedCard.suit ||
						usedCard.point === lastUsedCard.point)) {
					log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}

				// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
				lastUsedCard = usedCard;

				return true;
			}

			// æ¸…ç©ºå»¶æ—¶é”¦å›ŠåŒº
			function clearDelayAreas() {
				if (bingliangArea.length > 0 || lebuArea.length > 0 || shandianArea.length > 0) {
					log(`ç»“æŸå‡ºç‰Œé˜¶æ®µï¼Œæ¸…ç©ºå»¶æ—¶é”¦å›ŠåŒº`);
				}

				// å…µç²®å¯¸æ–­åŒº
				bingliangArea.forEach(card => {
					discardPile.push(card);
					log(`å¼ƒç½®å…µç²®å¯¸æ–­: ${card.suit}${getPointDisplay(card.point)}`);
				});
				bingliangArea = [];

				// ä¹ä¸æ€èœ€åŒº
				lebuArea.forEach(card => {
					discardPile.push(card);
					log(`å¼ƒç½®ä¹ä¸æ€èœ€: ${card.suit}${getPointDisplay(card.point)}`);
				});
				lebuArea = [];

				// é—ªç”µåŒº
				shandianArea.forEach(card => {
					discardPile.push(card);
					log(`å¼ƒç½®é—ªç”µ: ${card.suit}${getPointDisplay(card.point)}`);
				});
				shandianArea = [];

				updateStatus();
			}

			// ç”Ÿæˆå®‰å…¨çš„éšæœºç´¢å¼•ï¼ˆç”¨äºæŠ½ç‰Œï¼‰
			function getSecureRandomIndex(max) {
				// æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåŠ å¯†å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
				if (window.crypto && typeof window.crypto.getRandomValues === 'function') {
					// åˆ›å»ºä¸€ä¸ªUint32Arrayæ¥å­˜å‚¨éšæœºå€¼
					const randomBuffer = new Uint32Array(1);

					// ä½¿ç”¨åŠ å¯†å®‰å…¨æ–¹æ³•å¡«å……éšæœºå€¼
					window.crypto.getRandomValues(randomBuffer);

					// è¿”å›0åˆ°maxä¹‹é—´çš„éšæœºç´¢å¼•
					return randomBuffer[0] % (max + 1);
				} else {
					// æµè§ˆå™¨ä¸æ”¯æŒå®‰å…¨éšæœºæ•°æ—¶ä½¿ç”¨Math.random
					return Math.floor(Math.random() * (max + 1));
				}
			}


			// ç”Ÿæˆæ ‡å‡†ç‰Œå †
			function generateStandardDeck() {
				const deck = []; // åˆ›å»ºç©ºç‰Œå †æ•°ç»„

				// éå†å¤–éƒ¨å®šä¹‰çš„standardDeckæ•°ç»„
				standardDeck.forEach(card => {
					// éå†æ¯å¼ å¡ç‰Œçš„èŠ±è‰²å­—ç¬¦ä¸²
					card.suits.forEach(suitStr => {
						// ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æèŠ±è‰²å’Œç‚¹æ•°
						const match = suitStr.match(/^([â™ â™¥â™£â™¦]ï¸?)([JQKA]|\d+)$/);
						if (match) {
							const suitPart = match[1]; // æå–èŠ±è‰²éƒ¨åˆ†
							let point = match[2]; // æå–ç‚¹æ•°éƒ¨åˆ†

							// å°†å­—æ¯ç‚¹æ•°è½¬æ¢ä¸ºæ•°å­—
							switch (point) {
								case 'J':
									point = 11;
									break;
								case 'Q':
									point = 12;
									break;
								case 'K':
									point = 13;
									break;
								case 'A':
									point = 1;
									break;
								default:
									point = parseInt(point, 10); // æ•°å­—ç›´æ¥è½¬æ¢
							}

							// æ ¹æ®å¡ç‰Œæ•°é‡åˆ›å»ºå¤šä¸ªå‰¯æœ¬
							for (let i = 0; i < card.count; i++) {
								// æ·»åŠ å¡ç‰Œå¯¹è±¡åˆ°ç‰Œå †
								deck.push({
									name: card.name, // å¡ç‰Œåç§°
									suit: suitPart, // èŠ±è‰²
									point: point, // ç‚¹æ•°ï¼ˆæ•°å­—ï¼‰
									uid: CryptoJS.lib.WordArray.random(16).toString() // å”¯ä¸€ID
								});
							}
						}
					});
				});

				return deck; // è¿”å›ç”Ÿæˆçš„ç‰Œå †
			}

			// æ›´æ–°å‰©ä½™å¡ç‰Œè®¡æ•°æ˜¾ç¤º
			function updateRemainingCounts() {
				// å®šä¹‰å¡ç‰Œåˆ†ç±»ç»“æ„
				const categories = {
					basic: {
						name: "åŸºæœ¬ç‰Œ",
						items: {}
					},
					trick: {
						name: "æ™®é€šé”¦å›Šç‰Œ",
						items: {}
					},
					ystrick: {
						name: "å»¶æ—¶é”¦å›Šç‰Œ",
						items: {}
					},
					weapon: {
						name: "æ­¦å™¨",
						items: {}
					},
					armor: {
						name: "é˜²å…·",
						items: {}
					},
					horse: {
						name: "åéª‘",
						items: {}
					},
					hl: {
						name: "çº¢åˆ©ç‰Œ",
						items: {}
					},
					ak: {
						name: "è¯¸è‘›è¿å¼©",
						items: {}
					},
					heil: {
						name: "é»‘åˆ©ç‰Œ",
						items: {}
					},
				};

				// éå†ç‰Œå †ä¸­çš„æ‰€æœ‰å¡ç‰Œ
				deck.forEach(card => {
					// ä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„cardCategoriesè¿›è¡Œåˆ†ç±»
					for (const [type, items] of Object.entries(cardCategories)) {
						// æ£€æŸ¥å½“å‰å¡ç‰Œæ˜¯å¦å±äºæ­¤åˆ†ç±»
						if (items.includes(card.name)) {
							// åˆå§‹åŒ–æˆ–å¢åŠ è¯¥å¡ç‰Œçš„è®¡æ•°
							categories[type].items[card.name] =
								(categories[type].items[card.name] || 0) + 1;
							break; // æ‰¾åˆ°åˆ†ç±»åè·³å‡ºå¾ªç¯
						}
					}
				});

				let html = ''; // åˆå§‹åŒ–HTMLå­—ç¬¦ä¸²

				// éå†æ‰€æœ‰åˆ†ç±»
				for (const category of Object.values(categories)) {
					// è·³è¿‡æ²¡æœ‰å¡ç‰Œçš„åˆ†ç±»
					if (Object.keys(category.items).length === 0) continue;

					// æ·»åŠ åˆ†ç±»æ ‡é¢˜
					html += `<div class="category"><div class="category-title">${category.name}</div>`;

					// å¯¹å¡ç‰Œåç§°æŒ‰ä¸­æ–‡æ’åº
					const sorted = Object.entries(category.items)
						.sort((a, b) => a[0].localeCompare(b[0], 'zh-Hans-CN'));

					// æ·»åŠ å¡ç‰Œè®¡æ•°é¡¹
					html += sorted.map(([name, count]) =>
						`<div class="count-item">${name}ï¼š${count}</div>`
					).join('');

					html += '</div>'; // å…³é—­åˆ†ç±»div
				}

				// æ›´æ–°DOMæ˜¾ç¤º
				document.getElementById('remaining-counts').innerHTML = html;
			}

			// æŠ½ç‰Œå‡½æ•°
			function drawCards(count) {
				// æ£€æŸ¥ç‰Œå †æ˜¯å¦ä¸ºç©º
				if (deck.length === 0) {
					alert("ç‰Œå †å·²ç©ºï¼Œæ— æ³•ç»§ç»­æŠ½ç‰Œï¼");
					return;
				}

				// å¦‚æœæŠ½ç‰Œæ•°å¤§äºå‰©ä½™ç‰Œæ•°ï¼Œè‡ªåŠ¨è°ƒæ•´
				if (deck.length < count) {
					alert(`ç‰Œå †ä»…å‰©${deck.length}å¼ ï¼Œè‡ªåŠ¨æŠ½å–å…¨éƒ¨`);
					count = deck.length;
				}

				// æŠ½å–æŒ‡å®šæ•°é‡çš„å¡ç‰Œ
				for (let i = 0; i < count; i++) {
					const drawnCard = deck.shift(); // ä»ç‰Œå †é¡¶éƒ¨å–å‡ºä¸€å¼ ç‰Œ
					drawnCards.push(drawnCard); // æ·»åŠ åˆ°å·²æŠ½å–å¡ç‰Œåˆ—è¡¨
					hand.push(drawnCard); // æ·»åŠ åˆ°ç©å®¶æ‰‹ç‰Œ
				}

				// æ›´æ–°ç•Œé¢
				updateRemaining(); // æ›´æ–°å‰©ä½™ç‰Œæ•°æ˜¾ç¤º
				updateUI(); // æ›´æ–°æ•´ä½“ç•Œé¢
			}

			// å±•ç¤ºå‰©ä½™ç‰Œå †è¯¦æƒ…
			function revealDeck() {
				const container = document.getElementById('remaining');
				container.innerHTML = '';

				const title = document.createElement('h3');
				title.textContent = `å‰©ä½™ç‰Œå †(${deck.length}å¼ )`;
				container.appendChild(title);

				// æ£€æŸ¥ç‰Œå †æ˜¯å¦ä¸ºç©º
				if (deck.length === 0) {
					container.innerHTML = `<h3>å‰©ä½™ç‰Œå † (0å¼ )</h3><p>ç‰Œå †å·²ç©º</p>`;
					return;
				}

				// æ˜¾ç¤ºç‰Œå †æ ‡é¢˜
				container.innerHTML = `<h3>å‰©ä½™ç‰Œå † (${deck.length}å¼ )</h3>`;

				// éå†ç‰Œå †ä¸­çš„æ¯å¼ ç‰Œ
				deck.forEach((card, index) => {
					// æ·»åŠ æ¯å¼ ç‰Œçš„è¯¦ç»†ä¿¡æ¯
					const cardDiv = document.createElement('div');
					cardDiv.className = 'card';
					cardDiv.textContent = `${index + 1}. ${card.name} ${card.suit}${getPointDisplay(card.point)}`;
					container.appendChild(cardDiv);
				});
			}

			// é«˜äº®æ˜¾ç¤ºè¯¸è‘›è¿å¼©ï¼ˆAKï¼‰
			function highlightZhugeLianNu() {
				const remainingCards = document.querySelectorAll('#remaining .card');

				// æ£€æŸ¥ç‰Œå †æ˜¯å¦ä¸ºç©º
				if (deck.length === 0) {
					alert("ç‰Œå †å·²ç©ºï¼Œæ²¡æœ‰è¯¸è‘›è¿å¼©ï¼");
					return;
				}

				// æ‰¾å‡ºæ‰€æœ‰AKç‰Œ
				const akCards = Array.from(remainingCards).filter(card =>
					card.textContent.includes('è¯¸è‘›è¿å¼©')
				);

				// ä¸ºAKç‰Œæ·»åŠ é«˜äº®æ ·å¼
				akCards.forEach(card => card.classList.add('highlight'));

				// è·å–AKç‰Œçš„ä½ç½®
				const indices = akCards.map(card =>
					Array.from(remainingCards).indexOf(card) + 1
				);

				// æ˜¾ç¤ºæç¤ºä¿¡æ¯
				indices.length > 0 ?
					alert(`è¯¸è‘›è¿å¼©ä½ç½®ï¼š${indices.join(', ')}`) :
					alert("å‰©ä½™ç‰Œå †ä¸­æ²¡æœ‰è¯¸è‘›è¿å¼©ï¼");
			}

			// æ›´æ–°å‰©ä½™ç‰Œæ•°æ˜¾ç¤º
			function updateRemaining() {
				// æ˜¾ç¤ºå‰©ä½™ç‰Œæ•°
				document.getElementById('remaining').innerHTML = `å‰©ä½™ç‰Œå †: ${deck.length}å¼ `;

				// æ›´æ–°å„ç±»å¡ç‰Œè®¡æ•°
				updateRemainingCounts();
			}



			// æ¸…ç©ºç‰Œå †æ˜¾ç¤º
			function clearDisplay() {
				document.getElementById('deck').innerHTML = '';
			}



			// å¼€å§‹æ¸¸æˆ
			function startGame() {
				drawInitialHand();
				phase = 'å‡†å¤‡'; // è®¾ç½®æ¸¸æˆé˜¶æ®µ

				// è®¾ç½®æŒ‰é’®çŠ¶æ€
				document.getElementById('drawBtn').disabled = false; // æ‘¸ç‰Œé˜¶æ®µå¯ç”¨
				document.getElementById('playBtn').disabled = true; // å‡ºç‰Œé˜¶æ®µç¦ç”¨

				// æ›´æ–°ç•Œé¢
				updateUI();
			}

			// åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
			function initializeButtons() {
				document.getElementById('drawBtn').disabled = false; // æ‘¸ç‰Œé˜¶æ®µå¯ç”¨
				document.getElementById('playBtn').disabled = true; // å‡ºç‰Œé˜¶æ®µç¦ç”¨
			}

			// æ‘¸ç‰Œé˜¶æ®µå¤„ç†
			function drawPhase() {
				// æ£€æŸ¥ç‰Œå †æ˜¯å¦ä¸ºç©º
				if (deck.length === 0) {
					alert("ç‰Œå †å·²ç©ºï¼Œæ— æ³•æ‘¸ç‰Œï¼");
					return;
				}

				// è®¾ç½®æ¸¸æˆé˜¶æ®µä¸º"æ‘¸ç‰Œ"
				phase = 'æ‘¸ç‰Œ';

				// æ‘¸3å¼ ç‰Œ
				drawCards(3);

				// æ›´æ–°æŒ‰é’®çŠ¶æ€
				document.getElementById('drawBtn').disabled = true; // ç¦ç”¨æ‘¸ç‰ŒæŒ‰é’®
				document.getElementById('playBtn').disabled = false; // å¯ç”¨å‡ºç‰ŒæŒ‰é’®

				// æ›´æ–°ç•Œé¢
				updateUI();
			}

			// å‡ºç‰Œé˜¶æ®µå¤„ç†
			function playPhase() {
				// è®¾ç½®æ¸¸æˆé˜¶æ®µä¸º"å‡ºç‰Œ"
				phase = 'å‡ºç‰Œ';

				// é‡ç½®æœ€åä½¿ç”¨çš„å¡ç‰Œ
				lastUsedCard = null;

				// æ›´æ–°æŒ‰é’®çŠ¶æ€
				document.getElementById('drawBtn').disabled = true; // ç¦ç”¨æ‘¸ç‰ŒæŒ‰é’®
				document.getElementById('playBtn').disabled = true; // ç¦ç”¨å‡ºç‰ŒæŒ‰é’®
				document.getElementById('endPlayBtn').disabled = false; // å¯ç”¨ç»“æŸå‡ºç‰ŒæŒ‰é’®

				// æ›´æ–°ç•Œé¢
				updateUI();
			}

			// ä½¿ç”¨å¡ç‰Œ
			function useCard(card, index) {
				// åªèƒ½åœ¨å‡ºç‰Œé˜¶æ®µä½¿ç”¨ç‰Œ
				if (phase !== 'å‡ºç‰Œ') return;

				// å»¶æ—¶é”¦å›Šä¸å‚ä¸æ— æ‡ˆå¯å‡»
				const isDelayTrick = ["å…µç²®å¯¸æ–­", "ä¹ä¸æ€èœ€", "é—ªç”µ"].includes(card.name);
				const isTrick = cardCategories.trick.includes(card.name);

				// æ›´æ–°ä¸Šä¸€å¼ ç‰Œçš„ä¿¡æ¯
				if (card) {
					previousCard = card;
					document.getElementById('previousCardInfo').textContent =
						`ä¸Šä¸€å¼ ç‰Œï¼š${card.name} ${card.suit}${getPointDisplay(card.point)}`;
				} else {
					previousCard = null;
					document.getElementById('previousCardInfo').textContent = 'ä¸Šä¸€å¼ ç‰Œï¼šç©º';
				}

				// å»¶æ—¶é”¦å›Šç‰Œå•ç‹¬å¤„ç†
				if (isDelayTrick) {
					handleDelayCard(card, index);
					return;
				}

				// ä¼¤å®³è®¡ç®—å‡½æ•°
				function handleKillDamage(killCard) {
				    // åŸºç¡€ä¼¤å®³å€¼
				    let damage = 0;
				
				    // æ ¹æ®æ€çš„ç±»å‹å†³å®šåŸºç¡€ä¼¤å®³
				    switch (killCard.name) {
				        case 'æ€':
				            damage = wineEffect ? 2 : 1;          // æ™®é€šæ€
				            break;
				        case 'é›·æ€':
				            damage = wineEffect ? 2 : 1;          // é›·æ€
				            break;
				        case 'ç«æ€':
				            damage = wineEffect ? 3 : 2;          // ç«æ€
				            break;
				        default:
				            damage = 0;
				    }
				
				    // å¤é”­åˆ€æ•ˆæœï¼šæ‰€æœ‰æ€çš„åŸºç¡€ä¼¤å®³+1
				    const baseDamageBonus = currentWeapon === 'å¤é”­åˆ€' ? 1 : 0;
				    damage += baseDamageBonus;
				
				    // æœ±é›€ç¾½æ‰‡æ•ˆæœï¼šä»…å¯¹æ™®é€šæ€ï¼ˆæ€ï¼‰ä¼¤å®³+1
				    if (currentWeapon === 'æœ±é›€ç¾½æ‰‡' && killCard.name === 'æ€') {
				        damage += 1;
				        log('æœ±é›€ç¾½æ‰‡ï¼šæ™®é€šæ€ä¼¤å®³+1');
				    }
				
				    // ç»“ç®—ä¼¤å®³
				    if (damage > 0) {
				        totalDamage += damage;
				        currentTurnDamage += damage;
				        log(`é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼ˆæ€»ä¼¤å®³ï¼š${totalDamage}ï¼Œå½“å‰å›åˆä¼¤å®³ï¼š${currentTurnDamage}ï¼‰`);
				
				        // è®°å½•å¤é”­åˆ€æ•ˆæœ
				        if (baseDamageBonus > 0) {
				            log(`å¤é”­åˆ€æ•ˆæœï¼šåŸºç¡€ä¼¤å®³+1`);
				        }
				    }
				
				    // é‡ç½®é…’æ•ˆæœ
				    wineEffect = false;
				}


				// é’é¾™åƒæœˆåˆ€ç‰¹æ®Šå¤„ç†
				if (card.name === 'æ€' && currentWeapon === 'é’é¾™åƒæœˆåˆ€') {
					startQinglongFlow(card, index);
					return;
				}

				// æ€ç±»å¡ç‰Œå¤„ç†
				if (['æ€', 'ç«æ€', 'é›·æ€'].includes(card.name)) {
					if (!hasZhugeLianNu && usedKillCount >= 2) {
						alert("æ€æ¬¡æ•°å·²ç”¨å°½ï¼");
						return;
					}

					// é›Œé›„åŒè‚¡å‰‘æ•ˆæœï¼šå‡ºæ€åæ‘¸ä¸€å¼ ç‰Œ
					if (currentWeapon === 'é›Œé›„åŒè‚¡å‰‘') {
						log('è§¦å‘é›Œé›„åŒè‚¡å‰‘æ•ˆæœï¼Œé¢å¤–æ‘¸ä¸€å¼ ç‰Œ');
						drawCards(1);
					}

					usedKillCount++;
					log(`ä½¿ç”¨${card.name}ï¼Œå·²ä½¿ç”¨æ€æ¬¡æ•°ï¼š${usedKillCount}`);

					const usedCard = hand.splice(index, 1)[0];
					discardPile.push(usedCard);

					// ç»Ÿä¸€ä¼¤å®³è®¡ç®—
					handleKillDamage(usedCard);

					// æ£€æŸ¥æ¸è¥
					if (lastUsedCard &&
						(usedCard.suit === lastUsedCard.suit || usedCard.point === lastUsedCard.point)) {
						log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
						drawCards(1);
					}

					lastUsedCard = usedCard;
					updateStatus();
					updateUI();
					return;
				}

				// ç«æ”»å•ç‹¬å¤„ç†
				if (card.name === "ç«æ”»") {
					resolveWuxie((shouldProceed) => {
						if (!shouldProceed) {
							discardPile.push(hand.splice(index, 1)[0]);
							log(`${card.name}è¢«æ— æ‡ˆå¯å‡»æŠµæ¶ˆ`);
							updateUI();
							return;
						}
						handleHuogong(card, index);
					});
					return;
				}

				// é€šç”¨é”¦å›Š & å…¶ä»–
				if (isTrick && !isDelayTrick && card.name !== "ç«æ”»") {
					resolveWuxie((shouldProceed) => {
						if (!shouldProceed) {
							discardPile.push(hand.splice(index, 1)[0]);
							log(`${card.name}è¢«æ— æ‡ˆå¯å‡»æŠµæ¶ˆ`);
							updateUI();
							return;
						}
						continueUseCard(card, index);
					});
				} else {
					continueUseCard(card, index);
				}
			}

			function handleKillDamage(card) {
				let damage = 0;
				switch (card.name) {
					case 'æ€':
					case 'é›·æ€':
						damage = wineEffect ? 2 : 1;
						break;
					case 'ç«æ€':
						damage = wineEffect ? 3 : 2;
						break;
				}
				if (damage > 0) {
					totalDamage += damage;
					currentTurnDamage += damage;
					log(`é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼ˆæ€»ä¼¤å®³ï¼š${totalDamage}ï¼Œå½“å‰å›åˆä¼¤å®³ï¼š${currentTurnDamage}ï¼‰`);
				}
				wineEffect = false;
			}

			function continueUseCard(card, index) {
				log(`ä½¿ç”¨å¡ç‰Œï¼š${card.name} ${card.suit}${getPointDisplay(card.point)}`);

				// æ­¦å™¨
				if (cardCategories.weapon.includes(card.name) || card.name === "è¯¸è‘›è¿å¼©") {
					if (currentWeapon && currentWeapon !== card.name && currentWeapon === "è¯¸è‘›è¿å¼©") {
						hasZhugeLianNu = false;
						killCount = 2;
						log(`å¸é™¤è¯¸è‘›è¿å¼©ï¼Œæ€æ¬¡æ•°é‡ç½®ä¸º2`);
					}
					currentWeapon = card.name;
					hasZhugeLianNu = (card.name === "è¯¸è‘›è¿å¼©");
					if (hasZhugeLianNu) log("è£…å¤‡è¯¸è‘›è¿å¼©ï¼Œæ€æ¬¡æ•°é™åˆ¶è§£é™¤");
				}

				// æ€ç±»å¡ç‰Œ
				if (['æ€', 'ç«æ€', 'é›·æ€'].includes(card.name)) {
					if (!hasZhugeLianNu && usedKillCount >= 2) {
						alert("æ€æ¬¡æ•°å·²ç”¨å°½ï¼");
						return;
					}
					usedKillCount++;
					log(`ä½¿ç”¨${card.name}ï¼Œå·²ä½¿ç”¨æ€æ¬¡æ•°ï¼š${usedKillCount}`);
				}

				// æ— ä¸­ç”Ÿæœ‰
				if (card.name === "æ— ä¸­ç”Ÿæœ‰") {
					log('ä½¿ç”¨æ— ä¸­ç”Ÿæœ‰ï¼Œé¢å¤–æ‘¸ä¸¤å¼ ç‰Œï¼');
					drawCards(2);
				}

				// è¿‡æ²³æ‹†æ¡¥ / é¡ºæ‰‹ç‰µç¾Š / å†³æ–— / å€Ÿåˆ€æ€äºº / äº”è°·ä¸°ç™» / é“ç´¢è¿ç¯
				if (card.name === "è¿‡æ²³æ‹†æ¡¥") {
					handleGuohe(card, index);
					return;
				}
				if (card.name === "é¡ºæ‰‹ç‰µç¾Š") {
					handleShunshou(card, index);
					return;
				}
				if (card.name === "å†³æ–—") {
					handleDuel(card, index);
					return;
				}
				if (card.name === "å€Ÿåˆ€æ€äºº") {
					showJiedaoDialog(card, index);
					return;
				}
				if (card.name === "äº”è°·ä¸°ç™»") {
					showWugufengdengDialog(card, index);
					return;
				}
				if (card.name === "é“ç´¢è¿ç¯") {
					showChainDialog(card, index);
					return;
				}

				// æ¡ƒ
				if (card.name === "æ¡ƒ") {
					if (peachCount <= 0) {
						alert("æ¡ƒä½¿ç”¨æ¬¡æ•°å·²è€—å°½ï¼");
						return;
					}
					peachCount--;
					log(`ä½¿ç”¨æ¡ƒï¼Œå‰©ä½™æ¬¡æ•°ï¼š${peachCount}`);
				}

				// é…’
				if (card.name === "é…’") {
					if (wineCount <= 0) {
						alert("é…’ä½¿ç”¨æ¬¡æ•°å·²è€—å°½ï¼");
						return;
					}
					wineCount--;
					wineEffect = true;
					log(`ä½¿ç”¨é…’ï¼Œä¸‹ä¸€å¼ æ€ä¼¤å®³+1`);
				}

				// ä¼¤å®³è®¡ç®—
				let damage = 0;
				switch (card.name) {
					case 'æ€':
					case 'é›·æ€':
						damage = wineEffect ? 2 : 1;
						wineEffect = false;
						break;
					case 'ç«æ€':
						damage = wineEffect ? 3 : 2;
						wineEffect = false;
						break;
					case 'å—è›®å…¥ä¾µ':
					case 'ä¸‡ç®­é½å‘':
						damage = 2;
						break;
				}
				if (damage > 0) {
					totalDamage += damage;
					currentTurnDamage += damage;
					log(`é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼ˆæ€»ä¼¤å®³ï¼š${totalDamage}ï¼Œå½“å‰å›åˆä¼¤å®³ï¼š${currentTurnDamage}ï¼‰`);
				}

				// æ¸è¥
				if (lastUsedCard && (card.suit === lastUsedCard.suit || card.point === lastUsedCard.point)) {
					log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}
				lastUsedCard = card;

				// ç§»é™¤æ‰‹ç‰Œ
				discardPile.push(hand.splice(index, 1)[0]);
				updateStatus();
				updateUI();
			}

			function startQinglongFlow(initialCard, initialIndex) {
				if (currentWeapon !== 'é’é¾™åƒæœˆåˆ€') {
					continueUseCard(initialCard, initialIndex);
					return;
				}

				/* 1. ç«‹å³æŠŠè¿™å¼ æ€ä»æ‰‹ç‰Œé‡Œæ‹¿æ‰ */
				const usedCard = hand.splice(initialIndex, 1)[0];
				discardPile.push(usedCard);

				/* 2. è®°å½•ä¸ºç¬¬ä¸€å¼ æ€ */
				qinglongActive = true;
				qinglongCards = [usedCard];
				qinglongWineBonus = wineEffect;
				wineEffect = false; // é…’æ•ˆæœå·²äº¤ç»™ç¬¬ä¸€å¼ æ€

				/* 3. æ›´æ–° lastUsedCard å¹¶è§¦å‘æ¸è¥ */
				if (lastUsedCard &&
					(usedCard.suit === lastUsedCard.suit || usedCard.point === lastUsedCard.point)) {
					log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}
				lastUsedCard = usedCard;

				/* 4. æ‰“å¼€å¼¹çª— */
				showQinglongDialog();
			}

			function showQinglongDialog(initialCard, initialIndex) {
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';
				overlay.style.zIndex = '10000';

				const dialog = document.createElement('div');
				dialog.className = 'qinglong-dialog';
				dialog.style = `
			        position: fixed;
			        top: 50%;
			        left: 50%;
			        transform: translate(-50%, -50%);
			        background: #ffecb3;
			        padding: 20px;
			        border-radius: 10px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10001;
			        min-width: 500px;
			        max-height: 80vh;
			        overflow-y: auto;
			        text-align: center;
			    `;

				const lastCard = qinglongCards[qinglongCards.length - 1];

				// æ„å»ºæç¤ºä¿¡æ¯
				let wineMessage = '';
				if (qinglongWineBonus) {
					wineMessage = 'æ‚¨å·²ä½¿ç”¨ä¸€å¼ ã€é…’ã€‘ï¼Œæœ¬å¼ æ€å°†è·å¾—ä¼¤å®³+1æ•ˆæœ';
				}

				// æ˜¾ç¤ºä¸Šä¸€å¼ ç‰Œä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
				let lastCardInfo = '';
				if (qinglongCards.length > 0) {
					const lastCard = qinglongCards[qinglongCards.length - 1];
					lastCardInfo = `
			            <div style="background: #fff3e0; padding: 10px; margin: 10px 0; border-radius: 5px;">
			                <strong>æœ€åä½¿ç”¨çš„æ€ï¼ˆç¬¬${qinglongCards.length}å¼ ï¼‰ï¼š</strong><br>
			                ${lastCard.name} ${lastCard.suit}${getPointDisplay(lastCard.point)}
			            </div>
			        `;
				}

				// è·å–å½“å‰å¯ä½¿ç”¨çš„æ€
				const availableKills = hand.filter(c => ['æ€', 'ç«æ€', 'é›·æ€'].includes(c.name));

				dialog.innerHTML = `
			        <h3 style="color:#d32f2f; margin-top:0;">é’é¾™åƒæœˆåˆ€æ•ˆæœ</h3>
			        <p style="color: #5d4037; font-weight: bold;">${wineMessage}</p>
			        ${lastCardInfo}
			        
			        <div style="margin: 20px 0;">
			            <h4>å½“å‰å·²ä½¿ç”¨æ€ï¼š${qinglongCards.length}</h4>
			            <div id="qinglongUsedCards" style="background: #fff8e1; padding: 10px; margin: 10px 0; border-radius: 5px;">
			                ${qinglongCards.length > 0 ? 
			                    `<div>æœ€åä¸€å¼ æ€: ${qinglongCards[qinglongCards.length-1].name} ${qinglongCards[qinglongCards.length-1].suit}${getPointDisplay(qinglongCards[qinglongCards.length-1].point)}</div>` 
			                    : '<div>å°šæœªä½¿ç”¨æ€</div>'
			                }
			            </div>
			        </div>
			        
			        <div style="margin: 20px 0;">
			            <h4>é€‰æ‹©ä¸‹ä¸€å¼ æ€ï¼š</h4>
			            <div id="killOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
			                ${availableKills.map((kill, idx) => `
			                    <button class="kill-option" data-index="${idx}" 
			                            style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer;">
			                        ${kill.name}<br>
			                        ${kill.suit}${getPointDisplay(kill.point)}
			                    </button>
			                `).join('')}
			            </div>
			        </div>
			        
			        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
			            <button id="endQinglong" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
			                ç»“æŸå‡ºæ€å¹¶ç»“ç®—
			            </button>
			        </div>
			    `;

				document.body.appendChild(overlay);
				document.body.appendChild(dialog);

				// ç»‘å®šæ€ç‰Œé€‰æ‹©äº‹ä»¶
				dialog.querySelectorAll('.kill-option').forEach(btn => {
					btn.addEventListener('click', () => {
						const idx = parseInt(btn.dataset.index);
						const selectedKill = availableKills[idx];

						// æ·»åŠ åˆ°å·²ä½¿ç”¨æ€åˆ—è¡¨
						qinglongCards.push(selectedKill);

						// ä»æ‰‹ç‰Œç§»é™¤
						const handIndex = hand.findIndex(c => c.uid === selectedKill.uid);
						if (handIndex !== -1) {
							hand.splice(handIndex, 1);
						}

						// æ£€æŸ¥æ¸è¥æŠ€èƒ½
						if (lastUsedCard && (selectedKill.suit === lastUsedCard.suit || selectedKill.point ===
								lastUsedCard.point)) {
							log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
							drawCards(1);
						}

						// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
						lastUsedCard = selectedKill;

						// é‡æ–°æ¸²æŸ“å¯¹è¯æ¡†
						closeQinglongDialog(overlay, dialog);
						showQinglongDialog(initialCard, initialIndex);
					});
				});

				// ç»‘å®šç»“æŸæŒ‰é’®äº‹ä»¶
				dialog.querySelector('#endQinglong').addEventListener('click', () => {
					closeQinglongDialog(overlay, dialog);
					finalizeQinglongEffect(initialCard, initialIndex);
				});
			}

			function closeQinglongDialog(overlay, dialog) {
				if (overlay && overlay.parentNode) {
					document.body.removeChild(overlay);
				}
				if (dialog && dialog.parentNode) {
					document.body.removeChild(dialog);
				}
			}

			function finalizeQinglongEffect(initialCard, initialIndex) {
				// è·å–æœ€åä¸€å¼ æ€
				const finalKill = qinglongCards[qinglongCards.length - 1];

				// è®¡ç®—ä¼¤å®³ï¼ˆä»…ç”±æœ€åä¸€å¼ æ€å†³å®šï¼‰
				let damage = 0;
				switch (finalKill.name) {
					case 'æ€':
					case 'é›·æ€':
						damage = 1;
						break;
					case 'ç«æ€':
						damage = 2;
						break;
				}

				// åªæœ‰ç¼–å·0çš„æ€å¯èƒ½äº«å—é…’åŠ æˆ
				if (qinglongWineBonus) {
					damage += 1;
					log('ä½¿ç”¨é…’åŠ æˆï¼Œä¼¤å®³+1');
				}

				// é€ æˆä¼¤å®³
				if (damage > 0) {
					totalDamage += damage;
					currentTurnDamage += damage;
					log(`é’é¾™åƒæœˆåˆ€æœ€ç»ˆä¼¤å®³ï¼š${damage}ç‚¹ï¼ˆæ¥è‡ªæ€ #${qinglongCards.length - 1}ï¼‰`);
				}

				// å°†åºåˆ—ä¸­çš„æ€ç§»å…¥å¼ƒç‰Œå †
				qinglongCards.forEach(card => {
					discardPile.push(card);
				});

				// è®¡å…¥ä¸€æ¬¡å‡ºæ€æ¬¡æ•°
				if (!hasZhugeLianNu) {
					usedKillCount++;
				}

				// æ›´æ–° lastUsedCard å’Œ previousCard
				lastUsedCard = finalKill;
				previousCard = finalKill;

				// é‡ç½®é’é¾™åƒæœˆåˆ€çŠ¶æ€
				qinglongActive = false;
				qinglongCards = [];
				qinglongWineBonus = false;

				// æ›´æ–°ç•Œé¢
				updateStatus();
				updateUI();


				previousCard = finalKill;
				document.getElementById('previousCardInfo').textContent =
					`ä¸Šä¸€å¼ ç‰Œï¼š${finalKill.name} ${finalKill.suit}${getPointDisplay(finalKill.point)}`;

			}

			// å¤„ç†ç«æ”»æ•ˆæœ
			function handleHuogong(card, index) {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'huogong-dialog';
				dialog.style = `
			        position: fixed;
			        top: 50%;
			        left: 50%;
			        transform: translate(-50%, -50%);
			        background: #ffecb3;
			        padding: 20px;
			        border-radius: 10px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10001;
			        min-width: 450px;
			        text-align: center;
			    `;

				// å¯¹è¯æ¡†å†…å®¹
				dialog.innerHTML = `
			        <h3 style="color:#d32f2f; margin-top:0;">ç«æ”»æ•ˆæœé€‰æ‹©</h3>
			        <p>è¯·é€‰æ‹©ç«æ”»çš„ç›®æ ‡ï¼š</p>
			        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
			            <button id="selfTarget" class="dialog-button" style="background:#4CAF50; padding: 10px 20px;">
			                å¯¹è‡ªå·±ä½¿ç”¨
			            </button>
			            <button id="otherTarget" class="dialog-button" style="background:#f44336; padding: 10px 20px;">
			                å¯¹ä»–äººä½¿ç”¨
			            </button>
			        </div>
			    `;

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);

				// å¯¹è‡ªå·±ä½¿ç”¨
				dialog.querySelector('#selfTarget').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					handleSelfHuogong(card, index);
				});

				// å¯¹ä»–äººä½¿ç”¨
				dialog.querySelector('#otherTarget').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					handleOtherHuogong(card, index);
				});

				// ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
				overlay.addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					// ç«æ”»æœªä½¿ç”¨ï¼Œéœ€è¦æ”¾å›æ‰‹ç‰Œ
					log("å–æ¶ˆäº†ç«æ”»æ•ˆæœ");
				});
			}

			// å¤„ç†å¯¹è‡ªå·±ä½¿ç”¨ç«æ”»
			function handleSelfHuogong(card, index) {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'huogong-options';
				dialog.style = `
			        position: fixed;
			        top: 50%;
			        left: 50%;
			        transform: translate(-50%, -50%);
			        background: #ffecb3;
			        padding: 20px;
			        border-radius: 10px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10001;
			        min-width: 450px;
			        text-align: center;
			    `;

				// å¯¹è¯æ¡†å†…å®¹
				dialog.innerHTML = `
			        <h3 style="color:#d32f2f; margin-top:0;">å¯¹è‡ªå·±ä½¿ç”¨ç«æ”»</h3>
			        <p>è¯·é€‰æ‹©æ•ˆæœï¼š</p>
			        <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
			            <button id="selfEnd" class="dialog-button" style="background:#4CAF50;">
			                ç»“æŸç»“ç®—ï¼šæ— äº‹å‘ç”Ÿ
			            </button>
			            <button id="selfDiscard" class="dialog-button" style="background:#f44336;">
			                å¼ƒç½®ä¸€å¼ æ‰‹ç‰Œï¼šæ¡ƒå¯ç”¨æ¬¡æ•°+1
			            </button>
			        </div>
			    `;

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);

				// ç»“æŸç»“ç®—é€‰é¡¹
				dialog.querySelector('#selfEnd').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					// ä»æ‰‹ç‰Œä¸­ç§»é™¤ç«æ”»
					const usedCard = hand.splice(index, 1)[0];
					discardPile.push(usedCard);
					log(`ä½¿ç”¨ç«æ”»ï¼ˆå¯¹è‡ªå·±ï¼‰ï¼šæ— äº‹å‘ç”Ÿ`);

					// æ£€æŸ¥æ¸è¥æŠ€èƒ½
					if (lastUsedCard &&
						(usedCard.suit === lastUsedCard.suit ||
							usedCard.point === lastUsedCard.point)) {
						log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
						drawCards(1);
					}

					// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
					lastUsedCard = usedCard;
					updateUI();
				});

				// å¼ƒç½®æ‰‹ç‰Œé€‰é¡¹
				dialog.querySelector('#selfDiscard').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					// ä»æ‰‹ç‰Œä¸­ç§»é™¤ç«æ”»
					const usedCard = hand.splice(index, 1)[0];
					discardPile.push(usedCard);
					log(`ä½¿ç”¨ç«æ”»ï¼ˆå¯¹è‡ªå·±ï¼‰ï¼šå¼ƒç½®ä¸€å¼ æ‰‹ç‰Œ`);

					// æ˜¾ç¤ºå¼ƒç‰Œé€‰æ‹©å¯¹è¯æ¡†
					showDiscardOptions(card, true);
				});
			}

			// å¤„ç†å¯¹ä»–äººä½¿ç”¨ç«æ”»
			function handleOtherHuogong(card, index) {
				// æ£€æŸ¥ç‰Œå †æ˜¯å¦ä¸ºç©º
				if (deck.length === 0) {
					alert("ç‰Œå †å·²ç©ºï¼Œæ— æ³•ä½¿ç”¨ç«æ”»ï¼");
					log("ç«æ”»å¤±è´¥ï¼šç‰Œå †å·²ç©º");
					return;
				}

				// äº®å‡ºç‰Œå †é¡¶çš„ä¸€å¼ ç‰Œ
				const revealedCard = deck.shift();
				log(`ç«æ”»äº®å‡ºç‰Œå †é¡¶ç‰Œï¼š${revealedCard.name} ${revealedCard.suit}${getPointDisplay(revealedCard.point)}`);

				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'huogong-options';
				dialog.style = `
			        position: fixed;
			        top: 50%;
			        left: 50%;
			        transform: translate(-50%, -50%);
			        background: #ffecb3;
			        padding: 20px;
			        border-radius: 10px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10001;
			        min-width: 450px;
			        text-align: center;
			    `;

				// å¯¹è¯æ¡†å†…å®¹
				dialog.innerHTML = `
			        <h3 style="color:#d32f2f; margin-top:0;">å¯¹ä»–äººä½¿ç”¨ç«æ”»</h3>
			        <div style="background:#ffd54f; padding: 10px; border-radius: 5px; margin: 10px 0;">
			            <p style="margin:0; font-weight:bold;">äº®å‡ºçš„ç‰Œï¼š</p>
			            <p style="margin:0; font-size: 24px;">
			                ${revealedCard.name} ${revealedCard.suit}${getPointDisplay(revealedCard.point)}
			            </p>
			        </div>
			        <p>è¯·é€‰æ‹©æ•ˆæœï¼š</p>
			        <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
			            <button id="otherEnd" class="dialog-button" style="background:#4CAF50;">
			                ç»“æŸç»“ç®—ï¼šæ— äº‹å‘ç”Ÿ
			            </button>
			            <button id="otherDiscard" class="dialog-button" style="background:#f44336;">
			                å¼ƒç½®ä¸€å¼ ${revealedCard.suit}èŠ±è‰²æ‰‹ç‰Œï¼šå›åˆä¼¤å®³+1
			            </button>
			        </div>
			    `;

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);

				// ç»“æŸç»“ç®—é€‰é¡¹
				dialog.querySelector('#otherEnd').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					// ä»æ‰‹ç‰Œä¸­ç§»é™¤ç«æ”»
					const usedCard = hand.splice(index, 1)[0];
					discardPile.push(usedCard);
					// äº®å‡ºçš„ç‰Œè¿›å…¥å¼ƒç‰Œå †
					discardPile.push(revealedCard);
					log(`ä½¿ç”¨ç«æ”»ï¼ˆå¯¹ä»–äººï¼‰ï¼šæ— äº‹å‘ç”Ÿ`);

					// æ£€æŸ¥æ¸è¥æŠ€èƒ½
					if (lastUsedCard &&
						(usedCard.suit === lastUsedCard.suit ||
							usedCard.point === lastUsedCard.point)) {
						log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
						drawCards(1);
					}

					// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
					lastUsedCard = usedCard;
					updateUI();
				});

				// å¼ƒç½®æ‰‹ç‰Œé€‰é¡¹
				dialog.querySelector('#otherDiscard').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					// ä»æ‰‹ç‰Œä¸­ç§»é™¤ç«æ”»
					const usedCard = hand.splice(index, 1)[0];
					discardPile.push(usedCard);
					// äº®å‡ºçš„ç‰Œè¿›å…¥å¼ƒç‰Œå †
					discardPile.push(revealedCard);
					log(`ä½¿ç”¨ç«æ”»ï¼ˆå¯¹ä»–äººï¼‰ï¼šéœ€å¼ƒç½®ä¸€å¼ ${revealedCard.suit}èŠ±è‰²æ‰‹ç‰Œ`);

					// æ˜¾ç¤ºå¼ƒç‰Œé€‰æ‹©å¯¹è¯æ¡†
					showDiscardOptions(card, false, revealedCard.suit);
				});
			}

			// æ˜¾ç¤ºå¼ƒç‰Œé€‰æ‹©å¯¹è¯æ¡†
			function showDiscardOptions(huogongCard, isSelf, requiredSuit = null) {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'discard-options';
				dialog.style = `
			        position: fixed;
			        top: 50%;
			        left: 50%;
			        transform: translate(-50%, -50%);
			        background: white;
			        padding: 20px;
			        border-radius: 10px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10001;
			        min-width: 450px;
			        text-align: center;
			    `;

				// å¯¹è¯æ¡†æ ‡é¢˜
				const title = isSelf ?
					"å¼ƒç½®ä¸€å¼ æ‰‹ç‰Œï¼ˆæ¡ƒå¯ç”¨æ¬¡æ•°+1ï¼‰" :
					`å¼ƒç½®ä¸€å¼ ${requiredSuit}èŠ±è‰²æ‰‹ç‰Œï¼ˆå›åˆä¼¤å®³+1ï¼‰`;

				dialog.innerHTML = `
			        <h3 style="color:#d32f2f; margin-top:0;">${title}</h3>
			        <p>è¯·é€‰æ‹©è¦å¼ƒç½®çš„æ‰‹ç‰Œï¼š</p>
			        <div id="handCardsContainer" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;"></div>
			        <button id="cancelDiscard" class="dialog-button" style="background:#9e9e9e;">
			            å–æ¶ˆå¼ƒç‰Œ
			        </button>
			    `;

				// è·å–æ‰‹ç‰Œå®¹å™¨
				const cardsContainer = dialog.querySelector('#handCardsContainer');

				// æ·»åŠ æ¯å¼ å¯å¼ƒç½®çš„æ‰‹ç‰Œ
				hand.forEach((card, i) => {
					// å¯¹ä»–äººä½¿ç”¨æ—¶éœ€è¦åŒ¹é…èŠ±è‰²
					if (!isSelf && card.suit !== requiredSuit) return;

					const cardDiv = document.createElement('div');
					cardDiv.className = 'discard-card';
					cardDiv.innerHTML = `
			            <div style="font-size: 18px; font-weight: bold;">${card.name}</div>
			            <div style="font-size: 24px;">${card.suit}${getPointDisplay(card.point)}</div>
			        `;

					// æ·»åŠ ç‚¹å‡»äº‹ä»¶
					cardDiv.addEventListener('click', () => {
						// å¼ƒç½®é€‰ä¸­çš„æ‰‹ç‰Œ
						const discardedCard = hand.splice(i, 1)[0];
						discardPile.push(discardedCard);
						log(
							`å¼ƒç½®æ‰‹ç‰Œï¼š${discardedCard.name} ${discardedCard.suit}${getPointDisplay(discardedCard.point)}`
						);

						// åº”ç”¨ç«æ”»æ•ˆæœ
						if (isSelf) {
							// å¯¹è‡ªå·±ä½¿ç”¨ï¼šæ¡ƒå¯ç”¨æ¬¡æ•°+1
							peachCount = Math.min(peachCount + 1, 3);
							log(`æ¡ƒå¯ç”¨æ¬¡æ•°+1ï¼ˆå½“å‰ï¼š${peachCount}ï¼‰`);
						} else {
							// å¯¹ä»–äººä½¿ç”¨ï¼šå›åˆä¼¤å®³+1
							currentTurnDamage++;
							totalDamage++;
							log(`å›åˆä¼¤å®³+1ï¼ˆå½“å‰å›åˆä¼¤å®³ï¼š${currentTurnDamage}ï¼Œæ€»ä¼¤å®³ï¼š${totalDamage}ï¼‰`);
						}

						// æ£€æŸ¥æ¸è¥æŠ€èƒ½ï¼ˆä½¿ç”¨ç«æ”»ç‰Œï¼‰
						if (lastUsedCard &&
							(huogongCard.suit === lastUsedCard.suit ||
								huogongCard.point === lastUsedCard.point)) {
							log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
							drawCards(1);
						}

						// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œï¼ˆç«æ”»ç‰Œï¼‰
						lastUsedCard = huogongCard;

						// å…³é—­å¯¹è¯æ¡†
						document.body.removeChild(overlay);
						document.body.removeChild(dialog);
						updateStatus();
						updateUI();
					});

					cardsContainer.appendChild(cardDiv);
				});

				// å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç‰Œ
				if (cardsContainer.children.length === 0) {
					cardsContainer.innerHTML = `<p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å¯å¼ƒç½®æ‰‹ç‰Œ</p>`;
				}

				// å–æ¶ˆå¼ƒç‰Œä½†ä»ä½¿ç”¨ç«æ”»
				dialog.querySelector('#cancelDiscard').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);

					// ç«æ”»å¡ç‰Œå·²ä»æ‰‹ç‰Œç§»é™¤å¹¶è¿›å…¥å¼ƒç‰Œå †ï¼ˆåœ¨æ›´æ—©é˜¶æ®µå·²å®Œæˆï¼‰
					log("å–æ¶ˆå¼ƒç‰Œï¼Œç«æ”»å·²ä½¿ç”¨ä½†ä¸é€ æˆä¼¤å®³");

					// æ£€æŸ¥æ¸è¥æŠ€èƒ½ï¼ˆä½¿ç”¨ç«æ”»ç‰Œï¼‰
					if (lastUsedCard &&
						(huogongCard.suit === lastUsedCard.suit ||
							huogongCard.point === lastUsedCard.point)) {
						log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
						drawCards(1);
					}

					// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œï¼ˆç«æ”»ç‰Œï¼‰
					lastUsedCard = huogongCard;

					updateUI();
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// æ˜¾ç¤ºä¸ˆå…«è›‡çŸ›å¯¹è¯æ¡†
			function showZhangbaDialog() {
				// ç¡®ä¿è‡³å°‘æœ‰ä¸¤å¼ æ‰‹ç‰Œ
				if (hand.length < 2) {
					alert("æ‰‹ç‰Œä¸è¶³ä¸¤å¼ ï¼Œæ— æ³•ä½¿ç”¨ä¸ˆå…«è›‡çŸ›æ•ˆæœï¼");
					return;
				}

				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';
				overlay.style.zIndex = '10000';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'zhangba-dialog';
				dialog.style.cssText = `
			        position: fixed;
			        top: 50%;
			        left: 50%;
			        transform: translate(-50%, -50%);
			        background: #ffecb3;
			        padding: 20px;
			        border-radius: 10px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10001;
			        min-width: 500px;
			        max-height: 80vh;
			        overflow-y: auto;
			        text-align: center;
			    `;

				dialog.innerHTML = `
			        <h3 style="color:#d32f2f; margin-top:0;">ä¸ˆå…«è›‡çŸ›æ•ˆæœ</h3>
			        <p>è¯·é€‰æ‹©ä¸¤å¼ æ‰‹ç‰Œå½“æ€ä½¿ç”¨ï¼š</p>
			        <div class="hand-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0;"></div>
			        <div style="text-align: center; margin-top: 20px;">
			            <button id="confirmZhangba" style="padding: 12px 24px; background: #4CAF50; color: white; margin-right: 10px;">ç¡®è®¤ä½¿ç”¨</button>
			            <button id="cancelZhangba" style="padding: 12px 24px; background: #f44336; color: white;">å–æ¶ˆ</button>
			        </div>
			    `;

				// è·å–æ‰‹ç‰Œå®¹å™¨
				const handContainer = dialog.querySelector('.hand-container');

			 // æ˜¾ç¤ºæ‰€æœ‰æ‰‹ç‰Œ
				hand.forEach((card, index) => {
					const cardDiv = document.createElement('div');
					cardDiv.className = 'card-selectable';
					cardDiv.style.cssText = `
			            border: 1px solid #ccc;
			            border-radius: 5px;
			            padding: 10px;
			            cursor: pointer;
			            background: white;
			            transition: all 0.2s;
			        `;
					cardDiv.innerHTML = `
			            <div>${card.name}</div>
			            <div>${card.suit}${getPointDisplay(card.point)}</div>
			        `;

					// ç‚¹å‡»é€‰æ‹©/å–æ¶ˆé€‰æ‹©
					cardDiv.addEventListener('click', () => {
						const cardIndex = selectedCards.indexOf(index);
						if (cardIndex === -1) {
							if (selectedCards.length < 2) {
								selectedCards.push(index);
								cardDiv.style.border = "3px solid red"; // é€‰ä¸­æ ·å¼
							}
						} else {
							selectedCards.splice(cardIndex, 1);
							cardDiv.style.border = "1px solid #ccc"; // æ¢å¤é»˜è®¤
						}
					});

					handContainer.appendChild(cardDiv);
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);

				// ç¡®è®¤æŒ‰é’®äº‹ä»¶
				dialog.querySelector('#confirmZhangba').addEventListener('click', () => {
					if (selectedCards.length !== 2) {
						alert("è¯·é€‰æ‹©ä¸¤å¼ æ‰‹ç‰Œï¼");
						return;
					}

					// ä½¿ç”¨ä¸¤å¼ æ‰‹ç‰Œå½“æ€
					useZhangbaAsKill();

					// å…³é—­å¯¹è¯æ¡†
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
				});

				// å–æ¶ˆæŒ‰é’®äº‹ä»¶
				dialog.querySelector('#cancelZhangba').addEventListener('click', () => {
					// æ¸…ç©ºé€‰æ‹©
					selectedCards = [];
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
				});
			}

			// ä½¿ç”¨ä¸¤å¼ æ‰‹ç‰Œå½“æ€
			function useZhangbaAsKill() {
				// æ£€æŸ¥æ€æ¬¡æ•°é™åˆ¶
				if (!hasZhugeLianNu && usedKillCount >= 2) {
					alert("æ€æ¬¡æ•°å·²ç”¨å°½ï¼");
					return;
				}

				// æ’åºé€‰æ‹©çš„æ‰‹ç‰Œç´¢å¼•ï¼ˆä»å¤§åˆ°å°ï¼Œé¿å…ç§»é™¤é”™è¯¯ï¼‰
				selectedCards.sort((a, b) => b - a);

				// ç§»é™¤ä¸¤å¼ æ‰‹ç‰Œ
				const cardsToUse = [];
				selectedCards.forEach(index => {
					cardsToUse.push(hand.splice(index, 1)[0]);
				});

				// æ·»åŠ åˆ°å¼ƒç‰Œå †
				discardPile.push(...cardsToUse);

				// è®°å½•æ—¥å¿—
				log(`ä½¿ç”¨ä¸ˆå…«è›‡çŸ›æ•ˆæœï¼šå°†ä¸¤å¼ æ‰‹ç‰Œå½“æ€ä½¿ç”¨`);

				// è®¡å…¥å‡ºæ€æ¬¡æ•°
				usedKillCount++;

			 // ä¼¤å®³è®¡ç®—ï¼ˆåŸºç¡€ä¼¤å®³1ï¼Œå¯å—é…’åŠ æˆï¼‰
				const damage = wineEffect ? 2 : 1;
				totalDamage += damage;
				currentTurnDamage += damage;

				// æ¸…ç©ºé…’æ•ˆæœ
				wineEffect = false;

				// æ˜¾ç¤ºä¸Šä¸€å¼ ä½¿ç”¨çš„å¡ç‰Œä¸ºç©ºï¼ˆå› ä¸ºæ˜¯ä¸¤å¼ ç‰Œå½“æ€ï¼‰
			 previousCard = null;
				document.getElementById('previousCardInfo').textContent = 'ä¸Šä¸€å¼ ç‰Œï¼šç©º';

			 // æ¸…ç©ºé€‰æ‹©
				selectedCards = [];

				// æ›´æ–°çŠ¶æ€
				updateStatus();
				updateUI();

				// è®°å½•ä¼¤å®³æ—¥å¿—
				log(`é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼ˆæ€»ä¼¤å®³ï¼š${totalDamage}ï¼Œå½“å‰å›åˆä¼¤å®³ï¼š${currentTurnDamage}ï¼‰`);
			}

			// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
			function updateStatus() {
				const counter = document.getElementById('kill-counter');
				const zhuge = document.getElementById('zhuge-status');

				// ç»Ÿä¸€æ˜¾ç¤ºæ ¼å¼ï¼šå‰©ä½™å¯ç”¨æ¬¡æ•° / å·²ä½¿ç”¨æ¬¡æ•°
				const remainingText = hasZhugeLianNu ? 'âˆ' : Math.max(0, 2 - usedKillCount);
				counter.textContent = `æ€å¯ç”¨æ¬¡æ•°ï¼š${remainingText}ï¼Œæœ¬å›åˆå·²ä½¿ç”¨æ€çš„ä¸ªæ•°ï¼š${usedKillCount}`;

				// æ›´æ–°å…¶å®ƒçŠ¶æ€
				document.getElementById('peach-counter').textContent = `æ¡ƒå¯ç”¨æ¬¡æ•°ï¼š${peachCount}`;
				document.getElementById('wine-counter').textContent = `é…’å¯ç”¨æ¬¡æ•°ï¼š${wineCount}`;
				const wineBuff = document.getElementById('wine-buff');
				wineBuff.textContent = wineEffect ? 'ä¸‹ä¸€å¼ æ€ä¼¤å®³+1' : 'å½“å‰æ— é…’åŠ æˆ';
				wineBuff.classList.toggle('active', wineEffect);

				document.getElementById('total-damage').textContent = `æ€»ä¼¤å®³: ${totalDamage}`;
				document.getElementById('turn-damage').textContent = `å½“å‰å›åˆä¼¤å®³: ${currentTurnDamage}`;
				zhuge.textContent = currentWeapon ? `å½“å‰æ­¦å™¨ï¼š${currentWeapon}` : "å½“å‰æ­¦å™¨ï¼šæ— ";

				document.getElementById('kill-counter').textContent =
					`æ€å¯ç”¨æ¬¡æ•°ï¼š${hasZhugeLianNu ? 'âˆ' : 2 - usedKillCount}ï¼Œæœ¬å›åˆå·²ä½¿ç”¨æ€çš„ä¸ªæ•°ï¼š${usedKillCount}`;

				// æ›´æ–°å»¶æ—¶é”¦å›Š
				updateDelayArea();

				// æ›´æ–°ä¸ˆå…«è›‡çŸ›æŒ‰é’®çŠ¶æ€
				updateWeaponButton();
			}

			// è£…å¤‡æ­¦å™¨æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
			function updateWeaponButton() {
				const btn = document.getElementById('zhangbaBtn');
				btn.style.display = (currentWeapon === 'ä¸ˆå…«è›‡çŸ›') ? 'block' : 'none';

			 // æ£€æŸ¥æ€æ¬¡æ•°é™åˆ¶ï¼šå½“æ€æ¬¡æ•°ç”¨å°½æ—¶ç¦ç”¨æŒ‰é’®ï¼ˆé™¤éè£…å¤‡è¯¸è‘›è¿å¼©ï¼‰
				if (currentWeapon === 'ä¸ˆå…«è›‡çŸ›') {
					btn.disabled = (!hasZhugeLianNu && usedKillCount >= 2);
					if (btn.disabled) {
						btn.style.opacity = "0.6"; // ç¦ç”¨æ—¶å˜æš—
					} else {
						btn.style.opacity = "1.0"; // å¯ç”¨æ—¶æ¢å¤
					}
				}
			}

			// ç»“ç®—æ— æ‡ˆå¯å‡»
			function resolveWuxie(callback) {
				const wuxieCards = hand.filter(c => c.name === 'æ— æ‡ˆå¯å‡»');
				if (wuxieCards.length === 0) {
					callback(true); // æ²¡æœ‰æ— æ‡ˆï¼Œé”¦å›Šç”Ÿæ•ˆ
					return;
				}

				let useCount = 0;

				function promptNext() {
					const remaining = hand.filter(c => c.name === 'æ— æ‡ˆå¯å‡»');
					if (remaining.length === 0) {
						callback(useCount % 2 === 0); // å¶æ•°ç”Ÿæ•ˆï¼Œå¥‡æ•°å¤±æ•ˆ
						return;
					}

					// ä¿®æ”¹ç‚¹ï¼šæ·»åŠ useCountå‚æ•°
					showWuxieDialog(remaining, useCount, (usedCard) => {
						if (!usedCard) {
							callback(useCount % 2 === 0); // ç”¨æˆ·é€‰æ‹©ä¸å†ä½¿ç”¨
							return;
						}

						// ä½¿ç”¨æ— æ‡ˆå¯å‡»
						const idx = hand.findIndex(c => c.uid === usedCard.uid);
						if (idx !== -1) {
							discardPile.push(hand.splice(idx, 1)[0]);
							log(`ä½¿ç”¨æ— æ‡ˆå¯å‡»: ${usedCard.suit}${getPointDisplay(usedCard.point)}`);
							useCount++;

							// è§¦å‘æ¸è¥
							if (lastUsedCard && (usedCard.suit === lastUsedCard.suit || usedCard.point === lastUsedCard
									.point)) {
								log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
								drawCards(1);
							}
							lastUsedCard = usedCard;
						}

						promptNext(); // é€’å½’ç»§ç»­
					});
				}

				promptNext();
			}

			function showWuxieDialog(wuxieCards, useCount, callback) {
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				const dialog = document.createElement('div');
				dialog.className = 'card-selector-modal';

				// æ·»åŠ çŠ¶æ€æç¤ºä¿¡æ¯
				dialog.innerHTML = `
			        <h3>æ˜¯å¦ä½¿ç”¨æ— æ‡ˆå¯å‡»ï¼Ÿ</h3>
			        <div style="background:#f9f9f9; padding:8px; margin-bottom:10px; border-radius:5px; border:1px solid #eee;">
			            <p style="margin:0; color:#FF5722; font-weight:bold;">
			                å·²ä½¿ç”¨ç¬¬<span id="wuxie-count">${useCount}</span>å¼ æ— æ‡ˆå¯å‡»
			            </p>
			            <p style="margin:5px 0 0; font-size:14px;">
			                å½“å‰é”¦å›ŠçŠ¶æ€: <strong>${useCount % 2 === 0 ? "ç”Ÿæ•ˆ" : "å¤±æ•ˆ"}</strong>
			            </p>
			        </div>
			        <div class="card-options">
			            ${wuxieCards.map((c, i) => `
			                <button class="wuxie-card" data-index="${i}">
			                    ${c.suit}${getPointDisplay(c.point)}
			                </button>
			            `).join('')}
			        </div>
			        <button class="dialog-button" id="stopWuxie">ä¸å†ä½¿ç”¨æ— æ‡ˆå¯å‡»</button>
			    `;

				document.body.appendChild(overlay);
				document.body.appendChild(dialog);

				dialog.querySelectorAll('.wuxie-card').forEach(btn => {
					btn.addEventListener('click', () => {
						const idx = parseInt(btn.dataset.index);
						document.body.removeChild(overlay);
						document.body.removeChild(dialog);
						callback(wuxieCards[idx]);
					});
				});

				dialog.querySelector('#stopWuxie').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					callback(null); // ä¸å†ä½¿ç”¨
				});

				overlay.addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					callback(null);
				});
			}

			// å†³æ–—å‡½æ•°
			function handleDuel(card, index) {
				// ä»æ‰‹ç‰Œç§»é™¤å†³æ–—å¡ç‰Œ
				const duelCard = hand.splice(index, 1)[0];
				discardPile.push(duelCard);
				log(`ä½¿ç”¨å†³æ–—: ${duelCard.suit}${getPointDisplay(duelCard.point)}`);

				// æ£€æŸ¥æ¸è¥æŠ€èƒ½ï¼ˆä½¿ç”¨å†³æ–—æœ¬èº«ï¼‰
				if (lastUsedCard && (duelCard.suit === lastUsedCard.suit || duelCard.point === lastUsedCard.point)) {
					log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}

				// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œä¸ºå†³æ–—
				lastUsedCard = duelCard;

				// æ˜¾ç¤ºå†³æ–—å¯¹è¯æ¡†
				showDuelDialog();
			}

			// å†³æ–—å¯¹è¯æ¡†å‡½æ•°
			function showDuelDialog() {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'duel-dialog';
				dialog.style = `
			          position: fixed;
			          top: 50%;
			          left: 50%;
			          transform: translate(-50%, -50%);
			          background: #ffecb3;
			          padding: 20px;
			          border-radius: 10px;
			          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			          z-index: 10001;
			          min-width: 450px;
			          text-align: center;
			      `;

				// è·å–æ‰€æœ‰æ€ç±»å¡ç‰Œ
				const killCards = hand.filter(card => ['æ€', 'ç«æ€', 'é›·æ€'].includes(card.name));

				// å¯¹è¯æ¡†å†…å®¹
				dialog.innerHTML = `
			          <h3 style="color:#d32f2f; margin-top:0;">å†³æ–—ç»“ç®—</h3>
			          <p>è¯·é€‰æ‹©è¦æ‰“å‡ºçš„æ€ç‰Œï¼ˆç‚¹å‡»å¡ç‰Œé€‰æ‹©ï¼‰ï¼š</p>
			          <div class="card-options" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
			              ${killCards.length > 0 ? 
			                  killCards.map((card, i) => `
			                      <div class="duel-card" data-index="${i}">
			                          <div style="font-size: 18px; font-weight: bold;">${card.name}</div>
			                          <div style="font-size: 24px;">${card.suit}${getPointDisplay(card.point)}</div>
			                      </div>
			                  `).join('') : 
			                  '<p>æ‰‹ç‰Œä¸­æ²¡æœ‰æ€ç±»å¡ç‰Œ</p>'
			              }
			          </div>
			          <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
			              <button id="addPeach" class="dialog-button" style="background:#4CAF50; padding: 10px 20px;">
			                  æ¡ƒ+1ï¼ˆä½ å—åˆ°å†³æ–—çš„ä¼¤å®³ï¼‰
			              </button>
			              <button id="addDamage" class="dialog-button" style="background:#f44336; padding: 10px 20px;">
			                  ä¼¤å®³+1ï¼ˆå…¶ä»–è§’è‰²å—åˆ°äº†ä¼¤å®³ï¼‰
			              </button>
			          </div>
			      `;

				// æ·»åŠ å¡ç‰Œç‚¹å‡»äº‹ä»¶
				if (killCards.length > 0) {
					dialog.querySelectorAll('.duel-card').forEach(cardDiv => {
						cardDiv.addEventListener('click', function() {
							const cardIndex = parseInt(this.dataset.index);
							const selectedCard = killCards[cardIndex];

							// ä»æ‰‹ç‰Œä¸­ç§»é™¤
							const handIndex = hand.findIndex(c => c.uid === selectedCard.uid);
							if (handIndex !== -1) {
								discardPile.push(hand.splice(handIndex, 1)[0]);
								log(
									`å› å†³æ–—æ‰“å‡ºæ€: ${selectedCard.name} ${selectedCard.suit}${getPointDisplay(selectedCard.point)}`
								);
							}

							// é‡æ–°æ¸²æŸ“å¯¹è¯æ¡†ï¼ˆç»§ç»­å†³æ–—ç»“ç®—ï¼‰
							document.body.removeChild(overlay);
							document.body.removeChild(dialog);
							showDuelDialog();
						});
					});
				}

				// æ¡ƒ+1æŒ‰é’®
				dialog.querySelector('#addPeach').addEventListener('click', () => {
					peachCount = Math.min(peachCount + 1, 3);
					log(`å†³æ–—ç»ˆæ­¢ï¼Œæ¡ƒå¯ç”¨æ¬¡æ•°+1ï¼ˆå½“å‰: ${peachCount}ï¼‰`);
					closeDuelDialog(overlay, dialog);
				});

				// ä¼¤å®³+1æŒ‰é’®
				dialog.querySelector('#addDamage').addEventListener('click', () => {
					totalDamage++;
					currentTurnDamage++;
					log(`å†³æ–—ç»ˆæ­¢ï¼Œä¼¤å®³+1ï¼ˆæ€»ä¼¤å®³: ${totalDamage}ï¼Œå½“å‰å›åˆä¼¤å®³: ${currentTurnDamage}ï¼‰`);
					closeDuelDialog(overlay, dialog);
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);

				// æ·»åŠ å¡ç‰Œæ‚¬åœæ•ˆæœ
				if (killCards.length > 0) {
					dialog.querySelectorAll('.duel-card').forEach(card => {
						card.addEventListener('mouseenter', () => {
							card.style.transform = 'translateY(-5px)';
							card.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
						});
						card.addEventListener('mouseleave', () => {
							card.style.transform = 'none';
							card.style.boxShadow = 'none';
						});
					});
				}
			}

			// å…³é—­å†³æ–—å¯¹è¯æ¡†
			function closeDuelDialog(overlay, dialog) {
				document.body.removeChild(overlay);
				document.body.removeChild(dialog);
				updateStatus();
				updateUI();
			}

			//äº”è°·ä¸°ç™»å¯¹è¯æ¡†
			function showWugufengdengDialog(card, index) {
				// æ£€æŸ¥ç‰Œå †æ˜¯å¦è¶³å¤Ÿ
				if (deck.length < 3) {
					alert(`ç‰Œå †ä¸è¶³3å¼ ï¼Œæ— æ³•ä½¿ç”¨äº”è°·ä¸°ç™»ï¼å½“å‰ç‰Œå †: ${deck.length}å¼ `);
					return;
				}

				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';
				overlay.style.zIndex = '10000';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'wugufengdeng-dialog';
				dialog.style = `
			        position: fixed;
			        top: 50%;
			        left: 50%;
			        transform: translate(-50%, -50%);
			        background: #ffecb3;
			        padding: 20px;
			        border-radius: 10px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10001;
			        min-width: 350px;
			        text-align: center;
			    `;

				// æ·»åŠ æ ‡é¢˜
				dialog.innerHTML = `
			        <h3 style="color:#5d4037; margin-top:0;">äº”è°·ä¸°ç™» - è¯·é€‰æ‹©ä¸€å¼ ç‰Œ</h3>
			        <div class="card-options" style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
			            <!-- å¡ç‰Œé€‰é¡¹å°†ç”±JSåŠ¨æ€æ·»åŠ  -->
			        </div>
			        <p style="color:#795548;">å‰©ä½™ä¸¤å¼ ç‰Œå°†ç½®å…¥å¼ƒç‰Œå †</p>
			    `;

				// ä»ç‰Œå †é¡¶éƒ¨å–ä¸‰å¼ ç‰Œ
				const cardsToShow = deck.slice(0, 3);
				const cardOptions = dialog.querySelector('.card-options');

				// åˆ›å»ºä¸‰å¼ ç‰Œçš„é€‰é¡¹
				cardsToShow.forEach((cardObj, i) => {
					const cardDiv = document.createElement('div');
					cardDiv.className = 'wugufengdeng-card';
					cardDiv.style = `
			            border: 2px solid #8d6e63;
			            border-radius: 8px;
			            padding: 15px;
			            background: #fff8e1;
			            cursor: pointer;
			            transition: all 0.3s;
			            min-width: 100px;
			        `;

					cardDiv.innerHTML = `
			            <div style="font-size: 18px; font-weight: bold; color:#5d4037;">${cardObj.name}</div>
			            <div style="font-size: 24px;">${cardObj.suit}${getPointDisplay(cardObj.point)}</div>
			            <div style="font-size: 14px; color:#8d6e63;">ç‚¹å‡»é€‰æ‹©</div>
			        `;

					cardDiv.addEventListener('click', () => handleWugufengdengSelection(card, index, i, cardsToShow));
					cardDiv.addEventListener('mouseenter', () => {
						cardDiv.style.transform = 'translateY(-5px)';
						cardDiv.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
					});
					cardDiv.addEventListener('mouseleave', () => {
						cardDiv.style.transform = 'none';
						cardDiv.style.boxShadow = 'none';
					});

					cardOptions.appendChild(cardDiv);
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// å¤„ç†äº”è°·ä¸°ç™»é€‰æ‹©
			function handleWugufengdengSelection(wugufengdengCard, handIndex, selectedIndex, shownCards) {
				// å…³é—­æ‰€æœ‰å¯¹è¯æ¡†
				document.querySelectorAll('.modal-backdrop, .wugufengdeng-dialog').forEach(el => el.remove());

				// é€‰ä¸­çš„å¡ç‰Œ
				const selectedCard = shownCards[selectedIndex];

				// ä»ç‰Œå †ä¸­ç§»é™¤å±•ç¤ºçš„ä¸‰å¼ ç‰Œ
				const removedCards = deck.splice(0, 3);

				// æ·»åŠ é€‰ä¸­çš„ç‰Œåˆ°ç©å®¶æ‰‹ç‰Œ
				hand.push(selectedCard);
				log(`äº”è°·ä¸°ç™»è·å¾—: ${selectedCard.name} ${selectedCard.suit}${getPointDisplay(selectedCard.point)}`);

				// å…¶ä½™ä¸¤å¼ ç‰Œç½®å…¥å¼ƒç‰Œå †
				shownCards.forEach((card, i) => {
					if (i !== selectedIndex) {
						discardPile.push(card);
						log(`å¼ƒç½®: ${card.name} ${card.suit}${getPointDisplay(card.point)}`);
					}
				});

				// ä»æ‰‹ç‰Œä¸­ç§»é™¤äº”è°·ä¸°ç™»
				const usedCard = hand.splice(handIndex, 1)[0];
				discardPile.push(usedCard);
				log(`ä½¿ç”¨äº”è°·ä¸°ç™»`);

				// æ£€æŸ¥æ¸è¥æŠ€èƒ½
				if (lastUsedCard && (wugufengdengCard.suit === lastUsedCard.suit || wugufengdengCard.point === lastUsedCard
						.point)) {
					log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}

				// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
				lastUsedCard = wugufengdengCard;

				// æ›´æ–°ç•Œé¢
				updateUI();
				updateRemaining();

				// æ˜¾ç¤ºæ“ä½œåé¦ˆ
				showFeedback(`å·²é€‰æ‹©: ${selectedCard.name}`);
			}

			// æ·»åŠ åé¦ˆæ¶ˆæ¯å‡½æ•°
			function showFeedback(message) {
				const feedback = document.createElement('div');
				feedback.textContent = message;
				feedback.style = `
			        position: fixed;
			        top: 20px;
			        left: 50%;
			        transform: translateX(-50%);
			        padding: 12px 25px;
			        background: #4CAF50;
			        color: white;
			        border-radius: 30px;
			        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			        z-index: 10000;
			        font-weight: bold;
			        animation: fadeInOut 2.5s forwards;
			    `;

				// æ·»åŠ æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
				const style = document.createElement('style');
				style.textContent = `
			        @keyframes fadeInOut {
			            0% { opacity: 0; top: 10px; }
			            20% { opacity: 1; top: 20px; }
			            80% { opacity: 1; top: 20px; }
			            100% { opacity: 0; top: 10px; }
			        }
			    `;
				document.head.appendChild(style);

				document.body.appendChild(feedback);

				// 2.5ç§’åç§»é™¤
				setTimeout(() => {
					if (document.body.contains(feedback)) {
						document.body.removeChild(feedback);
					}
				}, 2500);
			}


			// é“ç´¢è¿ç¯å¡ç‰Œæ•ˆæœé€‰æ‹©å¯¹è¯æ¡†
			function showChainDialog(card, index) {
				// åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
				const dialog = document.createElement('div');
				dialog.style = `
					position: fixed;
					top: 50%;
					left: 50%;
					transform: translate(-50%, -50%);
					background: white;
					padding: 20px;
					border: 2px solid #666;
					z-index: 10000;
					box-shadow: 0 0 10px rgba(0,0,0,0.5);
				`;

				// å¯¹è¯æ¡†å†…å®¹
				dialog.innerHTML = `
					<h3>é“ç´¢è¿ç¯æ•ˆæœé€‰æ‹©</h3>
					<p>è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œï¼š</p>
					<button id="func1" style="margin:5px; padding:8px; background:#BBDEFB;">åŠŸèƒ½1ï¼šé‡é“¸æ‘¸ç‰Œ</button>
					<button id="func2" style="margin:5px; padding:8px; background:#C8E6C9;">åŠŸèƒ½2ï¼šä½¿ç”¨æ£€ç´¢</button>
					<button id="cancel" style="margin:5px; padding:8px; background:#FFCDD2;">å–æ¶ˆ</button>
				`;

				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.style = `
					position: fixed;
					top: 0;
					left: 0;
					right: 0;
					bottom: 0;
					background: rgba(0,0,0,0.5);
					z-index: 9999;
				`;

				// åŠŸèƒ½1ï¼šé‡é“¸æ‘¸ç‰Œ
				dialog.querySelector('#func1').addEventListener('click', () => {
					// ä»æ‰‹ç‰Œç§»é™¤é“ç´¢è¿ç¯
					hand.splice(index, 1);

					// åŠ å…¥å¼ƒç‰Œå †
					discardPile.push(card);

					// æ‘¸ä¸€å¼ ç‰Œ
					drawCards(1);

					// è®°å½•æ—¥å¿—
					log(`é‡é“¸é“ç´¢è¿ç¯ï¼Œæ‘¸1å¼ ç‰Œ`);

					// å…³é—­å¯¹è¯æ¡†
					cleanupDialog();
				});

				// åŠŸèƒ½2ï¼šä½¿ç”¨æ£€ç´¢
				dialog.querySelector('#func2').addEventListener('click', () => {
					// æ£€æŸ¥æ¸è¥æŠ€èƒ½æ˜¯å¦è§¦å‘
					if (lastUsedCard && (card.suit === lastUsedCard.suit || card.point === lastUsedCard.point)) {
						log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
						drawCards(1);
					}

					// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
					lastUsedCard = card;

					// ä»æ‰‹ç‰Œç§»é™¤å¹¶åŠ å…¥å¼ƒç‰Œå †
					discardPile.push(hand.splice(index, 1)[0]);

					// è®°å½•æ—¥å¿—
					log(`ä½¿ç”¨é“ç´¢è¿ç¯ï¼ŒèŠ±è‰²${card.suit} ç‚¹æ•°${getPointDisplay(card.point)}`);

					// å…³é—­å¯¹è¯æ¡†
					cleanupDialog();
				});

				// å–æ¶ˆæŒ‰é’®
				dialog.querySelector('#cancel').addEventListener('click', cleanupDialog);

				// å…³é—­å¯¹è¯æ¡†çš„å‡½æ•°
				function cleanupDialog() {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
					updateUI(); // æ›´æ–°ç•Œé¢
				}

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// å€Ÿåˆ€æ€äººå¡ç‰Œæ•ˆæœé€‰æ‹©å¯¹è¯æ¡†
			function showJiedaoDialog(card, index) {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'card-selector-modal';
				dialog.innerHTML = `
					<h3>å€Ÿåˆ€æ€äººæ•ˆæœé€‰æ‹©</h3>
					<p>è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œï¼š</p>
					<div style="display: flex; flex-direction: column; gap: 10px;">
						<button id="func1" class="dialog-button" style="background:#BBDEFB;">åŠŸèƒ½1ï¼šæ£€ç´¢æ­¦å™¨</button>
						<button id="func2" class="dialog-button" style="background:#C8E6C9;">åŠŸèƒ½2ï¼šä½¿ç”¨é—ª</button>
						<button id="cancel" class="dialog-button cancel" style="background:#FFCDD2;">å–æ¶ˆ</button>
					</div>
				`;

				// å…³é—­æ‰€æœ‰å¼¹çª—çš„å‡½æ•°
				const closeAllModals = () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
				};

				// åŠŸèƒ½1ï¼šæ£€ç´¢æ­¦å™¨
				dialog.querySelector('#func1').addEventListener('click', () => {
					closeAllModals(); // å…³é—­å½“å‰å¯¹è¯æ¡†

					// è·å–ç‰Œå †ä¸­çš„æ‰€æœ‰æ­¦å™¨ç‰Œ
					const weaponCards = deck.filter(c => cardCategories.weapon.includes(c.name));

					// æ£€æŸ¥æ˜¯å¦æœ‰æ­¦å™¨ç‰Œ
					if (weaponCards.length === 0) {
						alert("ç‰Œå †ä¸­æ²¡æœ‰æ­¦å™¨ç‰Œï¼");
						return;
					}

					// è·å–ç¬¬ä¸€å¼ æ­¦å™¨ç‰Œï¼ˆéšæœºé€‰æ‹©æ›´åˆç†ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
					const weaponCard = weaponCards[0];

					// åœ¨ç‰Œå †ä¸­æŸ¥æ‰¾è¯¥æ­¦å™¨ç‰Œçš„ä½ç½®
					const deckIndex = deck.findIndex(c => c.uid === weaponCard.uid);

					// å®‰å…¨éªŒè¯
					if (deckIndex === -1) {
						console.error(`æ­¦å™¨ç‰Œ ${weaponCard.name} ä¸å­˜åœ¨äºç‰Œå †ä¸­`);
						return;
					}

					// ä»ç‰Œå †ä¸­ç§»é™¤æ­¦å™¨ç‰Œ
					const [removed] = deck.splice(deckIndex, 1);

					// æ·»åŠ åˆ°æ‰‹ç‰Œ
					hand.push(removed);

					// è®°å½•æ—¥å¿—
					log(`æ£€ç´¢è·å¾—æ­¦å™¨ï¼š${removed.name} ${removed.suit}${getPointDisplay(removed.point)}`);

					// å®Œæˆå€Ÿåˆ€æ€äººæ•ˆæœ
					finalizeJiedao(card, index);
				});

				// åŠŸèƒ½2ï¼šä½¿ç”¨é—ª
				dialog.querySelector('#func2').addEventListener('click', () => {
					closeAllModals(); // å…³é—­å½“å‰å¯¹è¯æ¡†

					// è·å–æ‰‹ç‰Œä¸­çš„æ‰€æœ‰é—ªç‰Œ
					const shanCards = hand.filter(c => c.name === "é—ª");

					// æ£€æŸ¥æ˜¯å¦æœ‰é—ªç‰Œ
					if (shanCards.length === 0) {
						// æ²¡æœ‰é—ªç‰Œæ—¶æ˜¾ç¤ºç‰¹æ®Šå¯¹è¯æ¡†
						showNoShanDialog(card, index);
					} else {
						// æœ‰é—ªç‰Œæ—¶æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
						showShanSelection(shanCards, card, index);
					}

					// å®Œæˆå€Ÿåˆ€æ€äººæ•ˆæœ
					finalizeJiedao(card, index);
				});

				// å–æ¶ˆæŒ‰é’®
				dialog.querySelector('#cancel').addEventListener('click', () => {
					closeAllModals();
					log("å–æ¶ˆä½¿ç”¨å€Ÿåˆ€æ€äºº");
				});

				// ç‚¹å‡»èƒŒæ™¯å…³é—­
				overlay.addEventListener('click', (e) => {
					if (e.target === overlay) {
						closeAllModals();
						log("å–æ¶ˆä½¿ç”¨å€Ÿåˆ€æ€äºº");
					}
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// æ²¡æœ‰é—ªç‰Œæ—¶çš„å¯¹è¯æ¡†
			function showNoShanDialog(card, index) {
				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'card-selector-modal';
				dialog.innerHTML = `
					<h3>æ²¡æœ‰é—ªç‰Œ</h3>
					<p>è¯·é€‰æ‹©åç»­æ“ä½œï¼š</p>
					<button class="dialog-button" id="cancelUse">å–æ¶ˆä½¿ç”¨</button>
					<button class="dialog-button" id="noShan">åšæŒä¸å‡ºé—ª</button>
				`;

				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// å–æ¶ˆä½¿ç”¨æŒ‰é’®
				dialog.querySelector('#cancelUse').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);
				});

				// åšæŒä¸å‡ºé—ªæŒ‰é’®
				dialog.querySelector('#noShan').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);

					// å¢åŠ æ¡ƒä½¿ç”¨æ¬¡æ•°ï¼ˆæœ€å¤š3æ¬¡ï¼‰
					peachCount = Math.min(peachCount + 1, 3);
					log(`ä¸å‡ºé—ªï¼Œæ¡ƒå¯ç”¨æ¬¡æ•°+1ï¼Œå½“å‰ï¼š${peachCount}`);

					// å®Œæˆå€Ÿåˆ€æ€äººæ•ˆæœ
					finalizeJiedao(card, index);
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// é€‰æ‹©è¦ä½¿ç”¨çš„é—ªç‰Œå¯¹è¯æ¡†
			function showShanSelection(shanCards, card, index) {
				// åˆ›å»ºå¯¹è¯æ¡†
				const dialog = document.createElement('div');
				dialog.className = 'card-selector-modal';
				dialog.innerHTML = `
					<h3>é€‰æ‹©è¦ä½¿ç”¨çš„é—ªç‰Œ</h3>
					<div id="shanList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
						${shanCards.map((c, i) => `
							<button class="shan-card" data-index="${i}">
								${c.suit}${getPointDisplay(c.point)}
							</button>
						`).join('')}
					</div>
					<button class="dialog-button cancel" id="cancelShan">å–æ¶ˆä½¿ç”¨é—ª</button>
				`;

				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const overlay = document.createElement('div');
				overlay.className = 'modal-backdrop';

				// é—ªç‰Œé€‰æ‹©äº‹ä»¶
				dialog.querySelectorAll('.shan-card').forEach(btn => {
					btn.addEventListener('click', (e) => {
						// è·å–é€‰ä¸­çš„é—ªç‰Œç´¢å¼•
						const idx = parseInt(e.target.dataset.index);
						const selectedCard = shanCards[idx];

						// åœ¨æ‰‹ç‰Œä¸­æŸ¥æ‰¾è¯¥é—ªç‰Œ
						const handIndex = hand.findIndex(c => c.uid === selectedCard.uid);

						// å¦‚æœæ‰¾åˆ°åˆ™ä½¿ç”¨è¯¥é—ªç‰Œ
						if (handIndex > -1) {
							const [removed] = hand.splice(handIndex, 1);
							discardPile.push(removed);
							log(`ä½¿ç”¨é—ªç‰Œï¼š${removed.suit}${getPointDisplay(removed.point)}`);
						}

						// å…³é—­å¯¹è¯æ¡†
						document.body.removeChild(overlay);
						document.body.removeChild(dialog);

						// å®Œæˆå€Ÿåˆ€æ€äººæ•ˆæœ
						finalizeJiedao(card, index);
					});
				});

				// å–æ¶ˆä½¿ç”¨é—ªæŒ‰é’®
				dialog.querySelector('#cancelShan').addEventListener('click', () => {
					document.body.removeChild(overlay);
					document.body.removeChild(dialog);

					// å¢åŠ æ¡ƒä½¿ç”¨æ¬¡æ•°ï¼ˆæœ€å¤š3æ¬¡ï¼‰
					peachCount = Math.min(peachCount + 1, 3);
					log(`å–æ¶ˆä½¿ç”¨é—ªï¼Œæ¡ƒå¯ç”¨æ¬¡æ•°+1ï¼Œå½“å‰ï¼š${peachCount}`);

					// å®Œæˆå€Ÿåˆ€æ€äººæ•ˆæœ
					finalizeJiedao(card, index);
				});

				// æ·»åŠ å…ƒç´ åˆ°DOM
				document.body.appendChild(overlay);
				document.body.appendChild(dialog);
			}

			// å®Œæˆå€Ÿåˆ€æ€äººæ•ˆæœ
			function finalizeJiedao(card, index) {
				// ä»æ‰‹ç‰Œä¸­ç§»é™¤å€Ÿåˆ€æ€äººå¡ç‰Œ
				const jiedaoCard = hand.splice(index, 1)[0];
				discardPile.push(jiedaoCard);

				// æ£€æŸ¥æ¸è¥æŠ€èƒ½
				if (lastUsedCard &&
					(jiedaoCard.suit === lastUsedCard.suit ||
						jiedaoCard.point === lastUsedCard.point)) {
					log('è§¦å‘æ¸è¥ï¼Œæ‘¸ä¸€å¼ ç‰Œï¼');
					drawCards(1);
				}

				// æ›´æ–°æœ€åä½¿ç”¨çš„å¡ç‰Œ
				lastUsedCard = jiedaoCard;

				// æ›´æ–°ç•Œé¢å’ŒçŠ¶æ€
				updateUI();
				updateStatus();
			}

			// æ¸…ç†æ‰€æœ‰å¯¹è¯æ¡†
			function cleanupDialog() {
				// é€‰æ‹©æ‰€æœ‰æ¨¡æ€èƒŒæ™¯å’Œå¯¹è¯æ¡†
				const dialogs = document.querySelectorAll('.modal-backdrop, .card-selector-modal');

				// ç§»é™¤å®ƒä»¬
				dialogs.forEach(dialog => dialog.remove());
			}

			// æ›´æ–°æ¸¸æˆç•Œé¢
			function updateUI() {
				// æ›´æ–°é˜¶æ®µä¿¡æ¯
				const stageInfo = document.getElementById('stageInfo');
				if (stageInfo) {
					stageInfo.textContent = `å½“å‰é˜¶æ®µï¼š${phase}é˜¶æ®µ`;
				}

				// æ›´æ–°æ‰‹ç‰Œæ˜¾ç¤º
				const handDiv = document.getElementById('hand');
				handDiv.innerHTML = '<h3>æ‰‹ç‰Œ</h3>';

				// éå†æ‰‹ç‰Œ
				hand.forEach((card, i) => {
					const div = document.createElement('div');
					div.className = 'card';

					// æ€ç±»å¡ç‰Œç¦ç”¨æ£€æŸ¥
					if (['æ€', 'ç«æ€', 'é›·æ€'].includes(card.name)) {
						if (!hasZhugeLianNu && usedKillCount >= 2) {
							div.classList.add('disabled');
						}
					}


					// æ¡ƒç¦ç”¨æ£€æŸ¥
					if (card.name === "æ¡ƒ" && peachCount <= 0) {
						div.classList.add('disabled');
					}

					// é…’ç¦ç”¨æ£€æŸ¥
					if (card.name === "é…’" && wineCount <= 0) {
						div.classList.add('disabled');
					}

					// é—ªç¦ç”¨å¤„ç†
					if (card.name === 'é—ª') {
						div.classList.add('disabled');
						div.onclick = () => alert("å‡ºç‰Œé˜¶æ®µæ— æ³•ä½¿ç”¨é—ªï¼");
					}

					// æ— æ‡ˆå¯å‡»ç¦ç”¨å¤„ç†
					if (card.name === 'æ— æ‡ˆå¯å‡»') {
						div.classList.add('disabled');
						div.onclick = () => alert("å‡ºç‰Œé˜¶æ®µæ— æ³•ä½¿ç”¨æ— æ‡ˆå¯å‡»");
					}

					// å»¶æ—¶é”¦å›Šç‰Œç¦ç”¨æ£€æŸ¥
					if (card.name === "å…µç²®å¯¸æ–­" && bingliangArea.length >= MAX_DELAY_CARDS) {
						div.classList.add('disabled');
						div.onclick = () => alert("å…µç²®å¯¸æ–­å·²è¾¾ä¸Šé™ï¼Œæ— æ³•ä½¿ç”¨ï¼");
					}

					if (card.name === "ä¹ä¸æ€èœ€" && lebuArea.length >= MAX_DELAY_CARDS) {
						div.classList.add('disabled');
						div.onclick = () => alert("ä¹ä¸æ€èœ€å·²è¾¾ä¸Šé™ï¼Œæ— æ³•ä½¿ç”¨ï¼");
					}

					if (card.name === "é—ªç”µ" && shandianArea.length >= MAX_SHANDIAN) {
						div.classList.add('disabled');
						div.onclick = () => alert("é—ªç”µå·²è¾¾ä¸Šé™ï¼Œæ— æ³•ä½¿ç”¨ï¼");
					}


					// è®¾ç½®å¡ç‰Œå†…å®¹
					div.innerHTML = `${card.name}<br>${card.suit}${getPointDisplay(card.point)}`;

					// æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆç¦ç”¨å¡ç‰Œé™¤å¤–ï¼‰
					if (!div.classList.contains('disabled')) {
						div.onclick = () => useCard(card, i);
					}

					// æ·»åŠ åˆ°æ‰‹ç‰ŒåŒºåŸŸ
					handDiv.appendChild(div);
				});

				// æ›´æ–°æŒ‰é’®çŠ¶æ€
				document.getElementById('playBtn').disabled = phase !== 'æ‘¸ç‰Œ';
				document.getElementById('endPlayBtn').disabled = phase !== 'å‡ºç‰Œ';
			}

			// ç»“æŸå‡ºç‰Œé˜¶æ®µ
			function endPlayPhase() {
				// è®¾ç½®æ¸¸æˆé˜¶æ®µä¸ºå‡†å¤‡é˜¶æ®µ
				phase = 'å‡†å¤‡';

				// é‡ç½®æœ€åä½¿ç”¨çš„å¡ç‰Œ
				lastUsedCard = null;

				// é‡ç½®å½“å‰å›åˆä¼¤å®³å’Œé…’æ•ˆæœ
				currentTurnDamage = 0;
				wineEffect = false;

				// é‡ç½®æœ¬å›åˆå·²ä½¿ç”¨æ€æ¬¡æ•°
				usedKillCount = 0;

				qinglongActive = false;
				qinglongCards = [];
				qinglongWineBonus = false;


				// æ¸…ç©ºå‰ä¸€å¼ ç‰Œä¿¡æ¯
				previousCard = null;
				document.getElementById('previousCardInfo').textContent = 'ä¸Šä¸€å¼ ç‰Œï¼šç©º';

				// æ›´æ–°æŒ‰é’®çŠ¶æ€
				document.getElementById('drawBtn').disabled = false; // å¯ç”¨æ‘¸ç‰ŒæŒ‰é’®
				document.getElementById('endPlayBtn').disabled = true; // ç¦ç”¨ç»“æŸå‡ºç‰ŒæŒ‰é’®
				document.getElementById('playBtn').disabled = true; // ç¦ç”¨å‡ºç‰ŒæŒ‰é’®

				// æ­¦å™¨çŠ¶æ€å¤„ç†
				if (currentWeapon !== "è¯¸è‘›è¿å¼©") {
					hasZhugeLianNu = false;
				}

				// é‡ç½®é…’ä½¿ç”¨æ¬¡æ•°
				wineCount = 1;

				// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
				updateStatus();

				// é‡ç½®ä¸ˆå…«è›‡çŸ›æŒ‰é’®çŠ¶æ€
				updateWeaponButton();

				// æ¸…ç©ºå»¶æ—¶é”¦å›ŠåŒº
				clearDelayAreas();

				// æ›´æ–°ç•Œé¢
				updateUI();

				// è®°å½•æ—¥å¿—
				log("å·²ç»“æŸå‡ºç‰Œé˜¶æ®µ");
			}

			// æ·»åŠ æ•´ç†æ‰‹ç‰ŒåŠŸèƒ½
			document.getElementById('organizeHandBtn').addEventListener('click', function() {
				const button = this;

				// æ£€æŸ¥å†·å´çŠ¶æ€
				if (button.disabled) return;

				// è®¾ç½®æŒ‰é’®ä¸ºç¦ç”¨çŠ¶æ€ï¼ˆå†·å´ä¸­ï¼‰
				button.disabled = true;
				button.textContent = 'å†·å´ä¸­...';
				button.style.backgroundColor = '#999';

				// æ•´ç†æ‰‹ç‰Œ
				organizeHand();

				// æ›´æ–°UI
				updateUI();

				// 3ç§’åæ¢å¤æŒ‰é’®
				setTimeout(() => {
					button.disabled = false;
					button.textContent = 'æ•´ç†æ‰‹ç‰Œ';
					button.style.backgroundColor = '#4CAF50';
				}, 3000);
			});

			// æ•´ç†æ‰‹ç‰Œå‡½æ•°
			function organizeHand() {
				// å®šä¹‰æ’åºä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
				const priority = {
					'è¯¸è‘›è¿å¼©': 0,
					'æ€': 1,
					'ç«æ€': 1,
					'é›·æ€': 1,
					'é…’': 2,
					'æ¡ƒ': 5,
					'é—ª': 6,
					'æ— æ‡ˆå¯å‡»': 7
				};

				// é”¦å›Šç‰Œä¼˜å…ˆçº§ï¼ˆæ•°å€¼åœ¨3-4ä¹‹é—´ï¼‰
				const trickCards = [
					'æ— ä¸­ç”Ÿæœ‰', 'è¿‡æ²³æ‹†æ¡¥', 'é¡ºæ‰‹ç‰µç¾Š', 'å†³æ–—', 'å€Ÿåˆ€æ€äºº',
					'å—è›®å…¥ä¾µ', 'ä¸‡ç®­é½å‘', 'äº”è°·ä¸°ç™»', 'æ¡ƒå›­ç»“ä¹‰', 'é“ç´¢è¿ç¯',
					'ç«æ”»', 'å…µç²®å¯¸æ–­', 'ä¹ä¸æ€èœ€', 'é—ªç”µ'
				];

				// è£…å¤‡ç‰Œä¼˜å…ˆçº§ï¼ˆæ•°å€¼åœ¨4-5ä¹‹é—´ï¼‰
				const equipmentCards = [
					'é’é¾™åƒæœˆåˆ€', 'ä¸ˆå…«è›‡çŸ›', 'è´¯çŸ³æ–§', 'æ–¹å¤©ç”»æˆŸ', 'éº’éºŸå¼“',
					'é›Œé›„åŒè‚¡å‰‘', 'å¯’å†°å‰‘', 'é’é‡­å‰‘','å¤é”­åˆ€','éª…éª',
					'æœ±é›€ç¾½æ‰‡', 'å…«å¦é˜µ', 'ä»ç‹ç›¾', 'ç™½é“¶ç‹®å­', 'è—¤ç”²',
					'èµ¤å…”', 'å¤§å®›', 'çˆªé»„é£ç”µ', 'çš„å¢', 'ç»å½±', 'ç´«éª'
				];

				// å¯¹æ¯å¼ ç‰Œåˆ†é…ä¼˜å…ˆçº§å’Œåç§°æ’åºé”®
				hand.forEach(card => {
					// å·²ç»å®šä¹‰ä¼˜å…ˆçº§çš„å¡ç‰Œ
					if (priority.hasOwnProperty(card.name)) {
						card.sortPriority = priority[card.name];
						card.nameSortKey = card.name; // ç”¨äºåŒåæ’åº
					}
					// é”¦å›Šç‰Œ
					else if (trickCards.includes(card.name)) {
						card.sortPriority = 3;
						card.nameSortKey = card.name; // ç”¨äºåŒåæ’åº
					}
					// è£…å¤‡ç‰Œï¼ˆé™¤è¯¸è‘›è¿å¼©å¤–ï¼‰
					else if (equipmentCards.includes(card.name)) {
						card.sortPriority = 4;
						card.nameSortKey = card.name; // ç”¨äºåŒåæ’åº
					}
					// æœªåˆ†ç±»çš„å¡ç‰Œï¼ˆä¼˜å…ˆçº§æœ€ä½ï¼‰
					else {
						card.sortPriority = 8;
						card.nameSortKey = card.name; // ç”¨äºåŒåæ’åº
					}
				});

				// æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œç„¶åæŒ‰åç§°åˆ†ç»„
				const groupedHand = {};

				// é¦–å…ˆæŒ‰ä¼˜å…ˆçº§åˆ†ç»„
				hand.forEach(card => {
					if (!groupedHand[card.sortPriority]) {
						groupedHand[card.sortPriority] = [];
					}
					groupedHand[card.sortPriority].push(card);
				});

				// å¯¹æ¯ä¸ªä¼˜å…ˆçº§ç»„å†…çš„ç‰ŒæŒ‰åç§°åˆ†ç»„
				Object.keys(groupedHand).forEach(priority => {
					const samePriorityGroup = {};

					// æŒ‰åç§°åˆ†ç»„
					groupedHand[priority].forEach(card => {
						if (!samePriorityGroup[card.nameSortKey]) {
							samePriorityGroup[card.nameSortKey] = [];
						}
						samePriorityGroup[card.nameSortKey].push(card);
					});

					// å¯¹åŒåç§°çš„ç‰ŒæŒ‰èŠ±è‰²å’Œç‚¹æ•°æ’åº
					const sortedGroups = [];
					Object.keys(samePriorityGroup).sort().forEach(nameKey => {
						// å¯¹åŒä¸€åç§°çš„ç‰Œè¿›è¡Œæ’åº
						samePriorityGroup[nameKey].sort((a, b) => {
							// æŒ‰èŠ±è‰²æ’åº
							const suits = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
							const suitA = suits.indexOf(a.suit);
							const suitB = suits.indexOf(b.suit);
							if (suitA !== suitB) {
								return suitA - suitB;
							}

							// æŒ‰ç‚¹æ•°æ’åº
							return a.point - b.point;
						});

						// å°†æ’åºåçš„åŒåç‰Œç»„æ·»åŠ åˆ°ç»“æœä¸­
						sortedGroups.push(...samePriorityGroup[nameKey]);
					});

					// æ›´æ–°å½“å‰ä¼˜å…ˆçº§ç»„çš„ç‰Œ
					groupedHand[priority] = sortedGroups;
				});

				// é‡æ–°ç»„åˆæ‰‹ç‰Œï¼šæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼Œç„¶åæŒ‰åç§°æ’åº
				hand = [];
				Object.keys(groupedHand).sort((a, b) => a - b).forEach(priority => {
					hand.push(...groupedHand[priority]);
				});

				// è®°å½•æ—¥å¿—
				log("å·²æ•´ç†æ‰‹ç‰Œ");
			}
			// å¼ƒç½®å¡ç‰Œ
			function discardCard(card) {
				// å¦‚æœå¼ƒç½®çš„æ˜¯è¯¸è‘›è¿å¼©
				if (card.name === "è¯¸è‘›è¿å¼©") {
					// é‡ç½®è¯¸è‘›è¿å¼©çŠ¶æ€
					hasZhugeLianNu = false;

					// è®°å½•æ—¥å¿—
					log("å¤±å»è¯¸è‘›è¿å¼©ï¼Œæ¢å¤æ¬¡æ•°é™åˆ¶");

					// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
					updateStatus();
				}
			}

			// æ›´æ–°é¡¶éƒ¨æ“ä½œæ å ä½ç¬¦é«˜åº¦
			function updateHeaderPlaceholder() {
				// è·å–é¡¶éƒ¨æ“ä½œæ å’Œå ä½å…ƒç´ 
				const header = document.querySelector('.header');
				const placeholder = document.querySelector('.header-placeholder');

				// ç¡®ä¿å…ƒç´ å­˜åœ¨
				if (header && placeholder) {
					// è®¡ç®—é«˜åº¦ï¼ˆæ“ä½œæ é«˜åº¦ + 5pxç¼“å†²ï¼‰
					const height = header.offsetHeight + 5;

					// è®¾ç½®å ä½å…ƒç´ é«˜åº¦
					placeholder.style.height = `${height}px`;
				}
			}

			// é¡µé¢åŠ è½½å’Œçª—å£å¤§å°å˜åŒ–æ—¶æ›´æ–°å ä½ç¬¦
			window.addEventListener('DOMContentLoaded', updateHeaderPlaceholder);
			window.addEventListener('resize', updateHeaderPlaceholder);

			// æ£€æµ‹æ˜¯å¦Windowsç³»ç»Ÿ
			function isWindowsOS() {
				// æ£€æŸ¥ç”¨æˆ·ä»£ç†æ˜¯å¦åŒ…å«"Win"å…³é”®è¯
				return navigator.userAgent.indexOf('Win') > -1;
			}

			// ç”Ÿæˆå®‰å…¨æ—¥å¿—å†…å®¹
			function generateSecurityLog() {
				// æ ¼å¼åŒ–å½“å‰æ—¶é—´
				const timeStamp = new Date().toISOString()
					.replace(/T/, ' ') // å°†Tæ›¿æ¢ä¸ºç©ºæ ¼
					.replace(/\..+/, ''); // ç§»é™¤æ¯«ç§’éƒ¨åˆ†

				// ç”Ÿæˆç‰Œå †è¯¦ç»†ä¿¡æ¯
				const deckDetails = deck.map((card, index) =>
					`[${index + 1}] ${card.name} - èŠ±è‰²:${card.suit} ç‚¹æ•°:${getPointDisplay(card.point)} UID:${card.uid}`
				).join('\n'); // æ¯å¼ å¡ä¿¡æ¯ä¸€è¡Œ

				// æ„å»ºæ—¥å¿—å†…å®¹
				return `æ²®çˆ¹çº¢åˆ©æœŸæ¨¡æ‹Ÿå™¨å®‰å…¨æ—¥å¿—\n
			    ç”Ÿæˆæ—¶é—´: ${timeStamp}
			    ==================== MD5 & AES ====================
			    MD5æ ‡è¯†ç¬¦: ${currentMD5}
			    AESç¼–ç : ${currentAES}
			    =================== ç‰Œå †è¯¦ç»†ä¿¡æ¯ ===================
			    æ€»ç‰Œæ•°: ${deck.length}
			    å½“å‰ç‰Œå †é¡ºåº:
			    ${deckDetails}
			    ==================== ç³»ç»Ÿä¿¡æ¯ ======================
			    ç”¨æˆ·ç³»ç»Ÿ: ${navigator.userAgent}
			    `;
			}

			// æ˜¾ç¤ºå®‰å…¨è­¦å‘Šå¼¹çª—
			function showSecurityAlert() {
				// åˆ›å»ºè­¦å‘Šå¼¹çª—
				const alertBox = document.createElement('div');
				alertBox.className = 'security-alert';
				alertBox.innerHTML = `
			        <strong>å®‰å…¨æç¤º</strong>
			        <p>ç”±äºä¿éšœç”¨æˆ·ä¿¡æ¯å®‰å…¨ï¼Œè¯¥åŠŸèƒ½ä»…é™Windowsç³»ç»Ÿç”¨æˆ·ä½¿ç”¨ã€‚è¯¥åŠŸèƒ½ä¼šåœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ç”Ÿæˆä¸€ä¸ªåŒ…å«æœ¬æ¬¡ç‰Œå †çš„MD5ã€AESç¼–ç åŠç‰Œå †è¯¦ç»†ä¿¡æ¯çš„txtæ–‡ä»¶ã€‚</p>
			        <p>è¯·é—®æ˜¯å¦ç»§ç»­åˆ›å»ºï¼Ÿ</p>
			        <button class="confirm">æ˜¯ï¼Œç»§ç»­åˆ›å»º</button>
			        <button class="cancel">å¦ï¼Œå–æ¶ˆæ“ä½œ</button>
			    `;

				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const backdrop = document.createElement('div');
				backdrop.style = `
			        position: fixed;
			        top:0; left:0; right:0; bottom:0;
			        background: rgba(0,0,0,0.5);
			        display: flex;
			        align-items: center;
			        justify-content: center;
			        z-index: 9999;
			    `;

				// æ·»åŠ å¼¹çª—åˆ°èƒŒæ™¯
				backdrop.appendChild(alertBox);
				document.body.appendChild(backdrop);

				// è¿”å›Promiseå¤„ç†ç”¨æˆ·é€‰æ‹©
				return new Promise(resolve => {
					// ç¡®è®¤æŒ‰é’®ç‚¹å‡»å¤„ç†
					alertBox.querySelector('.confirm').onclick = () => {
						document.body.removeChild(backdrop);
						resolve(true);
					};

					// å–æ¶ˆæŒ‰é’®ç‚¹å‡»å¤„ç†
					alertBox.querySelector('.cancel').onclick = () => {
						document.body.removeChild(backdrop);
						resolve(false);
					};
				});
			}

			// ç»‘å®šæ—¥å¿—å¯¼å‡ºæŒ‰é’®äº‹ä»¶
			document.getElementById('exportLog').addEventListener('click', async () => {
				// æ£€æŸ¥æ“ä½œç³»ç»Ÿ
				if (!isWindowsOS()) {
					alert('å½“å‰åŠŸèƒ½ä»…é™Windowsç³»ç»Ÿç”¨æˆ·ä½¿ç”¨');
					return;
				}

				// æ˜¾ç¤ºå®‰å…¨è­¦å‘Šå¹¶ç­‰å¾…ç”¨æˆ·ç¡®è®¤
				const userConfirm = await showSecurityAlert();
				if (!userConfirm) {
					log('ç”¨æˆ·å–æ¶ˆäº†æ—¥å¿—ç”Ÿæˆ');
					return;
				}

				try {
					// ç”Ÿæˆæ—¥å¿—å†…å®¹
					const content = generateSecurityLog();

					// åˆ›å»ºBlobå¯¹è±¡
					const blob = new Blob([content], {
						type: 'text/plain;charset=utf-8'
					});

					// åˆ›å»ºä¸‹è½½é“¾æ¥
					const downloadLink = document.createElement('a');
					downloadLink.href = URL.createObjectURL(blob);
					downloadLink.download = `PileLog_${Date.now()}.txt`; // å”¯ä¸€æ–‡ä»¶å

					// æ·»åŠ é“¾æ¥åˆ°DOMå¹¶æ¨¡æ‹Ÿç‚¹å‡»
					document.body.appendChild(downloadLink);
					downloadLink.click();

					// æ¸…ç†DOM
					document.body.removeChild(downloadLink);

					// è®°å½•æ—¥å¿—
					log('å®‰å…¨æ—¥å¿—æ–‡ä»¶å·²ç”Ÿæˆ');
				} catch (error) {
					// é”™è¯¯å¤„ç†
					console.error('å¯¼å‡ºå¤±è´¥:', error);
					log('å®‰å…¨æ—¥å¿—ç”Ÿæˆå¤±è´¥');
				}
			});

			// è®°å½•æ“ä½œæ—¥å¿—
			function log(message) {
				// è·å–æ—¥å¿—å®¹å™¨å…ƒç´ 
				const logDiv = document.getElementById('log');
				const container = document.getElementById('log-container');

				// åˆ›å»ºæ–°æ—¥å¿—æ¡ç›®
				const newEntry = document.createElement('p');

				// è®¾ç½®æ—¥å¿—å†…å®¹ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
				newEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

				// æ·»åŠ åˆ°æ—¥å¿—å®¹å™¨
				logDiv.appendChild(newEntry);

				// æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ˆæœ€æ–°æ—¥å¿—ï¼‰
				container.scrollTop = 0;
			}

			// è®°ç‰Œå™¨æŠ˜å /å±•å¼€çŠ¶æ€
			let isCollapsed = false;

			// ç»‘å®šè®°ç‰Œå™¨æŠ˜å æŒ‰é’®äº‹ä»¶
			document.getElementById('toggleCounter').addEventListener('click', () => {
				// è·å–è®°ç‰Œå™¨å…ƒç´ å’ŒæŒ‰é’®
				const counter = document.getElementById('remaining-counts');
				const btn = document.getElementById('toggleCounter');

				// åˆ‡æ¢æŠ˜å çŠ¶æ€
				isCollapsed = !isCollapsed;

				// åˆ‡æ¢CSSç±»
				counter.classList.toggle('collapsed');

				// æ›´æ–°æŒ‰é’®æ–‡æœ¬
				btn.innerHTML = isCollapsed ? 'â–¶ å±•å¼€' : 'â–¼ æ”¶èµ·';
			});

			// é€šç”¨æŠ˜å /å±•å¼€å‡½æ•°
			function toggleSection(sectionId, button, isCollapsedFlag) {
				// è·å–ç›®æ ‡å…ƒç´ 
				const section = document.getElementById(sectionId);

				// åˆ‡æ¢çŠ¶æ€
				isCollapsedFlag = !isCollapsedFlag;

				// åˆ‡æ¢CSSç±»
				section.classList.toggle('collapsed');

				// æ›´æ–°æŒ‰é’®æ–‡æœ¬
				button.innerHTML = isCollapsedFlag ? 'â–¶ å±•å¼€' : 'â–¼ æ”¶èµ·';

				// è¿”å›æ–°çŠ¶æ€
				return isCollapsedFlag;
			}

			// çŠ¶æ€ä¿¡æ¯åŒºæ”¶èµ·/å±•å¼€æ§åˆ¶
			let isStatusAreaCollapsed = false;

			document.getElementById('toggleStatusArea').addEventListener('click', () => {
				const statusArea = document.getElementById('status-area');
				const btn = document.getElementById('toggleStatusArea');

				isStatusAreaCollapsed = !isStatusAreaCollapsed;

				if (isStatusAreaCollapsed) {
					statusArea.classList.add('collapsed');
					btn.innerHTML = 'â–¶ å±•å¼€';
				} else {
					statusArea.classList.remove('collapsed');
					btn.innerHTML = 'â–¼ æ”¶èµ·';
				}
			});


			// ç»‘å®šå®‰å…¨æ ¡éªŒåŒºæŠ˜å æŒ‰é’®äº‹ä»¶
			document.getElementById('toggleMD5AES').addEventListener('click', () => {
				// ä½¿ç”¨é€šç”¨å‡½æ•°åˆ‡æ¢MD5/AESåŒºåŸŸ
				isMD5AESCollapsed = toggleSection(
					'md5aes-container',
					document.getElementById('toggleMD5AES'),
					isMD5AESCollapsed
				);
			});

			// é”®ç›˜å¿«æ·é”®å¤„ç†
			function handleKeyPress(event) {
				// å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ï¼Œåˆ™å¿½ç•¥
				if (document.activeElement.tagName === 'INPUT') return;

				// è·å–æŒ‰é’®çŠ¶æ€
				const reshuffleDisabled = document.getElementById('reshuffleBtn').disabled;
				const playBtnDisabled = document.getElementById('playBtn').disabled;
				const endPlayDisabled = document.getElementById('endPlayBtn').disabled;

				// å¤„ç†å¿«æ·é”®
				switch (event.key.toUpperCase()) {
					case 'Q': // å¼ºåˆ¶åˆ·æ–°
						if (confirm("ç¡®å®šè¦å¼ºåˆ¶åˆ·æ–°é¡µé¢å—ï¼Ÿ")) {
							location.reload(true);
						}
						break;
					case '1': // å‘1å¼ ç‰Œ
						drawCards(1);
						break;
					case '2': // å‘2å¼ ç‰Œ
						drawCards(2);
						break;
					case '3': // å‘3å¼ ç‰Œ
						drawCards(3);
						break;
					case '4': // å‘4å¼ ç‰Œ
						drawCards(4);
						break;
					case 'W': // æŸ¥çœ‹å‰©ä½™ç‰Œå †
						revealDeck();
						break;
					case 'E': // é«˜äº®è¯¸è‘›è¿å¼©
						highlightZhugeLianNu();
						break;
					case 'R': // é‡æ–°æ´—ç‰Œ
						initializeDeck();
						log("å¿«æ·é”®æ´—ç‰Œ");
						break;

					case 'A': // è¿›å…¥æ‘¸ç‰Œé˜¶æ®µ
						if (phase === 'å‡†å¤‡') drawPhase();
						break;
					case 'S': // è¿›å…¥å‡ºç‰Œé˜¶æ®µ
						if (!playBtnDisabled) playPhase();
						break;
					case 'D': // ç»“æŸå‡ºç‰Œé˜¶æ®µ
						if (!endPlayDisabled) endPlayPhase();
						break;
				}

				// é˜»æ­¢è¿™äº›é”®çš„é»˜è®¤è¡Œä¸º
				if ('QWEASDTR1234'.includes(event.key.toUpperCase())) {
					event.preventDefault();
				}
			}

			// è·å–å¡ç‰Œåˆ†ç±»
			function getCardCategory(cardName) {
				// éå†å¤–éƒ¨å®šä¹‰çš„å¡ç‰Œåˆ†ç±»
				for (const category in cardCategories) {
					// æ£€æŸ¥å¡ç‰Œæ˜¯å¦å±äºæ­¤åˆ†ç±»
					if (cardCategories[category].includes(cardName)) {
						return category;
					}
				}
				// æœªæ‰¾åˆ°åˆ†ç±»
				return "unknown";
			}

			// æ˜¾ç¤ºå¡ç‰Œé€‰æ‹©å™¨å¯¹è¯æ¡†
			function showCardSelector() {
				// åˆ›å»ºæ¨¡æ€èƒŒæ™¯
				const backdrop = document.createElement('div');
				backdrop.className = 'modal-backdrop';

				// åˆ›å»ºå¯¹è¯æ¡†
				const modal = document.createElement('div');
				modal.className = 'card-selector-modal';
				modal.innerHTML = `
					<h3>é€‰æ‹©è¦æ·»åŠ çš„å¡ç‰Œç±»å‹</h3>
					<div id="cardButtons"></div>
					<button onclick="this.parentElement.parentElement.remove()" 
							style="margin-top:15px; padding:8px 20px;">
						å…³é—­
					</button>
				`;

				// è·å–æŒ‰é’®å®¹å™¨
				const buttonsContainer = modal.querySelector('#cardButtons');

				// è·å–æ‰€æœ‰å¡ç‰Œç±»å‹
				const types = getAllCardTypes();

				// ä¸ºæ¯ç§å¡ç‰Œç±»å‹åˆ›å»ºæŒ‰é’®
				types.forEach(type => {
					const btn = document.createElement('button');
					btn.className = 'card-button';
					btn.textContent = type;
					btn.onclick = () => {
						// æ·»åŠ é€‰æ‹©çš„å¡ç‰Œç±»å‹
						addSpecificCard(type);
						// å…³é—­å¯¹è¯æ¡†
						backdrop.remove();
					};
					buttonsContainer.appendChild(btn);
				});

				// æ·»åŠ å¯¹è¯æ¡†åˆ°èƒŒæ™¯
				backdrop.appendChild(modal);
				// æ·»åŠ åˆ°æ–‡æ¡£
				document.body.appendChild(backdrop);

				// ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
				backdrop.onclick = (e) => {
					if (e.target === backdrop) {
						backdrop.remove();
					}
				};
			}

			// ç»‘å®šæµ‹è¯•æŒ‰é’®äº‹ä»¶
			document.getElementById('testCardBtn').addEventListener('click', showCardSelector);

			// è·å–æ‰€æœ‰å¡ç‰Œç±»å‹
			function getAllCardTypes() {
				// ä½¿ç”¨Setå»é‡
				const typeSet = new Set();

				// éå†æ ‡å‡†ç‰Œå †
				standardDeck.forEach(card => {
					// åªæ·»åŠ ç‰Œå †ä¸­å­˜åœ¨çš„å¡ç‰Œç±»å‹
					if (deck.some(c => c.name === card.name)) {
						typeSet.add(card.name);
					}
				});

				// è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆä¸­æ–‡æ’åºï¼‰
				return Array.from(typeSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
			}

			// æ·»åŠ ç‰¹å®šå¡ç‰Œåˆ°æ‰‹ç‰Œ
			function addSpecificCard(cardName) {
				// åœ¨ç‰Œå †ä¸­æŸ¥æ‰¾è¯¥ç±»å‹å¡ç‰Œ
				const availableCards = deck.filter(c => c.name === cardName);

				// æ£€æŸ¥æ˜¯å¦å­˜åœ¨
				if (availableCards.length === 0) {
					alert(`ç‰Œå †ä¸­æ²¡æœ‰ã€${cardName}ã€‘ï¼`);
					log(`å°è¯•æ·»åŠ ${cardName}å¤±è´¥ï¼ˆç‰Œå †æ— æ­¤å¡ï¼‰`);
					return;
				}

				// ä½¿ç”¨åŠ å¯†éšæœºæ•°é€‰æ‹©ä¸€å¼ ç‰Œ
				const randomBuffer = new Uint32Array(1);
				window.crypto.getRandomValues(randomBuffer);
				const selectedIndex = randomBuffer[0] % availableCards.length;
				const selectedCard = availableCards[selectedIndex];

				// åœ¨ç‰Œå †ä¸­æŸ¥æ‰¾è¯¥ç‰Œçš„ä½ç½®
				const deckIndex = deck.findIndex(c => c.uid === selectedCard.uid);

				// å¦‚æœæ‰¾åˆ°åˆ™ç§»åŠ¨è¯¥ç‰Œ
				if (deckIndex > -1) {
					// ä»ç‰Œå †ç§»é™¤
					const [removed] = deck.splice(deckIndex, 1);

					// æ·»åŠ åˆ°æ‰‹ç‰Œ
					hand.push(removed);

					// è®°å½•æ—¥å¿—
					log(`æ‰‹åŠ¨æ·»åŠ å¡ç‰Œï¼š${removed.name} ${removed.suit}${getPointDisplay(removed.point)}`);

					// æ›´æ–°ç•Œé¢
					updateUI();
					updateRemaining();

					// é‡æ–°ç”ŸæˆMD5ï¼ˆç‰Œå †å·²æ”¹å˜ï¼‰
					generateDeckMD5();

					// æ˜¾ç¤ºæ“ä½œæˆåŠŸåé¦ˆ
					const feedback = document.createElement('div');
					feedback.textContent = `å·²æ·»åŠ ï¼š${removed.name}`;
					feedback.style = `
						position:fixed; 
						top:20px; 
						left:50%; 
						transform:translateX(-50%); 
						padding:10px; 
						background:#4CAF50; 
						color:white;
						z-index:10000;
					`;
					document.body.appendChild(feedback);

					// 2ç§’åç§»é™¤åé¦ˆ
					setTimeout(() => feedback.remove(), 2000);
				}
			}

			// æ›´æ–°æç¤ºæ¡†ä½ç½®ï¼ˆé˜²æ­¢è¶…å‡ºå±å¹•ï¼‰
			function updateTooltipAlignment() {
				// è·å–æ‰€æœ‰æç¤ºå®¹å™¨
				const tooltipContainers = document.querySelectorAll('.tooltip-container');

				// éå†æ¯ä¸ªå®¹å™¨
				tooltipContainers.forEach(container => {
					const button = container.querySelector('button');
					const tooltip = container.querySelector('.tooltip');

					// ç¡®ä¿å…ƒç´ å­˜åœ¨
					if (button && tooltip) {
						// è·å–æŒ‰é’®ä½ç½®ä¿¡æ¯
						const rect = button.getBoundingClientRect();
						const viewportWidth = window.innerWidth;
						const tooltipWidth = tooltip.offsetWidth || 350; // é»˜è®¤å®½åº¦

						// è®¡ç®—å·¦å³å¯ç”¨ç©ºé—´
						const leftSpace = rect.left;
						const rightSpace = viewportWidth - rect.right;

						// æ ¹æ®ç©ºé—´å†³å®šæç¤ºæ¡†ä½ç½®
						if (rightSpace >= tooltipWidth) {
							// å³ä¾§ç©ºé—´è¶³å¤Ÿ
							container.classList.remove('right-align');
						} else if (leftSpace >= tooltipWidth) {
							// å·¦ä¾§ç©ºé—´è¶³å¤Ÿ
							container.classList.add('right-align');
						} else {
							// ç©ºé—´ä¸è¶³æ—¶é€‰æ‹©ç©ºé—´è¾ƒå¤§çš„ä¸€ä¾§
							if (rightSpace > leftSpace) {
								container.classList.remove('right-align');
							} else {
								container.classList.add('right-align');
							}
						}
					}
				});
			}

			// æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ç¡®ä¿æç¤ºæ¡†ä½ç½®æ­£ç¡®
			window.addEventListener('load', () => {
				// å»¶è¿Ÿ100msç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
				setTimeout(updateTooltipAlignment, 100);
			});
			window.addEventListener('resize', updateTooltipAlignment); // çª—å£å¤§å°å˜åŒ–æ—¶æ›´æ–°
			window.addEventListener('scroll', updateTooltipAlignment); // æ»šåŠ¨æ—¶æ›´æ–°
			document.querySelectorAll('.tooltip-container').forEach(container => {
				// é¼ æ ‡æ‚¬åœæ—¶æ›´æ–°
				container.addEventListener('mouseenter', updateTooltipAlignment);
			});

			// åˆå§‹åŒ–æ¸¸æˆ
			function initializeGame() {
				// åˆå§‹åŒ–ç‰Œå †
				initializeDeck();

				// åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
				initializeButtons();

				// ç»‘å®šä¸ˆå…«è›‡çŸ›æŒ‰é’®äº‹ä»¶
				document.getElementById('zhangbaBtn').addEventListener('click', showZhangbaDialog);

				// åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
				updateWeaponButton();

				// ç»‘å®šé”®ç›˜äº‹ä»¶
				document.addEventListener('keydown', handleKeyPress);

				// æ ¹æ®å¼€å‘æ¨¡å¼æ˜¾ç¤º/éšè—æµ‹è¯•æŒ‰é’®
				const isDevMode = true; // åœ¨å®é™…åº”ç”¨ä¸­åº”ä»é…ç½®è·å–
			}

			// ç»‘å®šæŠ½ç‰ŒæŒ‰é’®äº‹ä»¶
			document.getElementById('draw1Button').addEventListener('click', () => drawCards(1));
			document.getElementById('draw2Button').addEventListener('click', () => drawCards(2));
			document.getElementById('draw3Button').addEventListener('click', () => drawCards(3));
			document.getElementById('draw4Button').addEventListener('click', () => drawCards(4));

			// ç»‘å®šç‰Œå †æ“ä½œæŒ‰é’®äº‹ä»¶
			document.getElementById('revealButton').addEventListener('click', revealDeck);
			document.getElementById('highlightButton').addEventListener('click', highlightZhugeLianNu);

			// æ´—ç‰ŒæŒ‰é’®
			document.getElementById('shuffleButton').addEventListener('click', () => {
				initializeDeck(); // é‡æ–°åˆå§‹åŒ–ç‰Œå †
				log("ç”¨æˆ·ç‚¹å‡»äº†é‡æ–°æ´—ç‰ŒæŒ‰é’®");
			});

			// æ¸¸æˆé˜¶æ®µæŒ‰é’®
			document.getElementById('drawBtn').addEventListener('click', drawPhase);
			document.getElementById('playBtn').addEventListener('click', playPhase);
			document.getElementById('endPlayBtn').addEventListener('click', endPlayPhase);

			// å¼ºåˆ¶åˆ·æ–°æŒ‰é’®
			document.getElementById('reloadButton').addEventListener('click', () => {
				if (confirm("ç¡®å®šè¦å¼ºåˆ¶åˆ·æ–°é¡µé¢å—ï¼Ÿç½‘é¡µå°†å›åˆ°åˆå§‹é¡µé¢")) {
					location.reload(true);
				}
			});

			// å¯åŠ¨æ¸¸æˆ
			initializeGame();

			// è·å–æŒ‰é’®
			const backToTopBtn = document.getElementById('backToTopBtn');

			// æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼Œæ§åˆ¶æŒ‰é’®æ˜¾ç¤ºéšè—
			window.addEventListener('scroll', () => {
				if (window.scrollY > 200) { // å½“æ»šåŠ¨è·ç¦»å¤§äº200æ—¶æ˜¾ç¤ºæŒ‰é’®
					backToTopBtn.style.display = 'block';
				} else {
					backToTopBtn.style.display = 'none';
				}
			});

			// ç‚¹å‡»æŒ‰é’®å›åˆ°é¡¶éƒ¨
			backToTopBtn.addEventListener('click', () => {
				window.scrollTo({
					top: 0,
					behavior: 'smooth' // å¹³æ»‘æ»šåŠ¨
				});
			});
		</script>
		<footer class="site-footer">
			<div class="author-info">
				<p>
					ä½œè€…ï¼š <a href="https://space.bilibili.com/87412647?spm_id_from=333.1007.0.0"
						target="_blank">bilibiliæœˆãŒç¶ºéº—ã§ã™ã­_</a><br />
					è”ç³»æ–¹å¼ï¼š<a href="mailto:3099637681@qq.com" target="_blank">3099637681@qq.comï¼ˆQQåŒå·ï¼‰</a><br />
					æœ‰ä»€ä¹ˆæ–°åŠŸèƒ½æˆ–å»ºè®®æ¬¢è¿éªšæ‰°ï¼ˆè‘—åæ¥æ„ï¼‰<br />
					<a href="https://1145141919810tonny.github.io/sgsmoniqi/" target="_blank">ç‚¹å‡»æ­¤å¤„ä½¿ç”¨GitHub Pagesåœ¨çº¿æœåŠ¡</a>
				</p>
			</div>
			<div class="code-update">
				<a href="https://www.bilibili.com/read/readlist/rl929858?spm_id_from=333.1387.0.0" target="_blank"
					class="bili-btn" rel="noopener noreferrer">
					[bilibili]è·å–æ›´æ–°åŠ¨æ€
				</a>
				<a href="https://github.com/1145141919810TONNY/sgsmoniqi/" target="_blank" class="github-btn"
					rel="noopener noreferrer">
					[GitHub]è·å–åç»­ä»£ç æ›´æ–°
				</a>
				<a href="https://gitcode.com/TONNY114514/sgsmnq?source_module=search_project" target="_blank"
					class="gitcode-btn" rel="noopener noreferrer">
					[GitCode]è·å–V7.8.3.62é•œåƒæ–‡ä»¶
				</a>
			</div>
			<div class="license-notice">
				<p>
					Copyright &copy; <span id="copyright-year">2025</span> bilibili æœˆãŒç¶ºéº—ã§ã™ã­_<br />
					Released under the
					<a href="MIT LICENSE.html" title="æŸ¥çœ‹MITè®¸å¯è¯" class="license-link" target="_blank">
						MIT License
					</a>
				</p>
				<p class="i18n-annotation">
					(æ³•å¾‹æ¡æ¬¾ä»¥è‹±æ–‡ç‰ˆ<a href="MIT LICENSE.html" target="_blank">LICENSE</a>æ–‡ä»¶ä¸ºå‡†)
				</p>
			</div>
		</footer>
	</body>
</html>
